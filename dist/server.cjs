"use strict";var Li=Object.create;var Ur=Object.defineProperty;var Ui=Object.getOwnPropertyDescriptor;var Ti=Object.getOwnPropertyNames;var Ni=Object.getPrototypeOf,_i=Object.prototype.hasOwnProperty;var Tr=(e,r)=>()=>(e&&(r=e(e=0)),r);var M=(e,r)=>()=>(r||e((r={exports:{}}).exports,r),r.exports),Pt=(e,r)=>{for(var t in r)Ur(e,t,{get:r[t],enumerable:!0})},Di=(e,r,t,o)=>{if(r&&typeof r=="object"||typeof r=="function")for(let s of Ti(r))!_i.call(e,s)&&s!==t&&Ur(e,s,{get:()=>r[s],enumerable:!(o=Ui(r,s))||o.enumerable});return e};var P=(e,r,t)=>(t=e!=null?Li(Ni(e)):{},Di(r||!e||!e.__esModule?Ur(t,"default",{value:e,enumerable:!0}):t,e));var ia=M((oS,aa)=>{"use strict";var ul=/[|\\{}()[\]^$+*?.]/g;aa.exports=function(e){if(typeof e!="string")throw new TypeError("Expected a string");return e.replace(ul,"\\$&")}});var la=M((sS,ca)=>{"use strict";ca.exports={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]}});var nt=M((nS,ma)=>{var oe=la(),ua={};for(dr in oe)oe.hasOwnProperty(dr)&&(ua[oe[dr]]=dr);var dr,w=ma.exports={rgb:{channels:3,labels:"rgb"},hsl:{channels:3,labels:"hsl"},hsv:{channels:3,labels:"hsv"},hwb:{channels:3,labels:"hwb"},cmyk:{channels:4,labels:"cmyk"},xyz:{channels:3,labels:"xyz"},lab:{channels:3,labels:"lab"},lch:{channels:3,labels:"lch"},hex:{channels:1,labels:["hex"]},keyword:{channels:1,labels:["keyword"]},ansi16:{channels:1,labels:["ansi16"]},ansi256:{channels:1,labels:["ansi256"]},hcg:{channels:3,labels:["h","c","g"]},apple:{channels:3,labels:["r16","g16","b16"]},gray:{channels:1,labels:["gray"]}};for(N in w)if(w.hasOwnProperty(N)){if(!("channels"in w[N]))throw new Error("missing channels property: "+N);if(!("labels"in w[N]))throw new Error("missing channel labels property: "+N);if(w[N].labels.length!==w[N].channels)throw new Error("channel and label counts mismatch: "+N);da=w[N].channels,pa=w[N].labels,delete w[N].channels,delete w[N].labels,Object.defineProperty(w[N],"channels",{value:da}),Object.defineProperty(w[N],"labels",{value:pa})}var da,pa,N;w.rgb.hsl=function(e){var r=e[0]/255,t=e[1]/255,o=e[2]/255,s=Math.min(r,t,o),n=Math.max(r,t,o),a=n-s,i,c,l;return n===s?i=0:r===n?i=(t-o)/a:t===n?i=2+(o-r)/a:o===n&&(i=4+(r-t)/a),i=Math.min(i*60,360),i<0&&(i+=360),l=(s+n)/2,n===s?c=0:l<=.5?c=a/(n+s):c=a/(2-n-s),[i,c*100,l*100]};w.rgb.hsv=function(e){var r,t,o,s,n,a=e[0]/255,i=e[1]/255,c=e[2]/255,l=Math.max(a,i,c),d=l-Math.min(a,i,c),u=function(m){return(l-m)/6/d+1/2};return d===0?s=n=0:(n=d/l,r=u(a),t=u(i),o=u(c),a===l?s=o-t:i===l?s=1/3+r-o:c===l&&(s=2/3+t-r),s<0?s+=1:s>1&&(s-=1)),[s*360,n*100,l*100]};w.rgb.hwb=function(e){var r=e[0],t=e[1],o=e[2],s=w.rgb.hsl(e)[0],n=1/255*Math.min(r,Math.min(t,o));return o=1-1/255*Math.max(r,Math.max(t,o)),[s,n*100,o*100]};w.rgb.cmyk=function(e){var r=e[0]/255,t=e[1]/255,o=e[2]/255,s,n,a,i;return i=Math.min(1-r,1-t,1-o),s=(1-r-i)/(1-i)||0,n=(1-t-i)/(1-i)||0,a=(1-o-i)/(1-i)||0,[s*100,n*100,a*100,i*100]};function ml(e,r){return Math.pow(e[0]-r[0],2)+Math.pow(e[1]-r[1],2)+Math.pow(e[2]-r[2],2)}w.rgb.keyword=function(e){var r=ua[e];if(r)return r;var t=1/0,o;for(var s in oe)if(oe.hasOwnProperty(s)){var n=oe[s],a=ml(e,n);a<t&&(t=a,o=s)}return o};w.keyword.rgb=function(e){return oe[e]};w.rgb.xyz=function(e){var r=e[0]/255,t=e[1]/255,o=e[2]/255;r=r>.04045?Math.pow((r+.055)/1.055,2.4):r/12.92,t=t>.04045?Math.pow((t+.055)/1.055,2.4):t/12.92,o=o>.04045?Math.pow((o+.055)/1.055,2.4):o/12.92;var s=r*.4124+t*.3576+o*.1805,n=r*.2126+t*.7152+o*.0722,a=r*.0193+t*.1192+o*.9505;return[s*100,n*100,a*100]};w.rgb.lab=function(e){var r=w.rgb.xyz(e),t=r[0],o=r[1],s=r[2],n,a,i;return t/=95.047,o/=100,s/=108.883,t=t>.008856?Math.pow(t,1/3):7.787*t+16/116,o=o>.008856?Math.pow(o,1/3):7.787*o+16/116,s=s>.008856?Math.pow(s,1/3):7.787*s+16/116,n=116*o-16,a=500*(t-o),i=200*(o-s),[n,a,i]};w.hsl.rgb=function(e){var r=e[0]/360,t=e[1]/100,o=e[2]/100,s,n,a,i,c;if(t===0)return c=o*255,[c,c,c];o<.5?n=o*(1+t):n=o+t-o*t,s=2*o-n,i=[0,0,0];for(var l=0;l<3;l++)a=r+1/3*-(l-1),a<0&&a++,a>1&&a--,6*a<1?c=s+(n-s)*6*a:2*a<1?c=n:3*a<2?c=s+(n-s)*(2/3-a)*6:c=s,i[l]=c*255;return i};w.hsl.hsv=function(e){var r=e[0],t=e[1]/100,o=e[2]/100,s=t,n=Math.max(o,.01),a,i;return o*=2,t*=o<=1?o:2-o,s*=n<=1?n:2-n,i=(o+t)/2,a=o===0?2*s/(n+s):2*t/(o+t),[r,a*100,i*100]};w.hsv.rgb=function(e){var r=e[0]/60,t=e[1]/100,o=e[2]/100,s=Math.floor(r)%6,n=r-Math.floor(r),a=255*o*(1-t),i=255*o*(1-t*n),c=255*o*(1-t*(1-n));switch(o*=255,s){case 0:return[o,c,a];case 1:return[i,o,a];case 2:return[a,o,c];case 3:return[a,i,o];case 4:return[c,a,o];case 5:return[o,a,i]}};w.hsv.hsl=function(e){var r=e[0],t=e[1]/100,o=e[2]/100,s=Math.max(o,.01),n,a,i;return i=(2-t)*o,n=(2-t)*s,a=t*s,a/=n<=1?n:2-n,a=a||0,i/=2,[r,a*100,i*100]};w.hwb.rgb=function(e){var r=e[0]/360,t=e[1]/100,o=e[2]/100,s=t+o,n,a,i,c;s>1&&(t/=s,o/=s),n=Math.floor(6*r),a=1-o,i=6*r-n,(n&1)!==0&&(i=1-i),c=t+i*(a-t);var l,d,u;switch(n){default:case 6:case 0:l=a,d=c,u=t;break;case 1:l=c,d=a,u=t;break;case 2:l=t,d=a,u=c;break;case 3:l=t,d=c,u=a;break;case 4:l=c,d=t,u=a;break;case 5:l=a,d=t,u=c;break}return[l*255,d*255,u*255]};w.cmyk.rgb=function(e){var r=e[0]/100,t=e[1]/100,o=e[2]/100,s=e[3]/100,n,a,i;return n=1-Math.min(1,r*(1-s)+s),a=1-Math.min(1,t*(1-s)+s),i=1-Math.min(1,o*(1-s)+s),[n*255,a*255,i*255]};w.xyz.rgb=function(e){var r=e[0]/100,t=e[1]/100,o=e[2]/100,s,n,a;return s=r*3.2406+t*-1.5372+o*-.4986,n=r*-.9689+t*1.8758+o*.0415,a=r*.0557+t*-.204+o*1.057,s=s>.0031308?1.055*Math.pow(s,1/2.4)-.055:s*12.92,n=n>.0031308?1.055*Math.pow(n,1/2.4)-.055:n*12.92,a=a>.0031308?1.055*Math.pow(a,1/2.4)-.055:a*12.92,s=Math.min(Math.max(0,s),1),n=Math.min(Math.max(0,n),1),a=Math.min(Math.max(0,a),1),[s*255,n*255,a*255]};w.xyz.lab=function(e){var r=e[0],t=e[1],o=e[2],s,n,a;return r/=95.047,t/=100,o/=108.883,r=r>.008856?Math.pow(r,1/3):7.787*r+16/116,t=t>.008856?Math.pow(t,1/3):7.787*t+16/116,o=o>.008856?Math.pow(o,1/3):7.787*o+16/116,s=116*t-16,n=500*(r-t),a=200*(t-o),[s,n,a]};w.lab.xyz=function(e){var r=e[0],t=e[1],o=e[2],s,n,a;n=(r+16)/116,s=t/500+n,a=n-o/200;var i=Math.pow(n,3),c=Math.pow(s,3),l=Math.pow(a,3);return n=i>.008856?i:(n-16/116)/7.787,s=c>.008856?c:(s-16/116)/7.787,a=l>.008856?l:(a-16/116)/7.787,s*=95.047,n*=100,a*=108.883,[s,n,a]};w.lab.lch=function(e){var r=e[0],t=e[1],o=e[2],s,n,a;return s=Math.atan2(o,t),n=s*360/2/Math.PI,n<0&&(n+=360),a=Math.sqrt(t*t+o*o),[r,a,n]};w.lch.lab=function(e){var r=e[0],t=e[1],o=e[2],s,n,a;return a=o/360*2*Math.PI,s=t*Math.cos(a),n=t*Math.sin(a),[r,s,n]};w.rgb.ansi16=function(e){var r=e[0],t=e[1],o=e[2],s=1 in arguments?arguments[1]:w.rgb.hsv(e)[2];if(s=Math.round(s/50),s===0)return 30;var n=30+(Math.round(o/255)<<2|Math.round(t/255)<<1|Math.round(r/255));return s===2&&(n+=60),n};w.hsv.ansi16=function(e){return w.rgb.ansi16(w.hsv.rgb(e),e[2])};w.rgb.ansi256=function(e){var r=e[0],t=e[1],o=e[2];if(r===t&&t===o)return r<8?16:r>248?231:Math.round((r-8)/247*24)+232;var s=16+36*Math.round(r/255*5)+6*Math.round(t/255*5)+Math.round(o/255*5);return s};w.ansi16.rgb=function(e){var r=e%10;if(r===0||r===7)return e>50&&(r+=3.5),r=r/10.5*255,[r,r,r];var t=(~~(e>50)+1)*.5,o=(r&1)*t*255,s=(r>>1&1)*t*255,n=(r>>2&1)*t*255;return[o,s,n]};w.ansi256.rgb=function(e){if(e>=232){var r=(e-232)*10+8;return[r,r,r]}e-=16;var t,o=Math.floor(e/36)/5*255,s=Math.floor((t=e%36)/6)/5*255,n=t%6/5*255;return[o,s,n]};w.rgb.hex=function(e){var r=((Math.round(e[0])&255)<<16)+((Math.round(e[1])&255)<<8)+(Math.round(e[2])&255),t=r.toString(16).toUpperCase();return"000000".substring(t.length)+t};w.hex.rgb=function(e){var r=e.toString(16).match(/[a-f0-9]{6}|[a-f0-9]{3}/i);if(!r)return[0,0,0];var t=r[0];r[0].length===3&&(t=t.split("").map(function(i){return i+i}).join(""));var o=parseInt(t,16),s=o>>16&255,n=o>>8&255,a=o&255;return[s,n,a]};w.rgb.hcg=function(e){var r=e[0]/255,t=e[1]/255,o=e[2]/255,s=Math.max(Math.max(r,t),o),n=Math.min(Math.min(r,t),o),a=s-n,i,c;return a<1?i=n/(1-a):i=0,a<=0?c=0:s===r?c=(t-o)/a%6:s===t?c=2+(o-r)/a:c=4+(r-t)/a+4,c/=6,c%=1,[c*360,a*100,i*100]};w.hsl.hcg=function(e){var r=e[1]/100,t=e[2]/100,o=1,s=0;return t<.5?o=2*r*t:o=2*r*(1-t),o<1&&(s=(t-.5*o)/(1-o)),[e[0],o*100,s*100]};w.hsv.hcg=function(e){var r=e[1]/100,t=e[2]/100,o=r*t,s=0;return o<1&&(s=(t-o)/(1-o)),[e[0],o*100,s*100]};w.hcg.rgb=function(e){var r=e[0]/360,t=e[1]/100,o=e[2]/100;if(t===0)return[o*255,o*255,o*255];var s=[0,0,0],n=r%1*6,a=n%1,i=1-a,c=0;switch(Math.floor(n)){case 0:s[0]=1,s[1]=a,s[2]=0;break;case 1:s[0]=i,s[1]=1,s[2]=0;break;case 2:s[0]=0,s[1]=1,s[2]=a;break;case 3:s[0]=0,s[1]=i,s[2]=1;break;case 4:s[0]=a,s[1]=0,s[2]=1;break;default:s[0]=1,s[1]=0,s[2]=i}return c=(1-t)*o,[(t*s[0]+c)*255,(t*s[1]+c)*255,(t*s[2]+c)*255]};w.hcg.hsv=function(e){var r=e[1]/100,t=e[2]/100,o=r+t*(1-r),s=0;return o>0&&(s=r/o),[e[0],s*100,o*100]};w.hcg.hsl=function(e){var r=e[1]/100,t=e[2]/100,o=t*(1-r)+.5*r,s=0;return o>0&&o<.5?s=r/(2*o):o>=.5&&o<1&&(s=r/(2*(1-o))),[e[0],s*100,o*100]};w.hcg.hwb=function(e){var r=e[1]/100,t=e[2]/100,o=r+t*(1-r);return[e[0],(o-r)*100,(1-o)*100]};w.hwb.hcg=function(e){var r=e[1]/100,t=e[2]/100,o=1-t,s=o-r,n=0;return s<1&&(n=(o-s)/(1-s)),[e[0],s*100,n*100]};w.apple.rgb=function(e){return[e[0]/65535*255,e[1]/65535*255,e[2]/65535*255]};w.rgb.apple=function(e){return[e[0]/255*65535,e[1]/255*65535,e[2]/255*65535]};w.gray.rgb=function(e){return[e[0]/100*255,e[0]/100*255,e[0]/100*255]};w.gray.hsl=w.gray.hsv=function(e){return[0,0,e[0]]};w.gray.hwb=function(e){return[0,100,e[0]]};w.gray.cmyk=function(e){return[0,0,0,e[0]]};w.gray.lab=function(e){return[e[0],0,0]};w.gray.hex=function(e){var r=Math.round(e[0]/100*255)&255,t=(r<<16)+(r<<8)+r,o=t.toString(16).toUpperCase();return"000000".substring(o.length)+o};w.rgb.gray=function(e){var r=(e[0]+e[1]+e[2])/3;return[r/255*100]}});var ha=M((aS,fa)=>{var pr=nt();function fl(){for(var e={},r=Object.keys(pr),t=r.length,o=0;o<t;o++)e[r[o]]={distance:-1,parent:null};return e}function hl(e){var r=fl(),t=[e];for(r[e].distance=0;t.length;)for(var o=t.pop(),s=Object.keys(pr[o]),n=s.length,a=0;a<n;a++){var i=s[a],c=r[i];c.distance===-1&&(c.distance=r[o].distance+1,c.parent=o,t.unshift(i))}return r}function gl(e,r){return function(t){return r(e(t))}}function yl(e,r){for(var t=[r[e].parent,e],o=pr[r[e].parent][e],s=r[e].parent;r[s].parent;)t.unshift(r[s].parent),o=gl(pr[r[s].parent][s],o),s=r[s].parent;return o.conversion=t,o}fa.exports=function(e){for(var r=hl(e),t={},o=Object.keys(r),s=o.length,n=0;n<s;n++){var a=o[n],i=r[a];i.parent!==null&&(t[a]=yl(a,r))}return t}});var ya=M((iS,ga)=>{var at=nt(),bl=ha(),we={},Sl=Object.keys(at);function wl(e){var r=function(t){return t==null?t:(arguments.length>1&&(t=Array.prototype.slice.call(arguments)),e(t))};return"conversion"in e&&(r.conversion=e.conversion),r}function vl(e){var r=function(t){if(t==null)return t;arguments.length>1&&(t=Array.prototype.slice.call(arguments));var o=e(t);if(typeof o=="object")for(var s=o.length,n=0;n<s;n++)o[n]=Math.round(o[n]);return o};return"conversion"in e&&(r.conversion=e.conversion),r}Sl.forEach(function(e){we[e]={},Object.defineProperty(we[e],"channels",{value:at[e].channels}),Object.defineProperty(we[e],"labels",{value:at[e].labels});var r=bl(e),t=Object.keys(r);t.forEach(function(o){var s=r[o];we[e][o]=vl(s),we[e][o].raw=wl(s)})});ga.exports=we});var Sa=M((cS,ba)=>{"use strict";var ve=ya(),ur=(e,r)=>function(){return`\x1B[${e.apply(ve,arguments)+r}m`},mr=(e,r)=>function(){let t=e.apply(ve,arguments);return`\x1B[${38+r};5;${t}m`},fr=(e,r)=>function(){let t=e.apply(ve,arguments);return`\x1B[${38+r};2;${t[0]};${t[1]};${t[2]}m`};function El(){let e=new Map,r={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],gray:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};r.color.grey=r.color.gray;for(let s of Object.keys(r)){let n=r[s];for(let a of Object.keys(n)){let i=n[a];r[a]={open:`\x1B[${i[0]}m`,close:`\x1B[${i[1]}m`},n[a]=r[a],e.set(i[0],i[1])}Object.defineProperty(r,s,{value:n,enumerable:!1}),Object.defineProperty(r,"codes",{value:e,enumerable:!1})}let t=s=>s,o=(s,n,a)=>[s,n,a];r.color.close="\x1B[39m",r.bgColor.close="\x1B[49m",r.color.ansi={ansi:ur(t,0)},r.color.ansi256={ansi256:mr(t,0)},r.color.ansi16m={rgb:fr(o,0)},r.bgColor.ansi={ansi:ur(t,10)},r.bgColor.ansi256={ansi256:mr(t,10)},r.bgColor.ansi16m={rgb:fr(o,10)};for(let s of Object.keys(ve)){if(typeof ve[s]!="object")continue;let n=ve[s];s==="ansi16"&&(s="ansi"),"ansi16"in n&&(r.color.ansi[s]=ur(n.ansi16,0),r.bgColor.ansi[s]=ur(n.ansi16,10)),"ansi256"in n&&(r.color.ansi256[s]=mr(n.ansi256,0),r.bgColor.ansi256[s]=mr(n.ansi256,10)),"rgb"in n&&(r.color.ansi16m[s]=fr(n.rgb,0),r.bgColor.ansi16m[s]=fr(n.rgb,10))}return r}Object.defineProperty(ba,"exports",{enumerable:!0,get:El})});var va=M((lS,wa)=>{"use strict";wa.exports=(e,r)=>{r=r||process.argv;let t=e.startsWith("-")?"":e.length===1?"-":"--",o=r.indexOf(t+e),s=r.indexOf("--");return o!==-1&&(s===-1?!0:o<s)}});var ka=M((dS,Ea)=>{"use strict";var kl=require("os"),z=va(),T=process.env,Ee;z("no-color")||z("no-colors")||z("color=false")?Ee=!1:(z("color")||z("colors")||z("color=true")||z("color=always"))&&(Ee=!0);"FORCE_COLOR"in T&&(Ee=T.FORCE_COLOR.length===0||parseInt(T.FORCE_COLOR,10)!==0);function Cl(e){return e===0?!1:{level:e,hasBasic:!0,has256:e>=2,has16m:e>=3}}function xl(e){if(Ee===!1)return 0;if(z("color=16m")||z("color=full")||z("color=truecolor"))return 3;if(z("color=256"))return 2;if(e&&!e.isTTY&&Ee!==!0)return 0;let r=Ee?1:0;if(process.platform==="win32"){let t=kl.release().split(".");return Number(process.versions.node.split(".")[0])>=8&&Number(t[0])>=10&&Number(t[2])>=10586?Number(t[2])>=14931?3:2:1}if("CI"in T)return["TRAVIS","CIRCLECI","APPVEYOR","GITLAB_CI"].some(t=>t in T)||T.CI_NAME==="codeship"?1:r;if("TEAMCITY_VERSION"in T)return/^(9\.(0*[1-9]\d*)\.|\d{2,}\.)/.test(T.TEAMCITY_VERSION)?1:0;if(T.COLORTERM==="truecolor")return 3;if("TERM_PROGRAM"in T){let t=parseInt((T.TERM_PROGRAM_VERSION||"").split(".")[0],10);switch(T.TERM_PROGRAM){case"iTerm.app":return t>=3?3:2;case"Apple_Terminal":return 2}}return/-256(color)?$/i.test(T.TERM)?2:/^screen|^xterm|^vt100|^vt220|^rxvt|color|ansi|cygwin|linux/i.test(T.TERM)||"COLORTERM"in T?1:(T.TERM==="dumb",r)}function it(e){let r=xl(e);return Cl(r)}Ea.exports={supportsColor:it,stdout:it(process.stdout),stderr:it(process.stderr)}});var Ma=M((pS,Ra)=>{"use strict";var Ol=/(?:\\(u[a-f\d]{4}|x[a-f\d]{2}|.))|(?:\{(~)?(\w+(?:\([^)]*\))?(?:\.\w+(?:\([^)]*\))?)*)(?:[ \t]|(?=\r?\n)))|(\})|((?:.|[\r\n\f])+?)/gi,Ca=/(?:^|\.)(\w+)(?:\(([^)]*)\))?/g,Rl=/^(['"])((?:\\.|(?!\1)[^\\])*)\1$/,Ml=/\\(u[a-f\d]{4}|x[a-f\d]{2}|.)|([^\\])/gi,Il=new Map([["n",`
`],["r","\r"],["t","	"],["b","\b"],["f","\f"],["v","\v"],["0","\0"],["\\","\\"],["e","\x1B"],["a","\x07"]]);function Oa(e){return e[0]==="u"&&e.length===5||e[0]==="x"&&e.length===3?String.fromCharCode(parseInt(e.slice(1),16)):Il.get(e)||e}function $l(e,r){let t=[],o=r.trim().split(/\s*,\s*/g),s;for(let n of o)if(!isNaN(n))t.push(Number(n));else if(s=n.match(Rl))t.push(s[2].replace(Ml,(a,i,c)=>i?Oa(i):c));else throw new Error(`Invalid Chalk template style argument: ${n} (in style '${e}')`);return t}function Pl(e){Ca.lastIndex=0;let r=[],t;for(;(t=Ca.exec(e))!==null;){let o=t[1];if(t[2]){let s=$l(o,t[2]);r.push([o].concat(s))}else r.push([o])}return r}function xa(e,r){let t={};for(let s of r)for(let n of s.styles)t[n[0]]=s.inverse?null:n.slice(1);let o=e;for(let s of Object.keys(t))if(Array.isArray(t[s])){if(!(s in o))throw new Error(`Unknown Chalk style: ${s}`);t[s].length>0?o=o[s].apply(o,t[s]):o=o[s]}return o}Ra.exports=(e,r)=>{let t=[],o=[],s=[];if(r.replace(Ol,(n,a,i,c,l,d)=>{if(a)s.push(Oa(a));else if(c){let u=s.join("");s=[],o.push(t.length===0?u:xa(e,t)(u)),t.push({inverse:i,styles:Pl(c)})}else if(l){if(t.length===0)throw new Error("Found extraneous } in Chalk template literal");o.push(xa(e,t)(s.join(""))),s=[],t.pop()}else s.push(d)}),o.push(s.join("")),t.length>0){let n=`Chalk template literal is missing ${t.length} closing bracket${t.length===1?"":"s"} (\`}\`)`;throw new Error(n)}return o.join("")}});var Fa=M((uS,Ne)=>{"use strict";var lt=ia(),I=Sa(),ct=ka().stdout,Al=Ma(),$a=process.platform==="win32"&&!(process.env.TERM||"").toLowerCase().startsWith("xterm"),Pa=["ansi","ansi","ansi256","ansi16m"],Aa=new Set(["gray"]),ke=Object.create(null);function Ia(e,r){r=r||{};let t=ct?ct.level:0;e.level=r.level===void 0?t:r.level,e.enabled="enabled"in r?r.enabled:e.level>0}function Te(e){if(!this||!(this instanceof Te)||this.template){let r={};return Ia(r,e),r.template=function(){let t=[].slice.call(arguments);return Ul.apply(null,[r.template].concat(t))},Object.setPrototypeOf(r,Te.prototype),Object.setPrototypeOf(r.template,r),r.template.constructor=Te,r.template}Ia(this,e)}$a&&(I.blue.open="\x1B[94m");for(let e of Object.keys(I))I[e].closeRe=new RegExp(lt(I[e].close),"g"),ke[e]={get(){let r=I[e];return hr.call(this,this._styles?this._styles.concat(r):[r],this._empty,e)}};ke.visible={get(){return hr.call(this,this._styles||[],!0,"visible")}};I.color.closeRe=new RegExp(lt(I.color.close),"g");for(let e of Object.keys(I.color.ansi))Aa.has(e)||(ke[e]={get(){let r=this.level;return function(){let o={open:I.color[Pa[r]][e].apply(null,arguments),close:I.color.close,closeRe:I.color.closeRe};return hr.call(this,this._styles?this._styles.concat(o):[o],this._empty,e)}}});I.bgColor.closeRe=new RegExp(lt(I.bgColor.close),"g");for(let e of Object.keys(I.bgColor.ansi)){if(Aa.has(e))continue;let r="bg"+e[0].toUpperCase()+e.slice(1);ke[r]={get(){let t=this.level;return function(){let s={open:I.bgColor[Pa[t]][e].apply(null,arguments),close:I.bgColor.close,closeRe:I.bgColor.closeRe};return hr.call(this,this._styles?this._styles.concat(s):[s],this._empty,e)}}}}var Fl=Object.defineProperties(()=>{},ke);function hr(e,r,t){let o=function(){return Ll.apply(o,arguments)};o._styles=e,o._empty=r;let s=this;return Object.defineProperty(o,"level",{enumerable:!0,get(){return s.level},set(n){s.level=n}}),Object.defineProperty(o,"enabled",{enumerable:!0,get(){return s.enabled},set(n){s.enabled=n}}),o.hasGrey=this.hasGrey||t==="gray"||t==="grey",o.__proto__=Fl,o}function Ll(){let e=arguments,r=e.length,t=String(arguments[0]);if(r===0)return"";if(r>1)for(let s=1;s<r;s++)t+=" "+e[s];if(!this.enabled||this.level<=0||!t)return this._empty?"":t;let o=I.dim.open;$a&&this.hasGrey&&(I.dim.open="");for(let s of this._styles.slice().reverse())t=s.open+t.replace(s.closeRe,s.open)+s.close,t=t.replace(/\r?\n/g,`${s.close}$&${s.open}`);return I.dim.open=o,t}function Ul(e,r){if(!Array.isArray(r))return[].slice.call(arguments,1).join(" ");let t=[].slice.call(arguments,2),o=[r.raw[0]];for(let s=1;s<r.length;s++)o.push(String(t[s-1]).replace(/[{}\\]/g,"\\$&")),o.push(String(r.raw[s]));return Al(e,o.join(""))}Object.defineProperties(Te.prototype,ke);Ne.exports=Te();Ne.exports.supportsColor=ct;Ne.exports.default=Ne.exports});var Ua=M((mS,dt)=>{"use strict";var La=(e,r)=>{for(let t of Reflect.ownKeys(r))Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t));return e};dt.exports=La;dt.exports.default=La});var Na=M((fS,yr)=>{"use strict";var Tl=Ua(),gr=new WeakMap,Ta=(e,r={})=>{if(typeof e!="function")throw new TypeError("Expected a function");let t,o=0,s=e.displayName||e.name||"<anonymous>",n=function(...a){if(gr.set(n,++o),o===1)t=e.apply(this,a),e=null;else if(r.throw===!0)throw new Error(`Function \`${s}\` can only be called once`);return t};return Tl(n,e),gr.set(n,o),n};yr.exports=Ta;yr.exports.default=Ta;yr.exports.callCount=e=>{if(!gr.has(e))throw new Error(`The given function \`${e.name}\` is not wrapped by the \`onetime\` package`);return gr.get(e)}});var _a=M((hS,br)=>{br.exports=["SIGABRT","SIGALRM","SIGHUP","SIGINT","SIGTERM"];process.platform!=="win32"&&br.exports.push("SIGVTALRM","SIGXCPU","SIGXFSZ","SIGUSR2","SIGTRAP","SIGSYS","SIGQUIT","SIGIOT");process.platform==="linux"&&br.exports.push("SIGIO","SIGPOLL","SIGPWR","SIGSTKFLT","SIGUNUSED")});var Ha=M((gS,Oe)=>{var R=global.process,se=function(e){return e&&typeof e=="object"&&typeof e.removeListener=="function"&&typeof e.emit=="function"&&typeof e.reallyExit=="function"&&typeof e.listeners=="function"&&typeof e.kill=="function"&&typeof e.pid=="number"&&typeof e.on=="function"};se(R)?(Da=require("assert"),Ce=_a(),qa=/^win/i.test(R.platform),_e=require("events"),typeof _e!="function"&&(_e=_e.EventEmitter),R.__signal_exit_emitter__?F=R.__signal_exit_emitter__:(F=R.__signal_exit_emitter__=new _e,F.count=0,F.emitted={}),F.infinite||(F.setMaxListeners(1/0),F.infinite=!0),Oe.exports=function(e,r){if(!se(global.process))return function(){};Da.equal(typeof e,"function","a callback must be provided for exit handler"),xe===!1&&pt();var t="exit";r&&r.alwaysLast&&(t="afterexit");var o=function(){F.removeListener(t,e),F.listeners("exit").length===0&&F.listeners("afterexit").length===0&&Sr()};return F.on(t,e),o},Sr=function(){!xe||!se(global.process)||(xe=!1,Ce.forEach(function(r){try{R.removeListener(r,wr[r])}catch{}}),R.emit=vr,R.reallyExit=ut,F.count-=1)},Oe.exports.unload=Sr,ne=function(r,t,o){F.emitted[r]||(F.emitted[r]=!0,F.emit(r,t,o))},wr={},Ce.forEach(function(e){wr[e]=function(){if(se(global.process)){var t=R.listeners(e);t.length===F.count&&(Sr(),ne("exit",null,e),ne("afterexit",null,e),qa&&e==="SIGHUP"&&(e="SIGINT"),R.kill(R.pid,e))}}}),Oe.exports.signals=function(){return Ce},xe=!1,pt=function(){xe||!se(global.process)||(xe=!0,F.count+=1,Ce=Ce.filter(function(r){try{return R.on(r,wr[r]),!0}catch{return!1}}),R.emit=ja,R.reallyExit=Ba)},Oe.exports.load=pt,ut=R.reallyExit,Ba=function(r){se(global.process)&&(R.exitCode=r||0,ne("exit",R.exitCode,null),ne("afterexit",R.exitCode,null),ut.call(R,R.exitCode))},vr=R.emit,ja=function(r,t){if(r==="exit"&&se(global.process)){t!==void 0&&(R.exitCode=t);var o=vr.apply(this,arguments);return ne("exit",R.exitCode,null),ne("afterexit",R.exitCode,null),o}else return vr.apply(this,arguments)}):Oe.exports=function(){return function(){}};var Da,Ce,qa,_e,F,Sr,ne,wr,xe,pt,ut,Ba,vr,ja});var za=M((yS,Wa)=>{"use strict";var Nl=Na(),_l=Ha();Wa.exports=Nl(()=>{_l(()=>{process.stderr.write("\x1B[?25h")},{alwaysLast:!0})})});var Va=M(Re=>{"use strict";var Dl=za(),Er=!1;Re.show=(e=process.stderr)=>{e.isTTY&&(Er=!1,e.write("\x1B[?25h"))};Re.hide=(e=process.stderr)=>{e.isTTY&&(Dl(),Er=!0,e.write("\x1B[?25l"))};Re.toggle=(e,r)=>{e!==void 0&&(Er=e),Er?Re.show(r):Re.hide(r)}});var mt=M((SS,ql)=>{ql.exports={dots:{interval:50,frames:["\u280B","\u2819","\u2839","\u2838","\u283C","\u2834","\u2826","\u2827","\u2807","\u280F"]},dashes:{interval:80,frames:["-","_"]}}});var Ja=M((wS,Ka)=>{"use strict";Ka.exports=e=>{e=Object.assign({onlyFirst:!1},e);let r=["[\\u001B\\u009B][[\\]()#;?]*(?:(?:(?:(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]+)*|[a-zA-Z\\d]+(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]*)*)?\\u0007)","(?:(?:\\d{1,4}(?:;\\d{0,4})*)?[\\dA-PR-TZcf-ntqry=><~]))"].join("|");return new RegExp(r,e.onlyFirst?void 0:"g")}});var Ya=M((vS,ft)=>{"use strict";var Bl=Ja(),Ga=e=>typeof e=="string"?e.replace(Bl(),""):e;ft.exports=Ga;ft.exports.default=Ga});var bt=M((ES,Xa)=>{"use strict";var ae=require("readline"),jl=Ya(),{dashes:Hl,dots:Wl}=mt(),zl=["succeed","fail","spinning","non-spinnable","stopped"],Vl=["black","red","green","yellow","blue","magenta","cyan","white","gray","redBright","greenBright","yellowBright","blueBright","magentaBright","cyanBright","whiteBright"];function Kl(e){let{text:r,status:t,indent:o}=e,s={text:r,status:t,indent:o},n=gt(e);return zl.includes(t)||delete s.status,typeof r!="string"&&delete s.text,typeof o!="number"&&delete s.indent,{...n,...s}}function Jl({spinner:e,disableSpins:r,...t}){let o=gt(t),s=Yl(t),n=typeof r=="boolean"?{disableSpins:r}:{};return e=Gl(e),{...o,...s,...n,spinner:e}}function Gl(e={}){let r=yt()?Wl:Hl,{interval:t,frames:o}=e;return(!Array.isArray(o)||o.length<1)&&(o=r.frames),typeof t!="number"&&(t=r.interval),{interval:t,frames:o}}function gt({color:e,succeedColor:r,failColor:t,spinnerColor:o}){let s={color:e,succeedColor:r,failColor:t,spinnerColor:o};return Object.keys(s).forEach(n=>{Vl.includes(s[n])||delete s[n]}),s}function Yl({succeedPrefix:e,failPrefix:r}){return yt()?(e=e||"\u2713",r=r||"\u2716"):(e=e||"\u221A",r=r||"\xD7"),{succeedPrefix:e,failPrefix:r}}function Xl(e,r){return e.split(`
`).map((t,o)=>o===0?ht(t,r):ht(t,0)).join(`
`)}function ht(e,r){let t=process.stderr.columns||95;return e.length>=t-r?`${e.substring(0,t-r-1)}
${ht(e.substring(t-r-1,e.length),0)}`:e}function Zl(e,r){return jl(e).split(`
`).map((t,o)=>o===0?t.length+r:t.length)}function Ql(e,r,t){e.write(r),ae.moveCursor(e,0,-t.length)}function ed(e,r){r.forEach((t,o)=>{ae.moveCursor(e,t,o),ae.clearLine(e,1),ae.moveCursor(e,-t,-o)}),ae.moveCursor(e,0,r.length),ae.clearScreenDown(e),ae.moveCursor(e,0,-r.length)}function yt(){return process.platform!=="win32"||process.env.TERM_PROGRAM==="vscode"||!!process.env.WT_SESSION}Xa.exports={purgeSpinnersOptions:Jl,purgeSpinnerOptions:Kl,colorOptions:gt,breakText:Xl,getLinesLength:Zl,writeStream:Ql,cleanStream:ed,terminalSupportsUnicode:yt}});var ri=M((CS,Cr)=>{"use strict";var St=require("readline"),ie=Fa(),wt=Va(),{dashes:Qa,dots:ei}=mt(),{purgeSpinnerOptions:Za,purgeSpinnersOptions:rd,colorOptions:td,breakText:kr,getLinesLength:od,terminalSupportsUnicode:sd}=bt(),{isValidStatus:kS,writeStream:nd,cleanStream:ad}=bt(),vt=class{constructor(r={}){r=rd(r),this.options={spinnerColor:"greenBright",succeedColor:"green",failColor:"red",spinner:sd()?ei:Qa,disableSpins:!1,...r},this.spinners={},this.isCursorHidden=!1,this.currentInterval=null,this.stream=process.stderr,this.lineCount=0,this.currentFrameIndex=0,this.spin=!this.options.disableSpins&&!process.env.CI&&process.stderr&&process.stderr.isTTY,this.bindSigint()}pick(r){return this.spinners[r]}add(r,t={}){if(typeof r!="string")throw Error("A spinner reference name must be specified");t.text||(t.text=r);let o={...td(this.options),succeedPrefix:this.options.succeedPrefix,failPrefix:this.options.failPrefix,status:"spinning",...Za(t)};return this.spinners[r]=o,this.updateSpinnerState(),o}update(r,t={}){let{status:o}=t;return this.setSpinnerProperties(r,t,o),this.updateSpinnerState(),this.spinners[r]}succeed(r,t={}){return this.setSpinnerProperties(r,t,"succeed"),this.updateSpinnerState(),this.spinners[r]}fail(r,t={}){return this.setSpinnerProperties(r,t,"fail"),this.updateSpinnerState(),this.spinners[r]}remove(r){if(typeof r!="string")throw Error("A spinner reference name must be specified");let t=this.spinners[r];return delete this.spinners[r],t}stopAll(r="stopped"){return Object.keys(this.spinners).forEach(t=>{let{status:o}=this.spinners[t];o!=="fail"&&o!=="succeed"&&o!=="non-spinnable"&&(r==="succeed"||r==="fail"?(this.spinners[t].status=r,this.spinners[t].color=this.options[`${r}Color`]):(this.spinners[t].status="stopped",this.spinners[t].color="grey"))}),this.checkIfActiveSpinners(),this.spinners}hasActiveSpinners(){return!!Object.values(this.spinners).find(({status:r})=>r==="spinning")}setSpinnerProperties(r,t,o){if(typeof r!="string")throw Error("A spinner reference name must be specified");if(!this.spinners[r])throw Error(`No spinner initialized with name ${r}`);t=Za(t),o=o||"spinning",this.spinners[r]={...this.spinners[r],...t,status:o}}updateSpinnerState(r,t={},o){this.spin?(clearInterval(this.currentInterval),this.currentInterval=this.loopStream(),this.isCursorHidden||wt.hide(),this.isCursorHidden=!0,this.checkIfActiveSpinners()):this.setRawStreamOutput()}loopStream(){let{frames:r,interval:t}=this.options.spinner;return setInterval(()=>{this.setStreamOutput(r[this.currentFrameIndex]),this.currentFrameIndex=this.currentFrameIndex===r.length-1?0:++this.currentFrameIndex},t)}setStreamOutput(r=""){let t="",o=[],s=this.hasActiveSpinners();Object.values(this.spinners).map(({text:n,status:a,color:i,spinnerColor:c,succeedColor:l,failColor:d,succeedPrefix:u,failPrefix:m,indent:h})=>{let f,y=h||0;a==="spinning"?(y+=r.length+1,n=kr(n,y),f=`${ie[c](r)} ${i?ie[i](n):n}`):a==="succeed"?(y+=u.length+1,s&&(n=kr(n,y)),f=`${ie.green(u)} ${ie[l](n)}`):a==="fail"?(y+=m.length+1,s&&(n=kr(n,y)),f=`${ie.red(m)} ${ie[d](n)}`):(s&&(n=kr(n,y)),f=i?ie[i](n):n),o.push(...od(n,y)),t+=h?`${" ".repeat(h)}${f}
`:`${f}
`}),s||St.clearScreenDown(this.stream),nd(this.stream,t,o),s&&ad(this.stream,o),this.lineCount=o.length}setRawStreamOutput(){Object.values(this.spinners).forEach(r=>{process.stderr.write(`- ${r.text}
`)})}checkIfActiveSpinners(){this.hasActiveSpinners()||(this.spin&&(this.setStreamOutput(),St.moveCursor(this.stream,0,this.lineCount),clearInterval(this.currentInterval),this.isCursorHidden=!1,wt.show()),this.spinners={})}bindSigint(r){process.removeAllListeners("SIGINT"),process.on("SIGINT",()=>{wt.show(),St.moveCursor(process.stderr,0,this.lineCount),process.exit(0)})}};Cr.exports=vt;Cr.exports.dots=ei;Cr.exports.dashes=Qa});async function Me(e){if(!B)return null;try{return await B.get(e)}catch(r){return console.error("Redis get error:",r),null}}async function Ie(e,r,t=di){if(B)try{await B.set(e,r,{ex:t})}catch(o){console.error("Redis set error:",o)}}async function pi(e,r,t=di){if(B)try{let o=`seg:${e}`;await B.hset(o,r),await B.expire(o,t)}catch(o){console.error("Redis batch set error:",o)}}async function ui(e,r){if(!B)return null;try{let t=`seg:${e}`;return await B.hget(t,r)}catch(t){return console.error("Redis hash get error:",t),null}}function mi(e,r,t,o,s){return`stream:${e}:${r}:${t}:${o||"0"}:${s||"0"}`}async function Et(e,r){if(B)try{await B.hset("provider:health",{[e]:JSON.stringify(r)})}catch(t){console.error("Redis health save error:",t)}}async function fi(){if(!B)return{};try{let e=await B.hgetall("provider:health");if(!e)return{};let r={};for(let[t,o]of Object.entries(e))try{r[t]=JSON.parse(o)}catch{r[t]=o}return r}catch(e){return console.error("Redis all health get error:",e),{}}}var ci,li,ai,ii,B,di,De=Tr(()=>{"use strict";ci=require("@upstash/redis"),li=P(require("dotenv"),1);li.default.config();ai=process.env.UPSTASH_REDIS_REST_URL,ii=process.env.UPSTASH_REDIS_REST_TOKEN,B=null;ai&&ii?(console.log("Initializing Redis connection..."),B=new ci.Redis({url:ai,token:ii})):console.warn("UPSTASH_REDIS_REST_URL or UPSTASH_REDIS_REST_TOKEN not set, caching will be disabled");di=3600*4});var Si={};Pt(Si,{encryptPlaylistContent:()=>$r,generateStreamToken:()=>Mr,getStreamMetadata:()=>Ir,verifyEncryptedSegmentToken:()=>ud});async function pd(e,r,t){let o=[];e.replace(r,(n,...a)=>(o.push(t(n,...a)),n));let s=await Promise.all(o);return e.replace(r,()=>s.shift()||"")}async function Mr(e,r,t,o){let s=re.default.randomBytes(32).toString("hex"),n=Date.now()+14400*1e3,a={url:e,headers:r,expiresAt:n,ip:t,userAgent:o};return await Ie(`stream:token:${s}`,a),s}async function Ir(e,r,t){let o=await Me(`stream:token:${e}`);return!o||Date.now()>o.expiresAt?null:o.ip&&r&&o.ip!==r?(console.log(`[SECURITY] IP mismatch for token. Expected: ${o.ip}, Got: ${r}`),null):o.userAgent&&t&&o.userAgent!==t?(console.log("[SECURITY] User-Agent mismatch for token"),null):o}async function bi(e,r,t){let o=re.default.createHash("sha256").update(t).digest(),s=re.default.randomBytes(12),n=re.default.createCipheriv("aes-256-gcm",o,s),a=JSON.stringify({url:e,exp:r}),i=Ot.default.deflateSync(a),c=n.update(i),l=n.final();c=Buffer.concat([c,l]);let d=n.getAuthTag(),m=Buffer.concat([s,c,d]).toString("base64url");return{shortId:re.default.randomBytes(8).toString("hex"),encryptedData:m}}async function $r(e,r,t,o,s,n){let a=e.split(`
`),i={},c=Date.now()+14400*1e3,l=await Promise.all(a.map(async u=>{let m=u.trim();if(m.startsWith("#")&&m.includes('URI="'))return pd(u,/URI="([^"]+)"/g,async(b,C)=>{let x=C;if(!C.startsWith("http")){let _=new URL(o);if(C.startsWith("/"))x=`${_.protocol}//${_.host}${C}`;else{let k=_.pathname.split("/");k.pop(),x=`${_.protocol}//${_.host}${k.join("/")}/${C}`}}let{shortId:E,encryptedData:L}=await bi(x,c,t);return i[E]=L,`URI="${r}/s/${t}/chunk/${E}"`});if(!m||m.startsWith("#"))return u;let h=m;if(!m.startsWith("http")){let b=new URL(o);if(m.startsWith("/"))h=`${b.protocol}//${b.host}${m}`;else{let C=b.pathname.split("/");C.pop(),h=`${b.protocol}//${b.host}${C.join("/")}/${m}`}}let{shortId:f,encryptedData:y}=await bi(h,c,t);return i[f]=y,`${r}/s/${t}/chunk/${f}`})),d=Math.ceil((c-Date.now())/1e3);return await pi(t,i,d),l.join(`
`)}async function ud(e,r){try{let t=await ui(r,e);if(!t)return null;let o=Buffer.from(t,"base64url"),s=o.subarray(0,12),n=o.subarray(o.length-16),a=o.subarray(12,o.length-16),i=re.default.createHash("sha256").update(r).digest(),c=re.default.createDecipheriv("aes-256-gcm",i,s);c.setAuthTag(n);let l=Buffer.concat([c.update(a),c.final()]),d=Ot.default.inflateSync(l).toString("utf8"),u=JSON.parse(d);return u.exp<Date.now()?null:{url:u.url,expiresAt:u.exp}}catch{return null}}var re,Ot,Rt=Tr(()=>{"use strict";re=P(require("crypto"),1),Ot=P(require("zlib"),1);De()});var Ei={};Pt(Ei,{getMediaMetadata:()=>md});async function Ar(e,r={}){if(!Pr)return console.warn("TMDB API key not found (MOVIE_WEB_TMDB_API_KEY or TMDB_READ_API_KEY)"),null;let t=new URL(`https://api.themoviedb.org/3${e}`),o={"Content-Type":"application/json"};Pr.startsWith("ey")?o.Authorization=`Bearer ${Pr}`:t.searchParams.append("api_key",Pr),Object.entries(r).forEach(([s,n])=>{t.searchParams.append(s,n)});try{let s=await fetch(t.toString(),{headers:o});return s.ok?await s.json():(console.warn(`TMDB request failed: ${s.status} ${s.statusText}`),null)}catch(s){return console.error("TMDB request error:",s),null}}async function md(e,r,t,o){try{if(r==="movie"){let n=await Ar(`/movie/${e}`,{append_to_response:"external_ids"});return n?{title:n.title,tmdbId:String(n.id),imdbId:n.external_ids?.imdb_id||n.imdb_id,posterPath:n.poster_path,backdropPath:n.backdrop_path,releaseDate:n.release_date,runtime:n.runtime,genres:n.genres?.map(a=>a.name),type:"movie"}:null}if(t&&o){let n=await Ar(`/tv/${e}`,{append_to_response:"external_ids"}),a=await Ar(`/tv/${e}/season/${t}/episode/${o}`);return n?{title:n.name,tmdbId:String(n.id),imdbId:n.external_ids?.imdb_id,posterPath:a?.still_path||n.poster_path,backdropPath:n.backdrop_path,releaseDate:a?.air_date||n.first_air_date,runtime:a?.runtime||n.episode_run_time?.[0],genres:n.genres?.map(i=>i.name),type:"show",season:Number(t),episode:Number(o)}:null}let s=await Ar(`/tv/${e}`,{append_to_response:"external_ids"});return s?{title:s.name,tmdbId:String(s.id),imdbId:s.external_ids?.imdb_id,posterPath:s.poster_path,backdropPath:s.backdrop_path,releaseDate:s.first_air_date,genres:s.genres?.map(n=>n.name),type:"show"}:null}catch(s){return console.error("Error fetching metadata:",s),null}}var Pr,ki=Tr(()=>{"use strict";Pr=process.env.MOVIE_WEB_TMDB_API_KEY||process.env.TMDB_READ_API_KEY});var Oi=require("stream"),Ri=P(require("cors"),1),Mi=P(require("dotenv"),1),Mt=P(require("express"),1),It=P(require("express-rate-limit"),1),Ii=P(require("express-slow-down"),1);var p=class extends Error{constructor(r){super(`Couldn't find a stream: ${r??"not found"}`),this.name="NotFoundError"}};function At(e){let r=[];return e.scrapeMovie&&r.push("movie"),e.scrapeShow&&r.push("show"),{type:"source",id:e.id,rank:e.rank,name:e.name,mediaTypes:r}}function Ft(e){return{type:"embed",id:e.id,rank:e.rank,name:e.name}}function Lt(e){return e.sources.sort((r,t)=>t.rank-r.rank).map(At)}function Ut(e){return e.embeds.sort((r,t)=>t.rank-r.rank).map(Ft)}function Tt(e,r){let t=e.sources.find(s=>s.id===r);if(t)return At(t);let o=e.embeds.find(s=>s.id===r);return o?Ft(o):null}function Nr(e,r){let t=r?.baseUrl??"",o=e;t.length>0&&!t.endsWith("/")&&(t+="/"),o.startsWith("/")&&(o=o.slice(1));let s=t+o;if(!s.startsWith("http://")&&!s.startsWith("https://")&&!s.startsWith("data:"))throw new Error(`Invald URL -- URL doesn't start with a http scheme: '${s}'`);let n=new URL(s);return Object.entries(r?.query??{}).forEach(([a,i])=>{n.searchParams.set(a,i)}),n.toString()}function _r(e){let r=(o,s)=>e(o,{headers:s?.headers??{},method:s?.method??"GET",query:s?.query??{},baseUrl:s?.baseUrl??"",readHeaders:s?.readHeaders??[],body:s?.body,credentials:s?.credentials}),t=async(o,s)=>(await r(o,s)).body;return t.full=r,t}var g={CORS_ALLOWED:"cors-allowed",IP_LOCKED:"ip-locked",CF_BLOCKED:"cf-blocked",PROXY_BLOCKED:"proxy-blocked"},Dr={BROWSER:"browser",BROWSER_EXTENSION:"browser-extension",NATIVE:"native",ANY:"any"},qi={browser:{requires:[g.CORS_ALLOWED],disallowed:[]},"browser-extension":{requires:[],disallowed:[]},native:{requires:[],disallowed:[]},any:{requires:[],disallowed:[]}};function qr(e,r,t){let o=qi[e];return r||o.disallowed.push(g.IP_LOCKED),t&&o.disallowed.push(g.PROXY_BLOCKED),o}function X(e,r){return!(!e.requires.every(s=>r.includes(s))||e.disallowed.some(s=>r.includes(s)))}var Nt="https://proxy.nsbx.ru/proxy",Bi="https://proxy2.pstream.mov";function ce(e){return!!(!e.flags.includes(g.CORS_ALLOWED)||e.headers&&Object.keys(e.headers).length>0)}function le(e){let r=e.headers&&Object.keys(e.headers).length>0?e.headers:void 0,t={...e.type==="hls"&&{depth:e.proxyDepth??0}},o={headers:r,options:t};return e.type==="hls"&&(o.type="hls",o.url=e.playlist,e.playlist=`${Nt}?${new URLSearchParams({payload:Buffer.from(JSON.stringify(o)).toString("base64url")})}`),e.type==="file"&&(o.type="mp4",Object.entries(e.qualities).forEach(s=>{o.url=s[1].url,s[1].url=`${Nt}?${new URLSearchParams({payload:Buffer.from(JSON.stringify(o)).toString("base64url")})}`})),e.headers={},e.flags=[g.CORS_ALLOWED],e}function O(e,r={}){let t=encodeURIComponent(e),o=encodeURIComponent(JSON.stringify(r));return`${Bi}/m3u8-proxy?url=${t}${r?`&headers=${o}`:""}`}function S(e){let r=[];return e.scrapeMovie&&r.push("movie"),e.scrapeShow&&r.push("show"),{...e,type:"source",disabled:e.disabled??!1,externalSource:e.externalSource??!1,mediaTypes:r}}function v(e){return{...e,type:"embed",disabled:e.disabled??!1,mediaTypes:void 0}}var de="https://embed.warezcdn.link";var Be="https://warezcdn.link/player",_t="https://workerproxy.warezcdn.workers.dev";function ji(e){let r=atob(e);r=r.trim(),r=r.split("").reverse().join("");let t=r.slice(-5);return t=t.split("").reverse().join(""),r=r.slice(0,-5),`${r}${t}`}async function je(e){let t=(await e.proxiedFetcher("/player.php",{baseUrl:Be,headers:{Referer:`${Be}/getEmbed.php?${new URLSearchParams({id:e.url,sv:"warezcdn"})}`},query:{id:e.url}})).match(/let allowanceKey = "(.*?)";/)?.[1];if(!t)throw new p("Failed to get allowanceKey");let o=await e.proxiedFetcher("/functions.php",{baseUrl:Be,method:"POST",body:new URLSearchParams({getVideo:e.url,key:t})}),s=JSON.parse(o);if(!s.id)throw new p("can't get stream id");let n=ji(s.id);if(!n)throw new p("can't get file id");return n}var Hi=[50,51,52,53,54,55,56,57,58,59,60,61,62,63,64];async function Wi(e,r){for(let t of Hi){let o=`https://cloclo${t}.cloud.mail.ru/weblink/view/${r}`;if((await e.proxiedFetcher.full(o,{method:"GET",headers:{Range:"bytes=0-1"}})).statusCode===206)return o}return null}var pe=v({id:"warezcdnembedmp4",name:"WarezCDN MP4",rank:82,disabled:!0,async scrape(e){let r=await je(e);if(!r)throw new p("can't get file id");let t=await Wi(e,r);if(!t)throw new p("can't get stream id");return{stream:[{id:"primary",captions:[],qualities:{unknown:{type:"mp4",url:`${_t}/?${new URLSearchParams({url:t})}`}},type:"file",flags:[g.CORS_ALLOWED]}]}}});var qt=[pe.id,"cloudnestra"];function ue(e){return e?e.type==="hls"?!!e.playlist:e.type==="file"?Object.values(e.qualities).filter(t=>t.url.length>0).length!==0:!1:!1}function Dt(e){return e.includes("/m3u8-proxy?url=")}async function He(e,r,t){if(qt.includes(t))return e;let o=!1;if(e.type==="hls"){if(e.playlist.startsWith("data:"))return e;let s=o||Dt(e.playlist),n;if(s)try{let a=await fetch(e.playlist,{method:"GET",headers:{...e.preferredHeaders,...e.headers}});n={statusCode:a.status,body:await a.text(),finalUrl:a.url}}catch{return null}else n=await r.proxiedFetcher.full(e.playlist,{method:"GET",headers:{...e.preferredHeaders,...e.headers}});return n.statusCode<200||n.statusCode>=400?null:e}if(e.type==="file"){let s=await Promise.all(Object.values(e.qualities).map(async a=>{if(o||Dt(a.url))try{let c=await fetch(a.url,{method:"GET",headers:{...e.preferredHeaders,...e.headers,Range:"bytes=0-1"}});return{statusCode:c.status,body:await c.text(),finalUrl:c.url}}catch{return{statusCode:500,body:"",finalUrl:a.url}}return r.proxiedFetcher.full(a.url,{method:"GET",headers:{...e.preferredHeaders,...e.headers,Range:"bytes=0-1"}})})),n=e.qualities;return Object.keys(e.qualities).forEach((a,i)=>{(s[i].statusCode<200||s[i].statusCode>=400)&&delete n[a]}),Object.keys(n).length===0?null:{...e,qualities:n}}return null}async function Br(e,r,t){return qt.includes(t)?e:(await Promise.all(e.map(o=>He(o,r,t)))).filter(o=>o!==null)}async function Bt(e,r){let t=e.sources.find(n=>r.id===n.id);if(!t)throw new Error("Source with ID not found");if(r.media.type==="movie"&&!t.scrapeMovie)throw new Error("Source is not compatible with movies");if(r.media.type==="show"&&!t.scrapeShow)throw new Error("Source is not compatible with shows");let o={fetcher:r.fetcher,proxiedFetcher:r.proxiedFetcher,progress(n){r.events?.update?.({id:t.id,percentage:n,status:"pending"})}},s=null;if(r.media.type==="movie"&&t.scrapeMovie?s=await t.scrapeMovie({...o,media:r.media}):r.media.type==="show"&&t.scrapeShow&&(s=await t.scrapeShow({...o,media:r.media})),s?.stream&&(s.stream=s.stream.filter(n=>ue(n)).filter(n=>X(r.features,n.flags)),s.stream=s.stream.map(n=>ce(n)&&r.proxyStreams?le(n):n)),!s)throw new Error("output is null");if(s.embeds=s.embeds.filter(n=>{let a=e.embeds.find(i=>i.id===n.embedId);return!(!a||a.disabled)}),(!s.stream||s.stream.length===0)&&s.embeds.length===0)throw new p("No streams found");if(s.stream&&s.stream.length>0&&s.embeds.length===0){let n=await Br(s.stream,r,t.id);if(n.length===0)throw new p("No playable streams found");s.stream=n}return s}async function jt(e,r){let t=e.embeds.find(a=>r.id===a.id);if(!t)throw new Error("Embed with ID not found");let o=r.url,s=await t.scrape({fetcher:r.fetcher,proxiedFetcher:r.proxiedFetcher,url:o,progress(a){r.events?.update?.({id:t.id,percentage:a,status:"pending"})}});if(s.stream=s.stream.filter(a=>ue(a)).filter(a=>X(r.features,a.flags)),s.stream.length===0)throw new p("No streams found");s.stream=s.stream.map(a=>ce(a)&&r.proxyStreams?le(a):a);let n=await Br(s.stream,r,t.id);if(n.length===0)throw new p("No playable streams found");return s.stream=n,s}function jr(e,r){let t=[...r];return t.sort((o,s)=>{let n=e.indexOf(o.id),a=e.indexOf(s.id);return n>=0&&a>=0?n-a:a>=0?1:n>=0?-1:s.rank-o.rank}),t}async function Ht(e,r){let t=jr(r.sourceOrder??[],e.sources).filter(i=>r.media.type==="movie"?!!i.scrapeMovie:r.media.type==="show"?!!i.scrapeShow:!1),o=jr(r.embedOrder??[],e.embeds),s=o.map(i=>i.id),n="",a={fetcher:r.fetcher,proxiedFetcher:r.proxiedFetcher,progress(i){r.events?.update?.({id:n,percentage:i,status:"pending"})}};r.events?.init?.({sourceIds:t.map(i=>i.id)});for(let i of t){r.events?.start?.(i.id),n=i.id;let c=null;try{if(r.media.type==="movie"&&i.scrapeMovie?c=await i.scrapeMovie({...a,media:r.media}):r.media.type==="show"&&i.scrapeShow&&(c=await i.scrapeShow({...a,media:r.media})),c&&(c.stream=(c.stream??[]).filter(ue).filter(d=>X(r.features,d.flags)),c.stream=c.stream.map(d=>ce(d)&&r.proxyStreams?le(d):d)),!c||!c.stream?.length&&!c.embeds.length)throw new p("No streams found")}catch(d){let u={id:i.id,percentage:100,status:d instanceof p?"notfound":"failure",reason:d instanceof p?d.message:void 0,error:d instanceof p?void 0:d};r.events?.update?.(u);continue}if(!c)throw new Error("Invalid media type");if(c.stream?.[0]){let d=await He(c.stream[0],r,i.id);if(!d)throw new p("No streams found");return{sourceId:i.id,stream:d}}let l=c.embeds.filter(d=>{let u=e.embeds.find(m=>m.id===d.embedId);return u&&!u.disabled}).sort((d,u)=>s.indexOf(d.embedId)-s.indexOf(u.embedId));l.length>0&&r.events?.discoverEmbeds?.({embeds:l.map((d,u)=>({id:[i.id,u].join("-"),embedScraperId:d.embedId})),sourceId:i.id});for(let[d,u]of l.entries()){let m=o.find(y=>y.id===u.embedId);if(!m)throw new Error("Invalid embed returned");let h=[i.id,d].join("-");r.events?.start?.(h),n=h;let f;try{if(f=await m.scrape({...a,url:u.url}),f.stream=f.stream.filter(ue).filter(b=>X(r.features,b.flags)),f.stream=f.stream.map(b=>ce(b)&&r.proxyStreams?le(b):b),f.stream.length===0)throw new p("No streams found");let y=await He(f.stream[0],r,u.embedId);if(!y)throw new p("No streams found");f.stream=[y]}catch(y){let b={id:h,percentage:100,status:y instanceof p?"notfound":"failure",reason:y instanceof p?y.message:void 0,error:y instanceof p?void 0:y};r.events?.update?.(b);continue}return{sourceId:i.id,embedId:m.id,stream:f.stream[0]}}}return null}function Hr(e){let r={embeds:e.embeds,sources:e.sources},t={features:e.features,fetcher:_r(e.fetcher),proxiedFetcher:_r(e.proxiedFetcher??e.fetcher),proxyStreams:e.proxyStreams};return{runAll(o){return Ht(r,{...t,...o})},runSourceScraper(o){return Bt(r,{...t,...o})},runEmbedScraper(o){return jt(r,{...t,...o})},getMetadata(o){return Tt(r,o)},listSources(){return Lt(r)},listEmbeds(){return Ut(r)}}}var Wt=require("nanoid");var zi=(0,Wt.customAlphabet)("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",10),We="https://d000d.com",zt=v({id:"dood",name:"dood",rank:173,async scrape(e){let r=e.url;e.url.includes("primewire")&&(r=(await e.proxiedFetcher.full(e.url)).finalUrl);let t=r.split("/d/")[1]||r.split("/e/")[1],o=await e.proxiedFetcher(`/e/${t}`,{method:"GET",baseUrl:We}),s=o.match(/\?token=([^&]+)&expiry=/)?.[1],n=o.match(/\$\.get\('\/pass_md5([^']+)/)?.[1],a=o.match(/thumbnails:\s\{\s*vtt:\s'([^']*)'/),c=`${await e.proxiedFetcher(`/pass_md5${n}`,{headers:{Referer:`${We}/e/${t}`},method:"GET",baseUrl:We})}${zi()}?token=${s}&expiry=${Date.now()}`;if(!c.startsWith("http"))throw new Error("Invalid URL");return{stream:[{id:"primary",type:"file",flags:[],captions:[],qualities:{unknown:{type:"mp4",url:c}},headers:{Referer:We},...a?{thumbnailTrack:{type:"vtt",url:`https:${a[1]}`}}:{}}]}}});var Kt=P(require("unpacker"),1);var Vt="https://mixdrop.ag",Vi=/(eval\(function\(p,a,c,k,e,d\){.*{}\)\))/,Ki=/MDCore\.wurl="(.*?)";/,ze=v({id:"mixdrop",name:"MixDrop",rank:198,async scrape(e){let r=e.url;e.url.includes("primewire")&&(r=(await e.fetcher.full(e.url)).finalUrl);let t=new URL(r).pathname.split("/")[2],s=(await e.proxiedFetcher(`/e/${t}`,{baseUrl:Vt})).match(Vi);if(!s)throw new Error("failed to find packed mixdrop JavaScript");let a=Kt.unpack(s[1]).match(Ki);if(!a)throw new Error("failed to find packed mixdrop source link");let i=a[1];return{stream:[{id:"primary",type:"file",flags:[g.IP_LOCKED],captions:[],qualities:{unknown:{type:"mp4",url:i.startsWith("http")?i:`https:${i}`,headers:{Referer:Vt}}}}]}}});function Ji(e){return String.fromCharCode(parseInt(e,16))}function Gi(e,r){return(e.match(/../g)?.map(Ji).join("")||"").split("").map((o,s)=>String.fromCharCode(o.charCodeAt(0)^r.charCodeAt(s%r.length))).join("")}var Jt=v({id:"turbovid",name:"Turbovid",rank:122,async scrape(e){let r=new URL(e.url).origin,t=await e.proxiedFetcher(e.url);e.progress(30);let o=t.match(/const\s+apkey\s*=\s*"(.*?)";/)?.[1],s=t.match(/const\s+xxid\s*=\s*"(.*?)";/)?.[1];if(!o||!s)throw new Error("Failed to get required values");let n=JSON.parse(await e.proxiedFetcher("/api/cucked/juice_key",{baseUrl:r,headers:{referer:e.url,"User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/135.0.0.0 Safari/537.36",Accept:"*/*","Accept-Language":"en-US,en;q=0.9",Connection:"keep-alive","Content-Type":"application/json","X-Turbo":"TurboVidClient","Sec-Fetch-Dest":"empty","Sec-Fetch-Mode":"cors","Sec-Fetch-Site":"same-origin"}})).juice;if(!n)throw new Error("Failed to fetch the key");let a=atob(n);e.progress(60);let i=JSON.parse(await e.proxiedFetcher("/api/cucked/the_juice_v2/",{baseUrl:r,query:{[o]:s},headers:{"User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/135.0.0.0 Safari/537.36",Accept:"*/*","Accept-Language":"en-US,en;q=0.9",Connection:"keep-alive","Content-Type":"application/json","X-Turbo":"TurboVidClient","Sec-Fetch-Dest":"empty","Sec-Fetch-Mode":"cors","Sec-Fetch-Site":"same-origin",referer:e.url}})).data;if(!i)throw new Error("Failed to fetch required data");e.progress(90);let c=Gi(i,a),l={referer:`${r}/`,origin:r};return{stream:[{type:"hls",id:"primary",playlist:O(c,l),flags:[],captions:[]}]}}});var Xt=P(require("crypto-js"),1);var Gt=P(require("iso-639-1"),1),Yi={srt:"srt",vtt:"vtt"};function me(e){let t=Object.keys(Yi).find(o=>e.endsWith(`.${o}`));return t||null}function q(e){let t={"chinese - hong kong":"zh","chinese - traditional":"zh",czech:"cs",danish:"da",dutch:"nl",english:"en","english - sdh":"en",finnish:"fi",french:"fr",german:"de",greek:"el",hungarian:"hu",italian:"it",korean:"ko",norwegian:"no",polish:"pl",portuguese:"pt","portuguese - brazilian":"pt",romanian:"ro","spanish - european":"es","spanish - latin american":"es",spanish:"es",swedish:"sv",turkish:"tr",\u0627\u064E\u0644\u0652\u0639\u064E\u0631\u064E\u0628\u0650\u064A\u064E\u0651\u0629\u064F:"ar",\u09AC\u09BE\u0982\u09B2\u09BE:"bn",filipino:"tl",indonesia:"id",\u0627\u0631\u062F\u0648:"ur",English:"en",Arabic:"ar",Bosnian:"bs",Bulgarian:"bg",Croatian:"hr",Czech:"cs",Danish:"da",Dutch:"nl",Estonian:"et",Finnish:"fi",French:"fr",German:"de",Greek:"el",Hebrew:"he",Hungarian:"hu",Indonesian:"id",Italian:"it",Norwegian:"no",Persian:"fa",Polish:"pl",Portuguese:"pt","Protuguese (BR)":"pt-br",Romanian:"ro",Russian:"ru",russian:"ru",Serbian:"sr",Slovenian:"sl",Spanish:"es",Swedish:"sv",Thai:"th",Turkish:"tr",ng:"en",re:"fr",pa:"es"}[e.toLowerCase()];if(t)return t;let o=Gt.default.getCode(e);return o.length===0?null:o}function Yt(e){let r={};return e.filter(t=>r[t.language]?!1:(r[t.language]=!0,!0))}var Xi="https://rabbitstream.net",Zi="https://rabbitstream.net/",{AES:Qi,enc:ec}=Xt.default;function rc(e){try{return JSON.parse(e),!0}catch{return!1}}function tc(e){let r=e.lastIndexOf("switch"),t=e.indexOf("partKeyStartPosition"),o=e.slice(r,t),s=[],n=o.matchAll(/:[a-zA-Z0-9]+=([a-zA-Z0-9]+),[a-zA-Z0-9]+=([a-zA-Z0-9]+);/g);for(let a of n){let i=[];for(let c of[a[1],a[2]]){let l=new RegExp(`${c}=0x([a-zA-Z0-9]+)`,"g"),d=[...e.matchAll(l)],u=d[d.length-1];if(!u)return null;let m=parseInt(u[1],16);i.push(m)}s.push([i[0],i[1]])}return s}var Ve=v({id:"upcloud",name:"UpCloud",rank:200,disabled:!0,async scrape(e){let r=new URL(e.url.replace("embed-5","embed-4")),t=r.pathname.split("/"),o=t[t.length-1],s=await e.proxiedFetcher(`${r.origin}/ajax/embed-4/getSources?id=${o}`,{headers:{Referer:r.origin,"X-Requested-With":"XMLHttpRequest"}}),n=null;if(!rc(s.sources)){let i=await e.proxiedFetcher("https://rabbitstream.net/js/player/prod/e4-player.min.js",{query:{v:Date.now().toString()}}),c=tc(i);if(!c)throw new Error("Key extraction failed");let l="",d=s.sources,u=0;c.forEach(([f,y])=>{let b=f+u,C=b+y;l+=s.sources.slice(b,C),d=d.replace(s.sources.substring(b,C),""),u+=y});let m=Qi.decrypt(d,l).toString(ec.Utf8),h=JSON.parse(m)[0];if(!h)throw new Error("No stream found");n=h}if(!n)throw new Error("upcloud source not found");let a=[];return s.tracks.forEach(i=>{if(i.kind!=="captions")return;let c=me(i.file);if(!c)return;let l=q(i.label.split(" ")[0]);l&&a.push({id:i.file,language:l,hasCorsRestrictions:!1,type:c,url:i.file})}),{stream:[{id:"primary",type:"hls",playlist:n.file,flags:[g.CORS_ALLOWED],captions:a,preferredHeaders:{Referer:Zi,Origin:Xi}}]}}});var Wr="https://tom.autoembed.cc";async function Zt(e){let r=e.media.type==="show"?"tv":"movie",t=e.media.tmdbId;e.media.type==="show"&&(t=`${t}/${e.media.season.number}/${e.media.episode.number}`);let o=await e.proxiedFetcher("/api/getVideoSource",{baseUrl:Wr,query:{type:r,id:t},headers:{Referer:Wr,Origin:Wr}});if(!o)throw new p("Failed to fetch video source");if(!o.videoSource)throw new p("No video source found");e.progress(50);let s=[{embedId:"autoembed-english",url:o.videoSource}];return e.progress(90),{embeds:s}}var Qt=S({id:"autoembed",name:"Autoembed",rank:110,disabled:!0,flags:[g.CORS_ALLOWED],scrapeMovie:Zt,scrapeShow:Zt});function eo(e){let r=e.trim().toLowerCase();return r!=="the movie"&&r.endsWith("the movie")&&(r=r.replace("the movie","")),r!=="the series"&&r.endsWith("the series")&&(r=r.replace("the series","")),r.replace(/['":]/g,"").replace(/[^a-zA-Z0-9]+/g,"_")}function $e(e,r){return eo(e)===eo(r)}function U(e,r,t){let o=t===void 0?!0:e.releaseYear===t;return $e(e.title,r)&&o}var ro=P(require("cookie"),1),zr=P(require("set-cookie-parser"),1);function A(e){return Object.entries(e).map(([r,t])=>ro.default.serialize(r,t)).join("; ")}function to(e){let r=zr.default.splitCookiesString(e);return zr.default.parse(r,{map:!0})}var fe="https://ee3.me",oo="_sf_",so="defonotscraping";var no=require("cheerio");async function ao(e,r,t){let o=await t.proxiedFetcher.full("/login",{baseUrl:fe,method:"POST",body:new URLSearchParams({user:e,pass:r,action:"login"}),readHeaders:["Set-Cookie"]}),s=JSON.parse(o.body);return to(s.status===1?o.headers.get("Set-Cookie")??"":"PHPSESSID=mk2p73c77qc28o5i5120843ruu;").PHPSESSID.value}function io(e){let r=[],t=(0,no.load)(e);return t("div").each((o,s)=>{let n=t(s).find(".title").text().trim(),a=parseInt(t(s).find(".details span").first().text().trim(),10),i=t(s).find(".control-buttons").attr("data-id");n&&a&&i&&r.push({title:n,year:a,id:i})}),r}async function oc(e){let r=await ao(oo,so,e);if(!r)throw new Error("Login failed");let o=io(await e.proxiedFetcher("/get",{baseUrl:fe,method:"POST",body:new URLSearchParams({query:e.media.title,action:"search"}),headers:{cookie:A({PHPSESSID:r})}})).find(d=>d&&U(e.media,d.title,d.year))?.id;if(!o)throw new p("No watchable item found");e.progress(20);let s=JSON.parse(await e.proxiedFetcher("/get",{baseUrl:fe,method:"POST",body:new URLSearchParams({id:o,action:"get_movie_info"}),headers:{cookie:A({PHPSESSID:r})}}));if(!s.message.video)throw new Error("Failed to get the stream");e.progress(40);let n=JSON.parse(await e.proxiedFetcher("/renew",{baseUrl:fe,method:"POST",headers:{cookie:A({PHPSESSID:r})}}));if(!n.k)throw new Error("Failed to get the key");e.progress(60);let a=s.message.server==="1"?"https://vid.ee3.me/vid/":"https://vault.rips.cc/video/",i=n.k,c=`${a}${s.message.video}?${new URLSearchParams({k:i})}`,l=[];return s.message.subs?.toLowerCase()==="yes"&&s.message.imdbID&&l.push({id:`https://rips.cc/subs/${s.message.imdbID}.vtt`,url:`https://rips.cc/subs/${s.message.imdbID}.vtt`,type:"vtt",hasCorsRestrictions:!1,language:"en"}),e.progress(90),{embeds:[],stream:[{id:"primary",type:"file",flags:[g.CORS_ALLOWED],captions:l,qualities:{720:{type:"mp4",url:c}}}]}}var co=S({id:"ee3",name:"EE3",rank:120,disabled:!0,flags:[g.CORS_ALLOWED],scrapeMovie:oc});var lo=require("cheerio");function he(e){switch(e.toLowerCase().replace("p","")){case"360":return"360";case"480":return"480";case"720":return"720";case"1080":return"1080";case"2160":return"4k";case"4k":return"4k";default:return"unknown"}}var Ke="https://fsharetv.co";async function sc(e){let r=await e.proxiedFetcher("/search",{baseUrl:Ke,query:{q:e.media.title}}),t=(0,lo.load)(r),o=[];t(".movie-item").each((d,u)=>{let[,m,h]=t(u).find("b").text()?.match(/^(.*?)\s*(?:\(?\s*(\d{4})(?:\s*-\s*\d{0,4})?\s*\)?)?\s*$/)||[],f=t(u).find("a").attr("href");!m||!f||o.push({title:m,year:Number(h)??void 0,url:f})});let s=o.find(d=>d&&U(e.media,d.title,d.year))?.url;if(!s)throw new p("No watchable item found");e.progress(50);let a=(await e.proxiedFetcher(s.replace("/movie","/w"),{baseUrl:Ke})).match(/Movie\.setSource\('([^']*)'/)?.[1];if(!a)throw new Error("File ID not found");let i=await e.proxiedFetcher(`/api/file/${a}/source`,{baseUrl:Ke,query:{type:"watch"}});if(!i.data.file.sources.length)throw new Error("No sources found");let c=new URL((await e.proxiedFetcher.full(i.data.file.sources[0].src,{baseUrl:Ke})).finalUrl).origin,l=i.data.file.sources.reduce((d,u)=>{let m=typeof u.quality=="number"?u.quality.toString():u.quality,h=he(m);return d[h]={type:"mp4",url:`${c}${u.src.replace("/api","")}`},d},{});return e.progress(90),{embeds:[],stream:[{id:"primary",type:"file",flags:[],headers:{referer:"https://fsharetv.co"},qualities:l,captions:[]}]}}var po=S({id:"fsharetv",name:"FshareTV",rank:190,disabled:!0,flags:[],scrapeMovie:sc});var nc="https://isut.streamflix.one";async function uo(e){let t=(await e.fetcher(`${nc}/api/source/${e.media.type==="movie"?`${e.media.tmdbId}`:`${e.media.tmdbId}/${e.media.season.number}/${e.media.episode.number}`}`)).sources;if(!t||t.length===0)throw new p("No sources found");let o=t[0].file;if(!o)throw new p("No file URL found");return e.progress(90),{embeds:[],stream:[{id:"primary",playlist:o,type:"hls",flags:[g.CORS_ALLOWED],captions:[]}]}}var mo=S({id:"insertunit",name:"Insertunit",rank:12,disabled:!0,flags:[g.CORS_ALLOWED,g.IP_LOCKED],scrapeMovie:uo,scrapeShow:uo});var go=require("cheerio");var fo="https://mp4hydra.org/";async function ho(e){let r=await e.proxiedFetcher("/search",{baseUrl:fo,query:{q:e.media.title}});e.progress(40);let t=(0,go.load)(r),o=[];t(".search-details").each((i,c)=>{let[,l,d]=t(c).find("a").first().text().trim().match(/^(.*?)\s*(?:\(?\s*(\d{4})(?:\s*-\s*\d{0,4})?\s*\)?)?\s*$/)||[],u=t(c).find("a").attr("href")?.split("/")[4];!l||!u||o.push({title:l,year:d?parseInt(d,10):void 0,url:u})});let s=o.find(i=>i&&U(e.media,i.title,i.year))?.url;if(!s)throw new p("No watchable item found");e.progress(60);let n=await e.proxiedFetcher("/info2?v=8",{method:"POST",body:new URLSearchParams({z:JSON.stringify([{s,t:"movie"}])}),baseUrl:fo});if(!n.playlist[0].src||!n.servers)throw new p("No watchable item found");e.progress(80);let a=[];return[n.servers[n.servers.auto],...Object.values(n.servers).filter(i=>i!==n.servers[n.servers.auto]&&i!==n.servers.auto)].forEach((i,c)=>a.push({embedId:`mp4hydra-${c+1}`,url:`${i}${n.playlist[0].src}|${n.playlist[0].label}`})),e.progress(90),{embeds:a}}var yo=S({id:"mp4hydra",name:"Mp4Hydra",rank:4,disabled:!0,flags:[g.CORS_ALLOWED],scrapeMovie:ho,scrapeShow:ho});var bo="https://nscrape.andresdev.org/api";async function So(e){let r=e.media.tmdbId,t;e.media.type==="movie"?t=`${bo}/get-stream?tmdbId=${r}`:t=`${bo}/get-show-stream?tmdbId=${r}&season=${e.media.season.number}&episode=${e.media.episode.number}`;let o=await e.proxiedFetcher(t);if(!o.success||!o.rurl)throw new p("No stream found");return{stream:[{id:"nepu",type:"hls",playlist:o.rurl,flags:[g.CORS_ALLOWED],captions:[]}],embeds:[]}}var wo=S({id:"nepu",name:"Nepu",rank:201,disabled:!0,flags:[g.CORS_ALLOWED],scrapeMovie:So,scrapeShow:So});var Je="https://mbp.pirxcy.dev";function vo(e){let r=e.list.reduce((o,s)=>{let{path:n,quality:a,format:i}=s,c=s.real_quality;if(i!=="mp4")return o;let l;if(a==="4K"||c==="4K")l=2160;else{let d=a.replace("p","");l=parseInt(d,10)}return Number.isNaN(l)||o[l]||(o[l]=n),o},{}),t=Object.entries(r).reduce((o,[s,n])=>(o[s]=n,o),{});return{...t[2160]&&{"4k":{type:"mp4",url:t[2160]}},...t[1080]&&{1080:{type:"mp4",url:t[1080]}},...t[720]&&{720:{type:"mp4",url:t[720]}},...t[480]&&{480:{type:"mp4",url:t[480]}},...t[360]&&{360:{type:"mp4",url:t[360]}},...t.unknown&&{unknown:{type:"mp4",url:t.unknown}}}}async function Eo(e,r,t,o,s){let n=`${Je}/search?q=${encodeURIComponent(t)}&type=${o}${s?`&year=${s}`:""}`,a=await e.proxiedFetcher(n);if(!a.data||a.data.length===0)throw new p("No results found in search");for(let i of a.data){let c=`${Je}/details/${o}/${i.id}`,l=await e.proxiedFetcher(c);if(l.data&&l.data.tmdb_id.toString()===r)return i.id}throw new p("Could not find matching media item for TMDB ID")}async function ac(e){let r=e.media.tmdbId,t=e.media.title,o=e.media.releaseYear?.toString();if(!r||!t)throw new p("Missing required media information");let s=await Eo(e,r,t,"movie",o),n=`${Je}/movie/${s}`,a=await e.proxiedFetcher(n);if(!a.data||!a.data.list)throw new p("No streams found for this movie");return{stream:[{id:"pirxcy",type:"file",qualities:vo(a.data),flags:[g.CORS_ALLOWED],captions:[]}],embeds:[]}}async function ic(e){let r=e.media.tmdbId,t=e.media.title,o=e.media.releaseYear?.toString(),s=e.media.season.number,n=e.media.episode.number;if(!r||!t||!s||!n)throw new p("Missing required media information");let a=await Eo(e,r,t,"tv",o),i=`${Je}/tv/${a}/${s}/${n}`,c=await e.proxiedFetcher(i);if(!c.data||!c.data.list)throw new p("No streams found for this episode");let l=vo(c.data);return{embeds:[],stream:[{id:"primary",type:"file",qualities:l,flags:[g.CORS_ALLOWED],captions:[]}]}}var ko=S({id:"pirxcy",name:"Pirxcy",rank:230,disabled:!0,flags:[g.CORS_ALLOWED],scrapeMovie:ac,scrapeShow:ic});var ge=require("cheerio");var Co=require("cheerio"),Z="https://tugaflix.love/";function Vr(e){let r=[],t=(0,Co.load)(e);return t(".items .poster").each((o,s)=>{let n=t(s).find("a"),a=n.attr("href"),[,i,c]=n.attr("title")?.match(/^(.*?)\s*(?:\((\d{4})\))?\s*$/)||[];!i||!a||r.push({title:i,year:c?parseInt(c,10):void 0,url:a})}),r}var xo=S({id:"tugaflix",name:"Tugaflix",rank:70,disabled:!0,flags:[g.IP_LOCKED],scrapeMovie:async e=>{let r=Vr(await e.proxiedFetcher("/filmes/",{baseUrl:Z,query:{s:e.media.title}}));if(r.length===0)throw new p("No watchable item found");let t=r.find(i=>i&&U(e.media,i.title,i.year))?.url;if(!t)throw new p("No watchable item found");e.progress(50);let o=await e.proxiedFetcher(t,{baseUrl:Z}),s=(0,ge.load)(o),n=[],a=s('iframe[src*="mixdrop"], a[href*="mixdrop"], button[data-url*="mixdrop"]');for(let i of a){let c=s(i).attr("src")||s(i).attr("href")||s(i).attr("data-url");c&&c.includes("mixdrop")&&n.push({embedId:"mixdrop",url:c.startsWith("http")?c:`https:${c}`})}if(n.length===0){let i=s('a:contains("Watch"), a:contains("Assistir"), .watch-btn, .play-btn');for(let c of i){let l=s(c).attr("href");if(l)try{let d=await e.proxiedFetcher(l,{baseUrl:Z}),u=(0,ge.load)(d),m=u('iframe[src*="mixdrop"], a[href*="mixdrop"]');for(let h of m){let f=u(h).attr("src")||u(h).attr("href");f&&f.includes("mixdrop")&&n.push({embedId:"mixdrop",url:f.startsWith("http")?f:`https:${f}`})}}catch{continue}}}return e.progress(90),{embeds:n}},scrapeShow:async e=>{let r=Vr(await e.proxiedFetcher("/series/",{baseUrl:Z,query:{s:e.media.title}}));if(r.length===0)throw new p("No watchable item found");let t=r.find(m=>m&&U(e.media,m.title,m.year))?.url;if(!t)throw new p("No watchable item found");e.progress(50);let o=await e.proxiedFetcher(t,{baseUrl:Z}),s=(0,ge.load)(o),n=[],a=e.media.season.number<10?`0${e.media.season.number}`:e.media.season.number.toString(),i=e.media.episode.number<10?`0${e.media.episode.number}`:e.media.episode.number.toString(),c=s(`a:contains("S${a}E${i}"), a:contains("${e.media.season.number}x${e.media.episode.number}")`).attr("href"),l=o;if(c)l=await e.proxiedFetcher(c,{baseUrl:Z});else try{l=await e.proxiedFetcher(t,{method:"POST",body:new URLSearchParams({[`S${a}E${i}`]:""}),baseUrl:Z})}catch{}let d=(0,ge.load)(l),u=d('iframe[src*="mixdrop"], a[href*="mixdrop"], button[data-url*="mixdrop"]');for(let m of u){let h=d(m).attr("src")||d(m).attr("href")||d(m).attr("data-url");h&&h.includes("mixdrop")&&n.push({embedId:"mixdrop",url:h.startsWith("http")?h:`https:${h}`})}if(n.length===0){let m=d('iframe[name="player"], iframe[src]');for(let h of m){let f=d(h).attr("src");if(f)try{let y=await e.proxiedFetcher(f.startsWith("http")?f:`https:${f}`),b=(0,ge.load)(y),C=b('iframe[src*="mixdrop"], a[href*="mixdrop"]');for(let x of C){let E=b(x).attr("src")||b(x).attr("href");E&&E.includes("mixdrop")&&n.push({embedId:"mixdrop",url:E.startsWith("http")?E:`https:${E}`})}}catch{continue}}}return e.progress(90),{embeds:n}}});var W={decoder1:e=>{let t=[];for(let o=0;o<e.length;o+=3)t.push(e.substring(o,Math.min(o+3,e.length)));return t.reverse().join("")},decoder2:e=>{let r="pWB9V)[*4I`nJpp?ozyB~dbr9yt!_n4u".split("").map(n=>n.charCodeAt(0)),t=3,s=(e.match(/.{2}/g)||[]).map(n=>parseInt(n,16)).map((n,a)=>(n^r[a%r.length])-t);return Buffer.from(String.fromCharCode(...s),"base64").toString("utf-8")},decoder3:e=>{let r=e.split("").map(t=>/[a-mA-M]/.test(t)?String.fromCharCode(t.charCodeAt(0)+13):/[n-zN-Z]/.test(t)?String.fromCharCode(t.charCodeAt(0)-13):t);return Buffer.from(r.join(""),"base64").toString("utf-8")},decoder4:e=>{let r=e.split("").reverse().join(""),t=Array.from(r).filter((o,s)=>s%2===0).join("");return Buffer.from(t,"base64").toString("utf-8")},decoder5:e=>{try{let r=e.split("").reverse().join("");return(Array.from(r).map(n=>String.fromCharCode(n.charCodeAt(0)-1)).join("").match(/.{1,2}/g)||[]).map(n=>{let a=parseInt(n,16);return Number.isNaN(a)?"":String.fromCharCode(a)}).join("")}catch{return""}},decoder6:e=>{let r=Array.from(e).reverse().map(o=>o.charCodeAt(0)-1),t=[];for(let o=0;o<r.length;o+=2)t.push(parseInt(String.fromCharCode(r[o],r[o+1]),16));return Buffer.from(t).toString("utf8")},decoder7:e=>{let r=e.slice(10,-16),t='3SAY~#%Y(V%>5d/Yg"$G[Lh1rK4a;7ok'.split("").map(a=>a.charCodeAt(0)),n=Buffer.from(r,"base64").toString("binary").split("").map(a=>a.charCodeAt(0)).map((a,i)=>a^t[i%t.length]);return String.fromCharCode(...n)},decoder8:e=>{let r={x:"a",y:"b",z:"c",a:"d",b:"e",c:"f",d:"g",e:"h",f:"i",g:"j",h:"k",i:"l",j:"m",k:"n",l:"o",m:"p",n:"q",o:"r",p:"s",q:"t",r:"u",s:"v",t:"w",u:"x",v:"y",w:"z",X:"A",Y:"B",Z:"C",A:"D",B:"E",C:"F",D:"G",E:"H",F:"I",G:"J",H:"K",I:"L",J:"M",K:"N",L:"O",M:"P",N:"Q",O:"R",P:"S",Q:"T",R:"U",S:"V",T:"W",U:"X",V:"Y",W:"Z"};return Array.from(e).map(t=>r[t]||t).join("")},decoder9:e=>r=>{let t=r.split("").reverse().map(n=>n==="-"?"+":n==="_"?"/":n).join(""),s=Buffer.from(t,"base64").toString("binary").split("").map(n=>n.charCodeAt(0)-e);return String.fromCharCode(...s)}},cc={NdonQLf1Tzyx7bMG:W.decoder1,sXnL9MQIry:W.decoder2,IhWrImMIGL:W.decoder3,KJHidj7det:W.decoder7,Oi3v1dAlaM:W.decoder9(5),TsA2KGDGux:W.decoder9(7),JoAHUMCLXV:W.decoder9(3),eSfH1IRMyL:W.decoder6,o2VSUnjnZl:W.decoder8,xTyBxQyGTA:W.decoder4,ux8qjPHC66:W.decoder5};function Oo(e,r){let t=cc[e];if(!t)return console.log(`[Cloudnestra] Unknown decoder ID: ${e}`),null;try{let o=t(r);return!o||!o.includes("http")&&!o.includes(".m3u8")?(console.log(`[Cloudnestra] Decoder ${e} produced invalid result. Length: ${o?.length||0}, Preview: ${o?.substring(0,50)||"empty"}`),null):o}catch(o){return console.log(`[Cloudnestra] Decoder ${e} failed:`,o),null}}function Ro(e){let r=/<div id="([^"]+)" style="display:none;">([^<]+)<\/div>/,t=e.match(r);return t?{id:t[1],content:t[2]}:null}var Io=require("tough-cookie"),$o=require("undici"),Mo=new Io.CookieJar;async function Kr(e,r={}){let{referer:t,origin:o,retries:s=3,delay:n=2e3}=r,a={"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8","Accept-Language":"en-US,en;q=0.5","Accept-Encoding":"gzip, deflate, br",DNT:"1",Connection:"keep-alive","Upgrade-Insecure-Requests":"1","Sec-Fetch-Dest":"document","Sec-Fetch-Mode":"navigate","Sec-Fetch-Site":"none","Cache-Control":"max-age=0"};t&&(a.Referer=t),o&&(a.Origin=o);let i=await Mo.getCookies(e);i.length>0&&(a.Cookie=i.map(l=>`${l.key}=${l.value}`).join("; "));let c=null;for(let l=0;l<s;l++)try{if(l>0){let h=Math.floor(Math.random()*1e3)+n;await new Promise(f=>{setTimeout(f,h)})}let d=await(0,$o.fetch)(e,{headers:a,redirect:"follow"}),u=d.headers.get("set-cookie");if(u){let h=Array.isArray(u)?u:[u];for(let f of h)await Mo.setCookie(f,e)}if(!d.ok){if(d.status===403){c=new Error("Cloudflare blocked (403)");continue}if(d.status===503){c=new Error("Service unavailable (503)");continue}throw new Error(`HTTP ${d.status}: ${d.statusText}`)}let m=await d.text();if(m.includes("cf-turnstile")||m.includes("Checking your browser")||m.includes("cf-challenge")){c=new Error("Cloudflare challenge cannot be bypassed without browser");continue}return m}catch(d){c=d}throw c||new Error("Failed to fetch after multiple retries")}function Po(e){let r=/<script[^>]*>([\s\S]*?)<\/script>/gi,t=[],o=e.matchAll(r);for(let s of o)t.push(s[1]);return t}async function Ao(e){let r=e.media.imdbId;if(!r)throw new p("IMDb ID not found");let t=e.media.type==="show",o,s;if(t){let k=e.media;o=k.season?.number,s=k.episode?.number}let n=t?`https://vidsrc-embed.ru/embed/tv?imdb=${r}&season=${o}&episode=${s}`:`https://vidsrc-embed.ru/embed/${r}`;e.progress(10);let a=await e.proxiedFetcher(n,{headers:{Referer:"https://vidsrc-embed.ru/","User-Agent":"Mozilla/5.0"}});e.progress(30);let i=a.match(/<iframe[^>]*id="player_iframe"[^>]*src="([^"]*)"[^>]*>/);if(!i)throw new p("Initial iframe not found");let c=i[1].startsWith("//")?`https:${i[1]}`:i[1];e.progress(50);let l=await Kr(c,{referer:n,retries:3,delay:3e3}),d=l.match(/src:\s+'(\/prorcp\/[^']+)'/);if(!d){let k=l.match(/file\s*:\s*['"]([^'"]*\.m3u8[^'"]*)['"]/);if(!k)throw new p("Could not find prorcp iframe or direct m3u8 URL - Cloudflare may be blocking");return{stream:[{id:"vidsrc-cloudnestra-0",type:"hls",playlist:k[1],headers:{referer:"https://cloudnestra.com/",origin:"https://cloudnestra.com"},proxyDepth:2,flags:[],captions:[]}],embeds:[]}}let u=`https://cloudnestra.com${d[1]}`;e.progress(70);let m=await Kr(u,{referer:c,retries:3,delay:2e3}),h=Po(m),f="";for(let k of h)if(k.includes("Playerjs")){f=k;break}if(!f)throw new p("No Playerjs config found");let y="",b=f.match(/file\s*:\s*['"]([^'"]+)['"]/);if(b)y=b[1];else{let k=f.match(/file\s*:\s*([a-zA-Z0-9_]+)\s*[,}]/);if(k){let D=k[1],H=m.match(new RegExp(`<div id="${D}"[^>]*>\\s*([^<]+)\\s*</div>`,"s"));if(H){let K=H[1].trim();try{y=Buffer.from(K,"base64").toString("utf-8")}catch{y=K}}else throw new p("No file data found in referenced div")}else throw new p("No file field in Playerjs")}let C=Ro(m);if(C){let k=Oo(C.id,C.content);k&&(k.includes("http")||k.includes(".m3u8"))&&(y=k)}if(!y.includes(".m3u8")&&!y.startsWith("http"))throw new p("Could not decode stream URL - decoder params not found or invalid");let x=y.split(" or "),E=[],L={};for(let k of h){let D=k.match(/v1\s*=\s*['"]([^'"]+)['"]/),H=k.match(/v2\s*=\s*['"]([^'"]+)['"]/),K=k.match(/v3\s*=\s*['"]([^'"]+)['"]/),J=k.match(/v4\s*=\s*['"]([^'"]+)['"]/);D&&(L.v1=D[1]),H&&(L.v2=H[1]),K&&(L.v3=K[1]),J&&(L.v4=J[1])}L.v1||(L.v1="shadowlandschronicles.com");let _={referer:"https://cloudnestra.com/",origin:"https://cloudnestra.com"};for(let k of x){k=k.trim();for(let[D,H]of Object.entries(L))k.includes(`{${D}}`)&&(k=k.replace(new RegExp(`{${D}}`,"g"),H));k.includes("tmstr5")&&(k=k.replace(/tmstr5/g,"tmstr2")),!k.match(/{v\d+}/)&&E.push({id:`vidsrc-cloudnestra-${E.length}`,type:"hls",playlist:k,headers:_,proxyDepth:2,flags:[],captions:[]})}if(e.progress(90),E.length===0)throw new p("No valid streams found");return{stream:E,embeds:[]}}var Fo=S({id:"cloudnestra",name:"Cloudnestra",rank:180,flags:[],scrapeMovie:Ao,scrapeShow:Ao});var lc="https://api2.vidsrc.vip";function dc(e){return["a","b","c","d","e","f","g","h","i","j"][parseInt(e,10)]}function pc(e,r,t,o){let s;r==="show"&&t&&o?s=`${e}-${t}-${o}`:s=e.split("").map(dc).join("");let n=s.split("").reverse().join("");return btoa(btoa(n))}async function Lo(e){let r=e.media.type==="show"?"tv":"movie",t=pc(e.media.tmdbId,e.media.type,e.media.type==="show"?e.media.season.number:void 0,e.media.type==="show"?e.media.episode.number:void 0),o=`${lc}/${r}/${t}`,s=await e.proxiedFetcher(o);if(!s||!s.source1)throw new p("No sources found");let n=[],a=["vidsrc-comet","vidsrc-pulsar","vidsrc-nova"],i=0;for(let c=1;s[`source${c}`];c++){let l=s[`source${c}`];l?.url&&(n.push({embedId:a[i%a.length],url:l.url}),i++)}if(n.length===0)throw new p("No embeds found");return{embeds:n}}var Uo=S({id:"vidsrcvip",name:"VidSrc.vip",rank:150,disabled:!0,flags:[g.CORS_ALLOWED],scrapeMovie:Lo,scrapeShow:Lo});var Ge=require("cheerio"),_o=require("unpacker");var Pe="https://zoechip.org";function To(e){return e.toLowerCase().replace(/[^a-z0-9\s-]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").trim()}async function uc(e,r){let t={Referer:Pe,"User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36"},s=(await e.proxiedFetcher.full(r,{method:"HEAD",headers:t})).finalUrl;if(!s)return null;let n=await e.proxiedFetcher(s,{headers:t}),i=(0,Ge.load)(n)("iframe").attr("src");if(!i)throw new p("No iframe URL found");let l=(await e.proxiedFetcher(i,{headers:t})).match(/eval\(function\(p,a,c,k,e,.*\)\)/i);if(!l)throw new p("No packed JavaScript found");let u=(0,_o.unpack)(l[0]).match(/file\s*:\s*"([^"]+)"/i);if(!u)throw new p("No file URL found in unpacked JavaScript");return u[1]}async function No(e){let r={Referer:Pe,"User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36"},t,o;if(e.media.type==="movie"){let h=To(e.media.title);t=`${Pe}/film/${h}-${e.media.releaseYear}`}else{let h=To(e.media.title);t=`${Pe}/episode/${h}-season-${e.media.season.number}-episode-${e.media.episode.number}`}e.progress(20);let s=await e.proxiedFetcher(t,{headers:r}),n=(0,Ge.load)(s);if(o=n("div#show_player_ajax").attr("movie-id"),!o){let h=n("[data-movie-id]").attr("data-movie-id")||n("[movie-id]").attr("movie-id")||n(".player-wrapper").attr("data-id");if(h)o=h;else throw new p(`No content found for ${e.media.type==="movie"?"movie":"episode"}`)}e.progress(40);let a=`${Pe}/wp-admin/admin-ajax.php`,i={...r,"X-Requested-With":"XMLHttpRequest","Content-Type":"application/x-www-form-urlencoded; charset=UTF-8",Referer:t},c=new URLSearchParams({action:"lazy_player",movieID:o}),l=await e.proxiedFetcher(a,{method:"POST",headers:i,body:c.toString()}),d=(0,Ge.load)(l),u=d("ul.nav a:contains(Filemoon)").attr("data-server");if(!u)throw d("ul.nav a").map((f,y)=>({name:d(y).text().trim(),url:d(y).attr("data-server")})).get().length===0?new p("No streaming servers found"):new p("Filemoon server not available");e.progress(60);let m=await uc(e,u);if(!m)throw new p("Failed to extract file URL from streaming server");return e.progress(90),{stream:[{id:"primary",type:"hls",playlist:m,flags:[g.CORS_ALLOWED],captions:[]}],embeds:[]}}var Do=S({id:"zoechip",name:"ZoeChip",rank:170,disabled:!0,flags:[],scrapeMovie:No,scrapeShow:No});var mc=["pahe","zoro","zaza","meg","bato"],fc="https://backend.animetsu.to",qo={referer:"https://animetsu.to/",origin:"https://backend.animetsu.to",accept:"application/json, text/plain, */*","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"};function hc(e,r=100){return v({id:`animetsu-${e}`,name:`${e.charAt(0).toUpperCase()+e.slice(1)}`,rank:r,async scrape(t){let o=e,s=JSON.parse(t.url),{type:n,animetsuId:a,episode:i}=s;if(n!=="movie"&&n!=="show")throw new p("Unsupported media type");let c=await t.proxiedFetcher("/api/anime/tiddies",{baseUrl:fc,headers:qo,query:{server:o,id:String(a),num:String(i??1),subType:"dub"}});console.log("Animetsu API Response:",JSON.stringify(c,null,2));let l=c?.sources?.[0];if(!l?.url)throw new p("No source URL found");let d=l.url,u=l.type,m=l.quality,h={...qo};if(d.includes("animetsu.cc")){let{referer:f,origin:y,...b}=h;h={...b,origin:"https://backend.animetsu.cc",referer:"https://backend.animetsu.cc/"}}if(t.progress(100),u==="mp4"){let f="unknown";if(m){let y=m.match(/(\d+)p?/);y&&(f=parseInt(y[1],10))}return{stream:[{id:"primary",captions:[],qualities:{[f]:{type:"mp4",url:d}},type:"file",headers:h,flags:[]}]}}return{stream:[{id:"primary",type:"hls",playlist:d,headers:h,flags:[],captions:[]}]}}})}var Bo=mc.map((e,r)=>hc(e,300-r));var gc=[{id:"autoembed-english",rank:10},{id:"autoembed-hindi",rank:9,disabled:!0},{id:"autoembed-tamil",rank:8,disabled:!0},{id:"autoembed-telugu",rank:7,disabled:!0},{id:"autoembed-bengali",rank:6,disabled:!0}];function yc(e){return v({id:e.id,name:e.id.split("-").map(r=>r[0].toUpperCase()+r.slice(1)).join(" "),disabled:e.disabled,rank:e.rank,async scrape(r){return{stream:[{id:"primary",type:"hls",playlist:r.url,flags:[g.CORS_ALLOWED],captions:[]}]}}})}var[jo,Ho,Wo,zo,Vo]=gc.map(yc);var bc=atob("aHR0cHM6Ly9jaW5lbWFvcy12My52ZXJjZWwuYXBwL2FwaS9uZW8vYmFja2VuZGZldGNo");function Sc(e,r){return v({id:`cinemaos-${e}`,name:`${e.charAt(0).toUpperCase()+e.slice(1)}`,rank:r,disabled:!0,async scrape(t){let o=JSON.parse(t.url),{tmdbId:s,type:n,season:a,episode:i}=o,c=`${bc}?requestID=${n==="show"?"tvVideoProvider":"movieVideoProvider"}&id=${s}&service=${e}`;n==="show"&&(c+=`&season=${a}&episode=${i}`);let l=await t.proxiedFetcher(c),u=(typeof l=="string"?JSON.parse(l):l)?.data?.sources;if(!u||!Array.isArray(u)||u.length===0)throw new p("No sources found");if(t.progress(80),u.length===1)return{stream:[{id:"primary",type:"hls",playlist:u[0].url,flags:[g.CORS_ALLOWED],captions:[]}]};let m={};for(let h of u){let f=(h.quality||h.source||"unknown").toString(),y;f==="4K"?y=2160:y=parseInt(f.replace("P",""),10),!(Number.isNaN(y)||m[y])&&(m[y]={type:"mp4",url:h.url})}return{stream:[{id:"primary",type:"file",flags:[g.CORS_ALLOWED],qualities:m,captions:[]}]}}})}var wc=["shadow","asiacloud","ophim"],Ko=wc.map((e,r)=>Sc(e,300-r));function vc(e,r=100){return v({id:`cinemaos-hexa-${e}`,name:`Hexa ${e.charAt(0).toUpperCase()+e.slice(1)}`,disabled:!0,rank:r,async scrape(t){let s=JSON.parse(t.url).directUrl;if(!s)throw new p("No directUrl provided for Hexa embed");return{stream:[{id:"primary",type:"hls",playlist:O(s,{referer:"https://megacloud.store/",origin:"https://megacloud.store"}),flags:[g.CORS_ALLOWED],captions:[]}]}}})}var Ec=["alpha","bravo","charlie","delta","echo","foxtrot","golf","hotel","india"],tm=Ec.map((e,r)=>vc(e,315-r));var Jo=require("cheerio"),Go=require("unpacker");function kc(e){let r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",t=e.replace(/=+$/,""),o="";if(t.length%4===1)throw new Error("The string to be decoded is not correctly encoded.");for(let s=0,n=0,a=0;a<t.length;a++){let i=t.charAt(a),c=r.indexOf(i);c!==-1&&(n=s%4?n*64+c:c,s++%4&&(o+=String.fromCharCode(255&n>>(-2*s&6))))}return o}function Cc(e){let t=e.join("");t=atob(t),t=t.replace(/[a-zA-Z]/g,function(n){let i=n.charCodeAt(0)+13,c=n<="Z"?90:122;return String.fromCharCode(i<=c?i:i-26)}),t=t.split("").reverse().join("");let o="";for(let s=0;s<t.length;s++){let n=t.charCodeAt(s);n=(n-399756995%(s+5)+256)%256,o+=String.fromCharCode(n)}return o}var xc="https://ridomovies.tv/",Ye=v({id:"closeload",name:"CloseLoad",rank:106,async scrape(e){let r=new URL(e.url).origin,t=await e.proxiedFetcher(e.url,{headers:{referer:xc}}),o=(0,Jo.load)(t),s=o("track").map((d,u)=>{let m=o(u),h=`${r}${m.attr("src")}`,f=m.attr("label")??"",y=q(f),b=me(h);return!y||!b?null:{id:h,language:y,hasCorsRestrictions:!0,type:b,url:h}}).get().filter(d=>d!==null),n=o("script").filter((d,u)=>{let m=o(u);return(m.attr("type")==="text/javascript"&&m.html()?.includes("p,a,c,k,e,d"))??!1}).html();if(!n)throw new Error("Couldn't find eval code");let a=(0,Go.unpack)(n),i,c=a.match(/dc_\w+\(\[([^\]]+)\]\)/);if(c){let u=c[1].match(/"([^"]+)"/g);if(u){let m=u.map(h=>h.slice(1,-1));try{let h=Cc(m);(h.startsWith("http://")||h.startsWith("https://"))&&(i=h)}catch{}}}if(!i){let d=[/var\s+(\w+)\s*=\s*"([^"]+)";/g,/(\w+)\s*=\s*"([^"]+)"/g,/"([A-Za-z0-9+/=]+)"/g];for(let u of d){let m=u.exec(a);if(m){let h=m[2]||m[1];if(/^[A-Za-z0-9+/]*={0,2}$/.test(h)&&h.length>10){i=h;break}}}}if(!i)throw new p("Unable to find source url");let l;if(i.startsWith("http://")||i.startsWith("https://"))l=i;else{if(!/^[A-Za-z0-9+/]*={0,2}$/.test(i))throw new p("Invalid base64 encoding found in source url");let u;try{u=atob(i)}catch{try{u=kc(i)}catch{throw new p(`Failed to decode base64 source url: ${i.substring(0,50)}...`)}}let m=u.match(/(https?:\/\/[^\s"']+)/);if(m)l=m[1];else if(u.startsWith("http://")||u.startsWith("https://"))l=u;else throw new p(`Decoded string is not a valid URL: ${u.substring(0,100)}...`)}return{stream:[{id:"primary",type:"hls",playlist:l,captions:s,flags:[g.IP_LOCKED],headers:{Referer:"https://closeload.top/",Origin:"https://closeload.top"}}]}}});var Xe="madplay.site",Q={referer:"https://madplay.site/",origin:"https://madplay.site","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"},Yo=v({id:"madplay-base",name:"Base",rank:134,async scrape(e){let r=JSON.parse(e.url),{type:t,tmdbId:o,season:s,episode:n}=r,a=`https://${Xe}/api/playsrc`;t==="movie"?a+=`?id=${o}`:t==="show"&&(a+=`?id=${o}&season=${s}&episode=${n}`);let i=await e.proxiedFetcher(a,{headers:Q});if(console.log(i),!Array.isArray(i)||i.length===0)throw new p("No streams found");let c=i[0];if(!c.file)throw new p("No file URL found in stream");return e.progress(100),{stream:[{id:"primary",type:"hls",playlist:O(c.file,Q),flags:[g.CORS_ALLOWED],captions:[]}]}}}),Xo=v({id:"madplay-nsapi",name:"Northstar",rank:133,async scrape(e){let r=JSON.parse(e.url),{type:t,tmdbId:o,season:s,episode:n}=r,a=`https://${Xe}/api/nsapi/vid`;t==="movie"?a+=`?id=${o}`:t==="show"&&(a+=`?id=${o}&season=${s}&episode=${n}`);let i=await e.proxiedFetcher(a,{headers:Q});if(console.log(i),!Array.isArray(i)||i.length===0)throw new p("No streams found");let c=i[0];if(!c.url)throw new p("No file URL found in stream");return e.progress(100),{stream:[{id:"primary",type:"hls",playlist:O(c.url,c.headers||Q),flags:[g.CORS_ALLOWED],captions:[]}]}}}),Zo=v({id:"madplay-roper",name:"Roper",rank:132,async scrape(e){let r=JSON.parse(e.url),{type:t,tmdbId:o,season:s,episode:n}=r,a=`https://${Xe}/api/roper/`;t==="movie"?a+=`?id=${o}&type=movie`:t==="show"&&(a+=`?id=${o}&season=${s}&episode=${n}&type=series`);let i=await e.proxiedFetcher(a,{headers:Q});if(console.log(i),!Array.isArray(i)||i.length===0)throw new p("No streams found");let c=i[0];if(!c.url)throw new p("No file URL found in stream");return e.progress(100),{stream:[{id:"primary",type:"hls",playlist:O(c.url,c.headers||Q),flags:[g.CORS_ALLOWED],captions:[]}]}}}),Qo=v({id:"madplay-vidfast",name:"Vidfast",rank:131,async scrape(e){let r=JSON.parse(e.url),{type:t,tmdbId:o,season:s,episode:n}=r,a=`https://${Xe}/api/nsapi/test?url=https://vidfast.pro/`;t==="movie"?a+=`/movie/${o}`:t==="show"&&(a+=`/tv/${o}/${s}/${n}`);let i=await e.proxiedFetcher(a,{headers:Q});if(console.log(i),!Array.isArray(i)||i.length===0)throw new p("No streams found");let c=i[0];if(!c.url)throw new p("No file URL found in stream");return e.progress(100),{stream:[{id:"primary",type:"hls",playlist:O(c.url,c.headers||Q),flags:[g.CORS_ALLOWED],captions:[]}]}}});var Oc=[{id:"mp4hydra-1",name:"MP4Hydra Server 1",rank:36},{id:"mp4hydra-2",name:"MP4Hydra Server 2",rank:35,disabled:!0}];function Rc(e){return v({id:e.id,name:e.name,disabled:!0,rank:e.rank,async scrape(r){let[t,o]=r.url.split("|");return{stream:[{id:"primary",type:"file",qualities:{[he(o||"")]:{url:t,type:"mp4"}},flags:[g.CORS_ALLOWED],captions:[]}]}}})}var[es,rs]=Oc.map(Rc);var Mc="https://ridomovies.tv/",Ic={referer:"https://ridoo.net/",origin:"https://ridoo.net"},Ze=v({id:"ridoo",name:"Ridoo",rank:121,async scrape(e){let r=await e.proxiedFetcher(e.url,{headers:{referer:Mc}}),o=/file:"([^"]+)"/g.exec(r)?.[1];if(!o)throw new p("Unable to find source url");return{stream:[{id:"primary",type:"hls",playlist:o,headers:Ic,captions:[],flags:[g.CORS_ALLOWED]}]}}});var $c=[{id:"streamtape",name:"Streamtape",rank:160},{id:"streamtape-latino",name:"Streamtape (Latino)",rank:159}];function Pc(e){return v({id:e.id,name:e.name,rank:e.rank,async scrape(r){let o=(await r.proxiedFetcher(r.url)).match(/robotlink'\).innerHTML = (.*)'/);if(!o)throw new Error("No match found");let[s,n]=o?.[1]?.split("+ ('")??[];if(!s||!n)throw new Error("No match found");let a=`https:${s?.replace(/'/g,"").trim()}${n?.substring(3).trim()}`;return{stream:[{id:"primary",type:"file",flags:[g.CORS_ALLOWED,g.IP_LOCKED],captions:[],qualities:{unknown:{type:"mp4",url:a}},headers:{Referer:"https://streamtape.com"}}]}}})}var[ts,os]=$c.map(Pc);var ss=P(require("unpacker"),1);var Ac=/(eval\(function\(p,a,c,k,e,d\).*\)\)\))/,Fc=/src:"(https:\/\/[^"]+)"/,ns=v({id:"streamvid",name:"Streamvid",rank:215,async scrape(e){let t=(await e.proxiedFetcher(e.url)).match(Ac);if(!t)throw new Error("streamvid packed not found");let s=ss.unpack(t[1]).match(Fc);if(!s)throw new Error("streamvid link not found");return{stream:[{type:"hls",id:"primary",playlist:s[1],flags:[g.CORS_ALLOWED],captions:[]}]}}});var Jr=class{constructor(r){this.ALPHABET={62:"0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",95:"' !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~'"};this.dictionary={};if(this.base=r,r>36&&r<62&&(this.ALPHABET[r]=this.ALPHABET[r]||this.ALPHABET[62].substring(0,r)),r>=2&&r<=36)this.unbase=t=>parseInt(t,r);else{try{[...this.ALPHABET[r]].forEach((t,o)=>{this.dictionary[t]=o})}catch{throw new Error("Unsupported base encoding.")}this.unbase=this._dictunbaser.bind(this)}}_dictunbaser(r){let t=0;return[...r].reverse().forEach((o,s)=>{t+=this.base**s*this.dictionary[o]}),t}};function Lc(e){let r=[/}\('(.*)', *(\d+|\[\]), *(\d+), *'(.*)'\.split\('\|'\), *(\d+), *(.*)\)\)/,/}\('(.*)', *(\d+|\[\]), *(\d+), *'(.*)'\.split\('\|'\)/];for(let t of r){let o=t.exec(e);if(o)try{return{payload:o[1],symtab:o[4].split("|"),radix:parseInt(o[2],10),count:parseInt(o[3],10)}}catch{throw new Error("Corrupted p.a.c.k.e.r. data.")}}throw new Error("Could not make sense of p.a.c.k.e.r data (unexpected code structure)")}function Uc(e){let{payload:r,symtab:t,radix:o,count:s}=Lc(e);if(s!==t.length)throw new Error("Malformed p.a.c.k.e.r. symtab.");let n;try{n=new Jr(o)}catch{throw new Error("Unknown p.a.c.k.e.r. encoding.")}let a=c=>{let l=c;return(o===1?t[parseInt(l,10)]:t[n.unbase(l)])||l},i=r.replace(/\b\w+\b/g,a);return i}var Tc=[{id:"streamwish-japanese",name:"StreamWish (Japanese Sub Espa\xF1ol)",rank:171},{id:"streamwish-latino",name:"streamwish (latino)",rank:170},{id:"streamwish-spanish",name:"streamwish (castellano)",rank:169},{id:"streamwish-english",name:"streamwish (english)",rank:168}];function Nc(e){return v({id:e.id,name:e.name,rank:e.rank,async scrape(r){let t={Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8","Accept-Encoding":"*","Accept-Language":"en-US,en;q=0.9","User-Agent":"Mozilla/5.0"},o;try{o=await r.proxiedFetcher(r.url,{headers:t})}catch(d){throw console.error("Error details:",{message:d instanceof Error?d.message:"Unknown error",cause:d.cause||void 0,url:r.url}),d}let s=o.match(/<script[^>]*>\s*(eval\(function\(p,a,c,k,e,d.*?\)[\s\S]*?)<\/script>/);if(!s)return{stream:[],embeds:[{embedId:e.id,url:r.url}]};let n;try{n=Uc(s[1])}catch{return{stream:[],embeds:[{embedId:e.id,url:r.url}]}}let i=Array.from(n.matchAll(/"(hls2|hls4)"\s*:\s*"([^"]*\.m3u8[^"]*)"/g)).map(d=>({key:d[1],url:d[2]}));if(!i.length)return{stream:[],embeds:[{embedId:e.id,url:r.url}]};let c=i[0].url;/^https?:\/\//.test(c)||(c=`https://swiftplayers.com/${c.replace(/^\/+/g,"")}`);try{let d=await r.proxiedFetcher(c,{headers:{Referer:r.url}}),u=Array.from(d.matchAll(/#EXT-X-STREAM-INF:[^\n]+\n(?!iframe)([^\n]*index[^\n]*\.m3u8[^\n]*)/gi));if(u.length>0){let m=u.find(f=>/#EXT-X-STREAM-INF/.test(f.input||""))||u[0];c=c.substring(0,c.lastIndexOf("/")+1)+m[1]}}catch{}let l={Referer:r.url,Origin:r.url};return{stream:[{id:"primary",type:"hls",playlist:O(c,l),flags:[g.CORS_ALLOWED],captions:[]}],embeds:[]}}})}var[as,is,cs,ls]=Tc.map(Nc);var ds=v({id:"vidcloud",name:"VidCloud",rank:201,disabled:!0,async scrape(e){return{stream:(await Ve.scrape(e)).stream.map(t=>({...t,flags:[]}))}}});var us=["alfa","bravo","charlie","delta","echo","foxtrot","golf","hotel","india","juliett"],_c="api.vidify.top",Qe="https://player.vidify.top/",er=null,ps=0;async function Dc(e){let r=Date.now();if(er&&r-ps<1e3*60*60)return er;let t=await e.proxiedFetcher(Qe,{headers:{Referer:Qe}}),o=/\/assets\/index-([a-zA-Z0-9-]+)\.js/,s=t.match(o);if(!s)throw new Error("Could not find the JS file URL in the player page");let n=new URL(s[0],Qe).href,a=await e.proxiedFetcher(n,{headers:{Referer:Qe}}),i=/Authorization:"Bearer\s*([^"]+)"/,c=a.match(i);if(!c||!c[1])throw new Error("Could not extract the authorization header from the JS file");return er=`Bearer ${c[1]}`,ps=r,er}function qc(e,r=100){let t=us.indexOf(e)+1;return v({id:`vidify-${e}`,name:`${e.charAt(0).toUpperCase()+e.slice(1)}`,rank:r,disabled:!0,async scrape(o){let s=JSON.parse(o.url),{type:n,tmdbId:a,season:i,episode:c}=s,l=`https://${_c}/`;if(n==="movie")l+=`/movie/${a}?sr=${t}`;else if(n==="show")l+=`/tv/${a}/season/${i}/episode/${c}?sr=${t}`;else throw new p("Unsupported media type");let u={referer:"https://player.vidify.top/",origin:"https://player.vidify.top",Authorization:await Dc(o),"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"},m=await o.proxiedFetcher(l,{headers:u});console.log(m);let h=m.m3u8??m.url;if(Array.isArray(m.result)&&m.result.length>0){let b={};if(m.result.forEach(C=>{C.url.includes(".mp4")&&(b[`${C.resolution}p`]={type:"mp4",url:decodeURIComponent(C.url)})}),Object.keys(b).length===0)throw new p("No MP4 streams found");return console.log("Found MP4 streams: ",b),{stream:[{id:"primary",type:"file",qualities:b,flags:[],captions:[],headers:{Host:"proxy-worker.himanshu464121.workers.dev"}}]}}if(!h)throw new p("No playlist URL found");let f={...u},y;return h.includes("proxyv1.vidify.top")?(console.log("Found stream (proxyv1): ",h,f),f.Host="proxyv1.vidify.top",y=decodeURIComponent(h)):h.includes("proxyv2.vidify.top")?(console.log("Found stream (proxyv2): ",h,f),f.Host="proxyv2.vidify.top",y=decodeURIComponent(h)):(console.log("Found normal stream: ",h),y=O(decodeURIComponent(h),f)),o.progress(100),{stream:[{id:"primary",type:"hls",playlist:y,headers:f,flags:[],captions:[]}]}}})}var ms=us.map((e,r)=>qc(e,230-r));var fs=v({id:"vidnest-hollymoviehd",name:"HollyMovie",rank:104,async scrape(e){let r=await e.proxiedFetcher(e.url);if(!r.success||!r.sources)throw new p("No streams found");let t=[];for(let o of r.sources)o.file.includes("pkaystream.cc/pl/")&&t.push({id:`hollymoviehd-${o.label}`,type:"hls",playlist:O(o.file),flags:[g.CORS_ALLOWED],captions:[]});return{stream:t}}}),hs=v({id:"vidnest-allmovies",name:"AllMovies (Hindi)",rank:103,async scrape(e){let r=await e.proxiedFetcher(e.url);if(!r.streams)throw new p("No streams found");let t=[];for(let o of r.streams)t.push({id:`allmovies-${o.language}`,type:"hls",playlist:o.url,flags:[g.CORS_ALLOWED],captions:[],preferredHeaders:o.headers});return{stream:t}}}),gs=v({id:"vidnest-flixhq",name:"FlixHQ",rank:102,disabled:!0,async scrape(){throw new Error("Not implemented")}}),ys=v({id:"vidnest-official",name:"Official",rank:101,disabled:!0,async scrape(){throw new Error("Not implemented")}});var Bc=[{id:"server-13",rank:112},{id:"server-18",rank:111},{id:"server-11",rank:102},{id:"server-7",rank:92},{id:"server-10",rank:82},{id:"server-1",rank:72},{id:"server-16",rank:64},{id:"server-3",rank:62},{id:"server-17",rank:52},{id:"server-2",rank:42},{id:"server-4",rank:32},{id:"server-5",rank:24},{id:"server-14",rank:22},{id:"server-6",rank:21},{id:"server-15",rank:20},{id:"server-8",rank:19},{id:"server-9",rank:18},{id:"server-19",rank:17},{id:"server-12",rank:16}];function jc(e){return v({id:e.id,name:e.name||e.id.split("-").map(r=>r[0].toUpperCase()+r.slice(1)).join(" "),disabled:!0,rank:e.rank,async scrape(r){return{stream:[{id:"primary",type:"hls",playlist:r.url,flags:[g.CORS_ALLOWED],captions:[]}]}}})}var[bs,Ss,ws,vs,Es,ks,Cs,xs,Os,Rs,Ms,Is,$s]=Bc.map(jc);var Ps=v({id:"viper",name:"Viper",rank:182,disabled:!0,async scrape(e){let r=await e.proxiedFetcher.full(e.url,{headers:{Accept:"application/json",Referer:"https://embed.su/"}});if(!r.body.source)throw new p("No source found");let t=r.body.source.replace(/^.*\/viper\//,"https://");return{stream:[{type:"hls",id:"primary",playlist:O(t,{referer:"https://megacloud.store/",origin:"https://megacloud.store"}),flags:[g.CORS_ALLOWED],captions:[]}]}}});async function Hc(e,r){let t=await e.proxiedFetcher("https://cloud.mail.ru/public/uaRH/2PYWcJRpH"),s=/"videowl_view":\{"count":"(\d+)","url":"([^"]+)"\}/g.exec(t)?.[2];if(!s)throw new p("Failed to get videoOwlUrl");return`${s}/0p/${btoa(r)}.m3u8?${new URLSearchParams({double_encode:"1"})}`}var rr=v({id:"warezcdnembedhls",name:"WarezCDN HLS",disabled:!0,rank:83,async scrape(e){let r=await je(e);if(!r)throw new p("can't get file id");let t=await Hc(e,r);return{stream:[{id:"primary",type:"hls",flags:[g.IP_LOCKED],captions:[],playlist:t}]}}});var tr=v({id:"warezplayer",name:"warezPLAYER",disabled:!0,rank:85,async scrape(e){let r=new URL(e.url),t=r.pathname.split("/")[2],o=await e.proxiedFetcher("/player/index.php",{baseUrl:r.origin,query:{data:t,do:"getVideo"},method:"POST",body:new URLSearchParams({hash:t}),headers:{"X-Requested-With":"XMLHttpRequest"}}),s=JSON.parse(o);if(!s.videoSource)throw new Error("Playlist not found");return{stream:[{id:"primary",type:"hls",flags:[],captions:[],playlist:s.videoSource,headers:{Accept:"*/*"}}]}}});var As=require("cheerio");var Fs=v({id:"wecima-embed",name:"Wecima Embed",rank:90,async scrape(e){let r=await e.proxiedFetcher(e.url),t=(0,As.load)(r),o,s=t("script");for(let n of s){let a=t(n).html()||"",i=a.match(/https?:\/\/[^"']+\/master\.m3u8/);if(i){o=i[0];break}let c=a.match(/https?:\/\/fdewsdc\.sbs\/stream\/[^"']+\/master\.m3u8/);if(c){o=c[0];break}}if(!o){let n=t("video, source, div[data-src], div[data-url]");for(let a of n){let i=t(a).attr("src")||t(a).attr("data-src")||t(a).attr("data-url");if(i&&i.includes("master.m3u8")){o=i;break}}}if(!o)throw new Error("No HLS stream URL found in wecima embed");return{stream:[{id:"primary",type:"hls",flags:[g.IP_LOCKED],captions:[],playlist:o,headers:{Referer:e.url,Origin:new URL(e.url).origin}}]}}});var Wc=["hd-2","miko","shiro","zaza"],zc="https://vidnest.fun",or={referer:"https://vidnest.fun/",origin:"https://vidnest.fun","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"};function Vc(e,r=100){return v({id:`zunime-${e}`,name:`${e.charAt(0).toUpperCase()+e.slice(1)}`,rank:r,async scrape(t){let o=e,s=t.url,n="",a={};if(s.includes("/movie/")){let m=s.split("/movie/")[1];n="/api/movie",a={tmdb:m,server:o}}else if(s.includes("/tv/")){let m=s.split("/tv/")[1].split("/"),h=m[0],f=m[1]||"1",y=m[2]||"1";n="/api/tv",a={tmdb:h,season:f,episode:y,server:o}}else if(s.includes("/anime/")){let m=s.split("/anime/")[1].split("/"),h=m[0],f=m[1]||"1",y=m[2]||"dub";n="/api/anime",a={anilist:h,episode:f,server:o,type:y}}else throw new p("Invalid embed URL format");let i=await t.proxiedFetcher(n,{baseUrl:zc,headers:or,query:a});console.log("API Response:",i);let c=i,l=null,d=or;if(c?.success&&c?.sources?.url?(l=c.sources.url,d=c?.sources?.headers||or):c?.url?l=c.url:c?.stream?.url?(l=c.stream.url,d=c?.stream?.headers||or):typeof c=="string"&&c.startsWith("http")&&(l=c),!l)throw new p("No stream URL found in response");let u=l;return!l.includes("proxy.vidnest.fun")&&!l.includes("proxy-2.madaraverse.online")&&(u=`https://proxy-2.madaraverse.online/proxy?url=${encodeURIComponent(l)}`),t.progress(100),{stream:[{id:"primary",type:"hls",playlist:u,headers:d,flags:[],captions:[]}]}}})}var Ls=Wc.map((e,r)=>Vc(e,260-r));var Us=P(require("cheerio"),1);async function sr(e,r){try{let t="https://ftmoh345xme.com",o={Origin:"https://friness-cherlormur-i-275.site",Referer:"https://google.com/",Dnt:"1"},s=`${t}/play/${r}`,n=await e.proxiedFetcher(s,{headers:{...o},method:"GET"}),i=Us.load(n)("script").last().html();if(!i)throw new p("Failed to extract script data");let c=i.match(/(\{[^;]+});/)?.[1]||i.match(/\((\{.*\})\)/)?.[1];if(!c)throw new p("Media not found");let l=JSON.parse(c),d=l.file;if(!d)throw new p("File not found");d.startsWith("/")&&(d=t+d);let u=l.key,m={Origin:"https://friness-cherlormur-i-275.site",Referer:"https://google.com/",Dnt:"1","X-Csrf-Token":u};return{success:!0,data:{playlist:await e.proxiedFetcher(d,{headers:{...m},method:"GET"}),key:u}}}catch(t){throw t instanceof p?t:new p("Failed to fetch media info")}}async function nr(e,r,t){let s=`${r.slice(1)}.txt`;try{let n="https://ftmoh345xme.com",a={Origin:"https://friness-cherlormur-i-275.site",Referer:"https://google.com/",Dnt:"1","X-Csrf-Token":t},i=`${n}/playlist/${s}`;return{success:!0,data:{link:await e.proxiedFetcher(i,{headers:{...a},method:"GET"})}}}catch{throw new p("Failed to fetch stream data")}}async function Ts(e,r,t="English"){try{let o=await sr(e,r);if(o?.success){let s=o?.data?.playlist;if(!s||!Array.isArray(s))throw new p("Playlist not found or invalid");let n=s.find(l=>l?.title===t);if(n||(n=s?.[0]),!n)throw new p("No file found");let a=s.map(l=>l?.title),i=o?.data?.key;e.progress(70);let c=await nr(e,n?.file,i);if(c?.success)return{success:!0,data:c?.data,availableLang:a};throw new p("No stream url found")}throw new p("No media info found")}catch(o){throw o instanceof p?o:new p("Failed to fetch movie data")}}async function Ns(e,r,t,o,s){try{let n=await sr(e,r);if(!n?.success)throw new p("No media info found");let i=(n?.data?.playlist).find(f=>f?.id===t.toString());if(!i)throw new p("No season found");let c=i?.folder.find(f=>f?.episode===o.toString());if(!c)throw new p("No episode found");let l=c?.folder.find(f=>f?.title===s);if(l||(l=c?.folder?.[0]),!l)throw new p("No file found");let u=(c?.folder.map(f=>f?.title)).filter(f=>f?.length>0),m=n?.data?.key;e.progress(70);let h=await nr(e,l?.file,m);if(h?.success)return{success:!0,data:h?.data,availableLang:u};throw new p("No stream url found")}catch(n){throw n instanceof p?n:new p("Failed to fetch TV data")}}async function _s(e){let r={title:e.media.title,releaseYear:e.media.releaseYear,tmdbId:e.media.tmdbId,imdbId:e.media.imdbId,type:e.media.type,season:"",episode:""};if(e.media.type==="show"&&(r.season=e.media.season.number.toString(),r.episode=e.media.episode.number.toString()),e.media.type==="movie"){e.progress(40);let t=await Ts(e,e.media.imdbId);if(t?.success)return e.progress(90),{embeds:[],stream:[{id:"primary",captions:[],playlist:t.data.link,type:"hls",flags:[g.CORS_ALLOWED]}]};throw new p("No providers available")}if(e.media.type==="show"){e.progress(40);let o=await Ns(e,e.media.imdbId,e.media.season.number,e.media.episode.number,"English");if(o?.success)return e.progress(90),{embeds:[],stream:[{id:"primary",captions:[],playlist:o.data.link,type:"hls",flags:[g.CORS_ALLOWED]}]};throw new p("No providers available")}throw new p("No providers available")}var Ds=S({id:"8stream",name:"8stream",rank:111,flags:[],disabled:!0,scrapeMovie:_s,scrapeShow:_s});var Ae=require("cheerio");var ar="https://www3.animeflv.net";async function Kc(e,r){let t=`${ar}/browse?q=${encodeURIComponent(r)}`,o=await e.proxiedFetcher(t),s=(0,Ae.load)(o),n=s("div.Container ul.ListAnimes li article");if(!n.length)throw new p("No se encontr\xF3 el anime en AnimeFLV");let a="";if(n.each((c,l)=>{if(s(l).find("a h3").text().trim().toLowerCase()===r.trim().toLowerCase())return a=s(l).find("div.Description a.Button").attr("href")||"",!1}),a||(a=n.first().find("div.Description a.Button").attr("href")||""),!a)throw new p("No se encontr\xF3 el anime en AnimeFLV");return a.startsWith("http")?a:`${ar}${a}`}async function Jc(e,r){let t=await e.proxiedFetcher(r),o=(0,Ae.load)(t),s=[];return o("script").each((n,a)=>{let i=o(a).html()||"";if(i.includes("var anime_info =")){let l=i.split("var anime_info = [")[1]?.split("];")[0]?.split(",")[2]?.replace(/"/g,"").trim(),d=i.split("var episodes = [")[1]?.split("];")[0];l&&d?s=d.split("],[").map(m=>{let h=m.replace("[","").replace("]","").split(",")[0];return{number:parseInt(h,10),url:`${ar}/ver/${l}-${h}`}}):console.log("[AnimeFLV] No se encontr\xF3 animeUri o lista de episodios en el script")}}),s.length===0&&console.log("[AnimeFLV] No se encontraron episodios"),s}async function Gc(ctx,episodeUrl){let html=await ctx.proxiedFetcher(episodeUrl),$=(0,Ae.load)(html),script=$('script:contains("var videos =")').html();if(!script)return{};let match=script.match(/var videos = (\{[\s\S]*?\});/);if(!match)return{};let videos={};try{videos=eval(`(${match[1]})`)}catch{return{}}let streamwishJapanese;if(videos.SUB){let e=videos.SUB.find(r=>r.title?.toLowerCase()==="sw");e&&(e.url||e.code)&&(streamwishJapanese=e.url||e.code,streamwishJapanese&&streamwishJapanese.startsWith("/e/")&&(streamwishJapanese=`https://streamwish.to${streamwishJapanese}`))}let streamtapeLatino;if(videos.LAT){let e=videos.LAT.find(r=>r.title?.toLowerCase()==="stape"||r.title?.toLowerCase()==="streamtape");e&&(e.url||e.code)&&(streamtapeLatino=e.url||e.code,streamtapeLatino&&streamtapeLatino.startsWith("/e/")&&(streamtapeLatino=`https://streamtape.com${streamtapeLatino}`))}return{"streamwish-japanese":streamwishJapanese,"streamtape-latino":streamtapeLatino}}async function qs(e){let r=e.media.title;if(!r)throw new p("Falta el t\xEDtulo");console.log(`[AnimeFLV] Iniciando scraping para: ${r}`);let t=await Kc(e,r),o=t;if(e.media.type==="show"){let a=e.media.episode?.number;if(!a)throw new p("Faltan datos de episodio");let c=(await Jc(e,t)).find(l=>l.number===a);if(!c)throw new p(`No se encontr\xF3 el episodio ${a}`);o=c.url}else if(e.media.type==="movie"){let a=await e.proxiedFetcher(t),i=(0,Ae.load)(a),c=null;if(i("script").each((l,d)=>{let u=i(d).html()||"";u.includes("var anime_info =")&&(c=u.split("var anime_info = [")[1]?.split("];")[0]?.split(",")[2]?.replace(/"/g,"").trim()||null)}),!c)throw new p("No se pudo obtener el animeUri para la pel\xEDcula");o=`${ar}/ver/${c}-1`}let s=await Gc(e,o),n=Object.entries(s).filter(([,a])=>typeof a=="string"&&!!a).map(([a,i])=>({embedId:a,url:i}));if(n.length===0)throw new p("No se encontraron streams v\xE1lidos");return{embeds:n}}var Bs=S({id:"animeflv",name:"AnimeFLV",rank:90,disabled:!0,flags:[g.CORS_ALLOWED],scrapeShow:qs,scrapeMovie:qs});async function Yc(e){let r=e.media.title;try{let t=await e.proxiedFetcher("/api/search",{baseUrl:"https://backend.animetsu.to",headers:{referer:"https://animetsu.cc/",origin:"https://animetsu.cc","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"},query:{q:r,limit:"10"}});console.log("Animetsu Search Response:",JSON.stringify(t,null,2));let o=t?.results||t?.data||[];if(!o||o.length===0)throw new p("No results found in animetsu search");let s=o[0],n=s?.id||s?.animetsu_id;if(!n)throw new p("No animetsu ID found in search results");let a={type:e.media.type,title:e.media.title,animetsuId:n,...e.media.type==="show"&&{season:e.media.season.number,episode:e.media.episode.number},...e.media.type==="movie"&&{episode:1},releaseYear:e.media.releaseYear};return{embeds:[{embedId:"animetsu-pahe",url:JSON.stringify(a)},{embedId:"animetsu-zoro",url:JSON.stringify(a)},{embedId:"animetsu-zaza",url:JSON.stringify(a)},{embedId:"animetsu-meg",url:JSON.stringify(a)},{embedId:"animetsu-bato",url:JSON.stringify(a)}]}}catch(t){throw new p(`Animetsu search failed: ${t instanceof Error?t.message:"Unknown error"}`)}}var js=S({id:"animetsu",name:"Animetsu",rank:112,disabled:!0,flags:[],scrapeShow:Yc});var Xc=["shadow","asiacloud","ophim"];async function Hs(e){let r=[],t={type:e.media.type,tmdbId:e.media.tmdbId};e.media.type==="show"&&(t.season=e.media.season.number,t.episode=e.media.episode.number);for(let o of Xc)r.push({embedId:`cinemaos-${o}`,url:JSON.stringify({...t,service:o})});return e.progress(50),{embeds:r}}var Ws=S({id:"cinemaos",name:"CinemaOS",rank:149,disabled:!0,flags:[g.CORS_ALLOWED],scrapeMovie:Hs,scrapeShow:Hs});var zs="https://api.coitus.ca";async function Vs(e){let r=e.media.type==="movie"?`${zs}/movie/${e.media.tmdbId}`:`${zs}/tv/${e.media.tmdbId}/${e.media.season.number}/${e.media.episode.number}`,t=await e.proxiedFetcher(r);if(!t.videoSource)throw new p("No watchable item found");let o=t.videoSource;if(o.includes("orbitproxy"))try{let s=o.split(/orbitproxy\.[^/]+\//);if(s.length>=2){let n=s[1].split(".m3u8")[0];try{let a=Buffer.from(n,"base64").toString("utf-8"),i=JSON.parse(a),c=i.u,d={referer:i.r||""};o=O(c,d)}catch(a){console.error("Error decoding/parsing orbitproxy data:",a)}}}catch(s){console.error("Error processing orbitproxy URL:",s)}return console.log(t),e.progress(90),{embeds:[],stream:[{id:"primary",captions:[],playlist:o,type:"hls",flags:[g.CORS_ALLOWED]}]}}var Ks=S({id:"coitus",name:"Autoembed+",rank:91,disabled:!0,flags:[g.CORS_ALLOWED],scrapeMovie:Vs,scrapeShow:Vs});var Gr=require("cheerio");var ir="https://www.cuevana3.eu";function Js(e){return e.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^a-z0-9\s-]/gi,"").replace(/\s+/g,"-").replace(/-+/g,"-")}async function Zc(e,r){try{let o=(await e.proxiedFetcher(r)).match(/var url = '([^']+)'/);if(o)return o[1]}catch{}return null}function Qc(e){return e.startsWith("https://")&&(e.includes("streamwish")||e.includes("filemoon")||e.includes("vidhide"))}async function cr(e,r){let t=[];for(let[o,s]of Object.entries(r))if(s)for(let n of s){if(!n.result)continue;let a=await Zc(e,n.result);if(!a||!Qc(a))continue;let i="";if(a.includes("filemoon"))i="filemoon";else if(a.includes("streamwish"))o==="latino"?i="streamwish-latino":o==="spanish"?i="streamwish-spanish":o==="english"?i="streamwish-english":i="streamwish-latino";else if(a.includes("vidhide"))i="vidhide";else if(a.includes("voe"))i="voe";else continue;t.push({embedId:i,url:a})}return t}async function el(e,r,t){let o=t==="movie"?`https://api.themoviedb.org/3/movie/${e}?api_key=${r}&language=es-ES`:`https://api.themoviedb.org/3/tv/${e}?api_key=${r}&language=es-ES`,s=await fetch(o);if(!s.ok)throw new Error(`Error fetching TMDB data: ${s.statusText}`);let n=await s.json();return t==="movie"?n.title:n.name}async function rl(){try{let e=await fetch("https://raw.githubusercontent.com/moonpic/fixed-titles/refs/heads/main/main.json");if(!e.ok)throw new Error("Failed to fetch fallback titles");return await e.json()}catch{return{}}}async function Gs(e){let r=e.media.type,t=e.media.tmdbId,o="7604525319adb2db8e7e841cb98e9217";if(!t)throw new p("TMDB ID is required to fetch the title in Spanish");let s=await el(Number(t),o,r),n=Js(s),a=r==="movie"?`${ir}/ver-pelicula/${n}`:`${ir}/episodio/${n}-temporada-${e.media.season?.number}-episodio-${e.media.episode?.number}`;e.progress(60);let i=await e.proxiedFetcher(a),c=(0,Gr.load)(i),l=c("script").toArray().find(u=>(u.children[0]?.data||"").includes('{"props":{"pageProps":')),d=[];if(l){let u;try{let m=l.children[0].data,h=m.indexOf('{"props":{"pageProps":');if(h===-1)throw new Error("No valid JSON start found");let f=m.slice(h);u=JSON.parse(f)}catch(m){throw new p(`Failed to parse JSON: ${m.message}`)}if(r==="movie"){let m=u.props.pageProps.thisMovie;m?.videos&&(d=await cr(e,m.videos)??[])}else{let m=u.props.pageProps.episode;m?.videos&&(d=await cr(e,m.videos)??[])}}if(d.length===0){let m=(await rl())[t.toString()];if(!m)throw new p("No embed data found and no fallback title available");if(n=Js(m),a=r==="movie"?`${ir}/ver-pelicula/${n}`:`${ir}/episodio/${n}-temporada-${e.media.season?.number}-episodio-${e.media.episode?.number}`,i=await e.proxiedFetcher(a),c=(0,Gr.load)(i),l=c("script").toArray().find(h=>(h.children[0]?.data||"").includes('{"props":{"pageProps":')),l){let h;try{let f=l.children[0].data,y=f.indexOf('{"props":{"pageProps":');if(y===-1)throw new Error("No valid JSON start found");let b=f.slice(y);h=JSON.parse(b)}catch(f){throw new p(`Failed to parse JSON: ${f.message}`)}if(r==="movie"){let f=h.props.pageProps.thisMovie;f?.videos&&(d=await cr(e,f.videos)??[])}else{let f=h.props.pageProps.episode;f?.videos&&(d=await cr(e,f.videos)??[])}}}if(d.length===0)throw new p("No valid streams found");return{embeds:d}}var Ys=S({id:"cuevana3",name:"Cuevana3",rank:80,disabled:!0,flags:[g.CORS_ALLOWED],scrapeMovie:Gs,scrapeShow:Gs});async function Yr(e){let r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",t=e.replace(/=+$/,""),o="";if(t.length%4===1)throw new Error("The string to be decoded is not correctly encoded.");for(let s=0,n=0,a=0;a<t.length;a++){let i=t.charAt(a),c=r.indexOf(i);c!==-1&&(n=s%4?n*64+c:c,s++%4&&(o+=String.fromCharCode(255&n>>(-2*s&6))))}return o}async function Xs(e){let r=`https://embed.su/embed/${e.media.type==="movie"?`movie/${e.media.tmdbId}`:`tv/${e.media.tmdbId}/${e.media.season.number}/${e.media.episode.number}`}`,s=(await e.proxiedFetcher(r,{headers:{Referer:"https://embed.su/","User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36"}})).match(/window\.vConfig\s*=\s*JSON\.parse\(atob\(`([^`]+)/i)?.[1];if(!s)throw new p("No encoded config found");let n=JSON.parse(await Yr(s));if(!n?.hash)throw new p("No stream hash found");let a=(await Yr(n.hash)).split(".").map(l=>l.split("").reverse().join("")),i=JSON.parse(await Yr(a.join("").split("").reverse().join("")));if(!i?.length)throw new p("No servers found");e.progress(50);let c=i.map(l=>({embedId:"viper",url:`https://embed.su/api/e/${l.hash}`}));return e.progress(90),{embeds:c}}var Zs=S({id:"embedsu",name:"embed.su",rank:165,disabled:!0,flags:[],scrapeMovie:Xs,scrapeShow:Xs});var on=require("cheerio");function Qs(){let e=()=>Math.floor(Math.random()*16).toString(16),r=t=>Array.from({length:t},e).join("");return`${r(8)}-${r(4)}-${r(4)}-${r(4)}-${r(12)}`}function en(e){if(!e||typeof e=="boolean")return[];let r=e.split(","),t=[];return r.forEach(o=>{let s=o.match(/\[([^\]]+)\](https?:\/\/\S+?)(?=,\[|$)/);if(s){let n=me(s[2]),a=q(s[1]);if(!n||!a)return;t.push({id:s[2],language:a,hasCorsRestrictions:!1,type:n,url:s[2]})}}),t}function rn(e){if(!e)throw new p("No video links found");try{let r={};e.split(",").forEach(s=>{let n=s.match(/\[([^\]]+)\](https?:\/\/[^\s,]+)/);if(n){let[a,i,c]=n;if(c==="null")return;let l=i.replace(/<[^>]+>/g,"").toLowerCase().replace("p","").trim();r[l]={type:"mp4",url:c.trim()}}});let o={};return Object.entries(r).forEach(([s,n])=>{let a=he(s);o[a]=n}),o}catch(r){throw console.error("Error parsing video links:",r),new p("Failed to parse video links")}}var Xr="https://hdrezka.ag/",Zr={"X-Hdrezka-Android-App":"1","X-Hdrezka-Android-App-Version":"2.2.0","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36","Accept-Language":"ru-RU,ru;q=0.9,en-US;q=0.8,en;q=0.7","CF-IPCountry":"RU"};async function tl(e){let r=await e.proxiedFetcher("/engine/ajax/search.php",{baseUrl:Xr,headers:Zr,query:{q:e.media.title}}),t=(0,on.load)(r),o=t("a").map((s,n)=>{let a=t(n),i=a.attr("href"),c=a.find("span.enty").text(),l=c.match(/\((\d{4})\)/)||i?.match(/-(\d{4})(?:-|\.html)/)||c.match(/(\d{4})/),d=l?l[1]:null,u=i?.match(/\/(\d+)-[^/]+\.html$/)?.[1];return u?{id:u,year:d?parseInt(d,10):e.media.releaseYear,type:e.media.type,url:i||""}:null}).get().filter(Boolean);return o.sort((s,n)=>{let a=Math.abs(s.year-e.media.releaseYear),i=Math.abs(n.year-e.media.releaseYear);return a-i}),o[0]||null}async function ol(e,r,t){let o=new URLSearchParams;o.append("id",e),o.append("translator_id",r),t.media.type==="show"&&(o.append("season",t.media.season.number.toString()),o.append("episode",t.media.episode.number.toString())),o.append("favs",Qs()),o.append("action",t.media.type==="show"?"get_stream":"get_movie"),o.append("t",Date.now().toString());let s=await t.proxiedFetcher("/ajax/get_cdn_series/",{baseUrl:Xr,method:"POST",body:o,headers:{...Zr,"Content-Type":"application/x-www-form-urlencoded","X-Requested-With":"XMLHttpRequest",Referer:`${Xr}films/action/${e}-novokain-2025-latest.html`}});try{let n=JSON.parse(s);if(!n.url&&n.success)throw new p("Movie found but no stream available (might be premium or not yet released)");if(!n.url)throw new p("No stream URL found in response");return n}catch(n){throw console.error("Error parsing stream response:",n),new p("Failed to parse stream response")}}async function sl(e,r,t){let o=await t.proxiedFetcher(e,{headers:Zr});if(o.includes('data-translator_id="238"'))return"238";let s=t.media.type==="movie"?"initCDNMoviesEvents":"initCDNSeriesEvents",n=new RegExp(`sof\\.tv\\.${s}\\(${r}, ([^,]+)`,"i"),a=o.match(n);return a?a[1]:null}var tn=async e=>{let r=await tl(e);if(!r||!r.id)throw new p("No result found");let t=await sl(r.url,r.id,e);if(!t)throw new p("No translator id found");let{url:o,subtitle:s}=await ol(r.id,t,e),n=rn(o),a=en(s);return e.progress(90),{embeds:[],stream:[{id:"primary",type:"file",flags:[g.CORS_ALLOWED,g.IP_LOCKED],captions:a,qualities:n}]}},sn=S({id:"hdrezka",name:"HDRezka",rank:100,flags:[g.CORS_ALLOWED,g.IP_LOCKED],scrapeShow:tn,scrapeMovie:tn});var nn="https://iosmirror.cc",Fe="https://vercel-sucks.up.railway.app/iosmirror.cc:443",an=async e=>{let r=decodeURIComponent(await e.fetcher("https://iosmirror-hash.pstream.org/"));if(!r)throw new p("No hash found");e.progress(10);let t=await e.proxiedFetcher("/search.php",{baseUrl:Fe,query:{s:e.media.title},headers:{cookie:A({t_hash_t:r,hd:"on"})}});if(t.status!=="y"||!t.searchResult)throw new p(t.error);async function o(d){return e.proxiedFetcher("/post.php",{baseUrl:Fe,query:{id:d},headers:{cookie:A({t_hash_t:r,hd:"on"})}})}e.progress(30);let s,n=t.searchResult.find(async d=>(s=await o(d.id),$e(d.t,e.media.title)&&(Number(s.year)===e.media.releaseYear||s.type===(e.media.type==="movie"?"m":"t"))))?.id;if(!n)throw new p("No watchable item found");if(e.media.type==="show"){s=await o(n);let d=e.media,u=s?.season.find(b=>Number(b.s)===d.season.number)?.id;if(!u)throw new p("Season not available");let m=await e.proxiedFetcher("/episodes.php",{baseUrl:Fe,query:{s:u,series:n},headers:{cookie:A({t_hash_t:r,hd:"on"})}}),h=[...m.episodes],f=2;for(;m.nextPageShow===1;){let b=await e.proxiedFetcher("/episodes.php",{baseUrl:Fe,query:{s:u,series:n,page:f.toString()},headers:{cookie:A({t_hash_t:r,hd:"on"})}});h=[...h,...b.episodes],m.nextPageShow=b.nextPageShow,f++}let y=h.find(b=>b.ep===`E${d.episode.number}`&&b.s===`S${d.season.number}`)?.id;if(!y)throw new p("Episode not available");n=y}let a=await e.proxiedFetcher("/playlist.php?",{baseUrl:Fe,query:{id:n},headers:{cookie:A({t_hash_t:r,hd:"on"})}});e.progress(50);let i=a[0].sources.find(d=>d.label==="Auto")?.file;if(i||(i=a[0].sources.find(d=>d.label==="Full HD")?.file),i||(console.log('"Full HD" or "Auto" file not found, falling back to first source'),i=a[0].sources[0].file),!i)throw new Error("Failed to fetch playlist");let c={referer:nn,cookie:A({hd:"on"})},l=O(`${nn}${i}`,c);return e.progress(90),{embeds:[],stream:[{id:"primary",playlist:l,type:"hls",flags:[g.CORS_ALLOWED],captions:[]}]}},cn=S({id:"iosmirror",name:"NetMirror",rank:182,disabled:!0,flags:[g.CORS_ALLOWED],scrapeMovie:an,scrapeShow:an});var ln="https://iosmirror.cc",Le="https://vercel-sucks.up.railway.app/iosmirror.cc:443/pv",dn=async e=>{let r=decodeURIComponent(await e.fetcher("https://iosmirror-hash.pstream.org/"));if(!r)throw new p("No hash found");e.progress(10);let t=await e.proxiedFetcher("/search.php",{baseUrl:Le,query:{s:e.media.title},headers:{cookie:A({t_hash_t:r,hd:"on"})}});if(!t.searchResult)throw new p(t.error);async function o(l){return e.proxiedFetcher("/post.php",{baseUrl:Le,query:{id:l},headers:{cookie:A({t_hash_t:r,hd:"on"})}})}e.progress(30);let s=t.searchResult.find(async l=>{let d=await o(l.id);return $e(l.t,e.media.title)&&(Number(l.y)===e.media.releaseYear||d.type===(e.media.type==="movie"?"m":"t"))})?.id;if(!s)throw new p("No watchable item found");if(e.media.type==="show"){let l=await o(s),d=e.media,u=l?.season.find(b=>Number(b.s)===d.season.number)?.id;if(!u)throw new p("Season not available");let m=await e.proxiedFetcher("/episodes.php",{baseUrl:Le,query:{s:u,series:s},headers:{cookie:A({t_hash_t:r,hd:"on"})}}),h=[...m.episodes],f=2;for(;m.nextPageShow===1;){let b=await e.proxiedFetcher("/episodes.php",{baseUrl:Le,query:{s:u,series:s,page:f.toString()},headers:{cookie:A({t_hash_t:r,hd:"on"})}});h=[...h,...b.episodes],m.nextPageShow=b.nextPageShow,f++}let y=h.find(b=>b.ep===`E${d.episode.number}`&&b.s===`S${d.season.number}`)?.id;if(!y)throw new p("Episode not available");s=y}let n=await e.proxiedFetcher("/playlist.php?",{baseUrl:Le,query:{id:s},headers:{cookie:A({t_hash_t:r,hd:"on"})}});e.progress(50);let a=n[0].sources.find(l=>l.label==="Auto")?.file;if(a||(a=n[0].sources.find(l=>l.label==="Full HD")?.file),a||(console.log('"Full HD" or "Auto" file not found, falling back to first source'),a=n[0].sources[0].file),!a)throw new Error("Failed to fetch playlist");let i={referer:ln,cookie:A({hd:"on"})},c=O(`${ln}${a}`,i);return e.progress(90),{embeds:[],stream:[{id:"primary",playlist:c,type:"hls",flags:[g.CORS_ALLOWED],captions:[]}]}},pn=S({id:"iosmirrorpv",name:"PrimeMirror",rank:183,disabled:!0,flags:[g.CORS_ALLOWED],scrapeMovie:dn,scrapeShow:dn});async function nl(e,r,t){let o="";return t.type==="show"?o="/v1/episodes/view":t.type==="movie"&&(o="/v1/movies/view"),await e.proxiedFetcher(o,{baseUrl:ye,query:{expand:"streams,subtitles",id:r}})}async function un(e,r,t){let o=await nl(e,r,t),s=o.streams;if(!s||typeof s!="object")return{playlist:null,captions:[]};let n=["auto","1080p","1080","720p","720","480p","480","240p","240","360p","360","144","144p"],a=null;for(let c of n)s[c]&&!a&&(a=s[c]);let i=[];if(o.subtitles&&Array.isArray(o.subtitles)){for(let c of o.subtitles){let l=q(c.language);l&&i.push({id:c.url,type:"vtt",url:`${ye}${c.url}`,hasCorsRestrictions:!1,language:l})}i=Yt(i)}return{playlist:a,captions:i}}var ye="https://lmscript.xyz";async function mn(e,r){if(r.type==="show")return(await e.proxiedFetcher("/v1/shows",{baseUrl:ye,query:{"filters[q]":r.title}})).items.find(n=>U(r,n.title,Number(n.year)));if(r.type==="movie")return(await e.proxiedFetcher("/v1/movies",{baseUrl:ye,query:{"filters[q]":r.title}})).items.find(n=>U(r,n.title,Number(n.year)))}async function fn(e,r,t){let o=null;if(r.type==="movie")o=t.id_movie;else if(r.type==="show"){let a=(await e.proxiedFetcher("/v1/shows",{baseUrl:ye,query:{expand:"episodes",id:t.id_show}})).episodes?.find(i=>Number(i.season)===Number(r.season.number)&&Number(i.episode)===Number(r.episode.number));a&&(o=a.id)}if(o===null)throw new p("Not found");return await un(e,o,r)}async function hn(e){let r=await mn(e,e.media);if(!r)throw new p("Media not found");e.progress(30);let t=await fn(e,e.media,r);if(!t.playlist)throw new p("No video found");return e.progress(60),{embeds:[],stream:[{id:"primary",playlist:t.playlist,type:"hls",flags:[g.IP_LOCKED],captions:t.captions}]}}var gn=S({id:"lookmovie",name:"LookMovie",disabled:!1,rank:140,flags:[g.IP_LOCKED],scrapeShow:hn,scrapeMovie:hn});async function yn(e){let r={type:e.media.type,title:e.media.title,tmdbId:e.media.tmdbId,imdbId:e.media.imdbId,...e.media.type==="show"&&{season:e.media.season.number,episode:e.media.episode.number},releaseYear:e.media.releaseYear};return{embeds:[{embedId:"madplay-base",url:JSON.stringify(r)},{embedId:"madplay-nsapi",url:JSON.stringify(r)},{embedId:"madplay-roper",url:JSON.stringify(r)},{embedId:"madplay-vidfast",url:JSON.stringify(r)}]}}var bn=S({id:"madplay",name:"Flicky",rank:155,disabled:!0,flags:[g.CORS_ALLOWED],scrapeMovie:yn,scrapeShow:yn});var Sn="https://mama.up.railway.app/api/showbox",vn=()=>{try{return typeof window<"u"?window.localStorage.getItem("febbox_ui_token"):null}catch(e){return console.warn("Unable to access localStorage:",e),null}};async function wn(e){let r=vn(),t=e.media.type==="movie"?`${Sn}/movie/${e.media.tmdbId}?token=${r}`:`${Sn}/tv/${e.media.tmdbId}?season=${e.media.season.number}&episode=${e.media.episode.number}&token=${r}`,o=await e.proxiedFetcher(t);if(!o)throw new p("No response from API");let s=await o;if(!s.success)throw new p("No streams found");let n=Array.isArray(s.streams)?s.streams:[s.streams];if(n.length===0||!n[0].player_streams)throw new p("No valid streams found");let a=n[0];for(let c of n)if(c.quality.includes("4K")||c.quality.includes("2160p")){a=c;break}let i=a.player_streams.reduce((c,l)=>{let d;if(l.quality==="4K"||l.quality.includes("4K"))d=2160;else{if(l.quality==="ORG"||l.quality.includes("ORG"))return c;d=parseInt(l.quality.replace("P",""),10)}return Number.isNaN(d)||c[d]||(c[d]=l.file),c},{});return{embeds:[],stream:[{id:"primary",captions:[],qualities:{...i[2160]&&{"4k":{type:"mp4",url:i[2160]}},...i[1080]&&{1080:{type:"mp4",url:i[1080]}},...i[720]&&{720:{type:"mp4",url:i[720]}},...i[480]&&{480:{type:"mp4",url:i[480]}},...i[360]&&{360:{type:"mp4",url:i[360]}}},type:"file",flags:[g.CORS_ALLOWED]}]}}var En=S({id:"nunflix",name:"NFlix",rank:155,disabled:!vn(),flags:[g.CORS_ALLOWED],scrapeMovie:wn,scrapeShow:wn});var xn="api.rgshows.ru",kn={referer:"https://www.rgshows.ru/",origin:"https://www.rgshows.ru",host:xn,"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"};async function Cn(e){let r=`https://${xn}/main`;e.media.type==="movie"?r+=`/movie/${e.media.tmdbId}`:e.media.type==="show"&&(r+=`/tv/${e.media.tmdbId}/${e.media.season.number}/${e.media.episode.number}`);let t=await e.proxiedFetcher(r,{headers:kn});if(!t?.stream?.url)throw new p("No streams found");if(t.stream.url==="https://vidzee.wtf/playlist/69/master.m3u8")throw new p("Found only vidzee porn stream");let o=t.stream.url,s=new URL(o).host,n={...kn,host:s,origin:"https://www.rgshows.ru",referer:"https://www.rgshows.ru/"};return e.progress(100),{embeds:[],stream:[{id:"primary",type:"hls",playlist:o,headers:n,flags:[],captions:[]}]}}var On=S({id:"rgshows",name:"RGShows",rank:173,flags:[],scrapeMovie:Cn,scrapeShow:Cn});var In=require("cheerio");var $n="https://ridomovies.tv",Rn=`${$n}/core/api`,Mn=async e=>{let o=(await e.proxiedFetcher("/search",{baseUrl:Rn,query:{q:e.media.title}})).data.items.map(l=>{let d=l.title,u=l.contentable.releaseYear,m=l.fullSlug;return{name:d,year:u,fullSlug:m}}).find(l=>l.name===e.media.title&&l.year===e.media.releaseYear.toString());if(!o?.fullSlug)throw new p("No watchable item found");e.progress(40);let s=`/${o.fullSlug}/videos`;if(e.media.type==="show"){let l=await e.proxiedFetcher(`/${o.fullSlug}`,{baseUrl:$n}),d=`season-${e.media.season.number}/episode-${e.media.episode.number}`,u=new RegExp(`\\\\"id\\\\":\\\\"(\\d+)\\\\"(?=.*?\\\\\\"fullSlug\\\\\\":\\\\\\"[^"]*${d}[^"]*\\\\\\")`,"g"),h=[...l.matchAll(u)].map(y=>y[1]);if(h.length===0)throw new p("No watchable item found");s=`/episodes/${h.at(-1)}/videos`}let n=await e.proxiedFetcher(s,{baseUrl:Rn}),i=(0,In.load)(n.data[0].url)("iframe").attr("data-src");if(!i)throw new p("No watchable item found");e.progress(60);let c=[];return i.includes("closeload")&&c.push({embedId:Ye.id,url:i}),i.includes("ridoo")&&c.push({embedId:Ze.id,url:i}),e.progress(90),{embeds:c}},Pn=S({id:"ridomovies",name:"RidoMovies",rank:210,flags:[g.CF_BLOCKED],disabled:!0,scrapeMovie:Mn,scrapeShow:Mn});var Ln=require("cheerio");var An="https://pupp.slidemovies-dev.workers.dev";async function Fn(e){let r=e.media.type==="movie"?`${An}/movie/${e.media.tmdbId}`:`${An}/tv/${e.media.tmdbId}/${e.media.season.number}/-${e.media.episode.number}`,t=await e.proxiedFetcher(r),o=(0,Ln.load)(t);e.progress(50);let s=o("media-player").attr("src");if(!s)throw new p("Stream URL not found");let a=new URL(s).searchParams.get("url")||"",i=decodeURIComponent(a),c=o("media-provider track").map((l,d)=>{let u=o(d).attr("src")||"",m=o(d).attr("lang")||"unknown",h=q(m)||m;return{type:u.endsWith(".vtt")?"vtt":"srt",id:u,url:u,language:h,hasCorsRestrictions:!1}}).get();return e.progress(90),{embeds:[],stream:[{id:"primary",type:"hls",flags:[],playlist:i,captions:c}]}}var Un=S({id:"slidemovies",name:"SlideMovies",rank:135,disabled:!0,flags:[g.CORS_ALLOWED],scrapeMovie:Fn,scrapeShow:Fn});var lr=require("cheerio");var be=require("hls-parser");async function Qr(e,r,t){let o=await e(r,{headers:t}),s=(0,be.parse)(o);if(s.isMasterPlaylist){let n=new URL(r).origin;await Promise.all(s.variants.map(async a=>{let i=a.uri;i.startsWith("http")||(i.startsWith("/")||(i=`/${i}`),i=n+i);let c=await e(i,{headers:t}),l=(0,be.parse)(c);a.uri=`data:application/vnd.apple.mpegurl;base64,${btoa((0,be.stringify)(l))}`}))}return`data:application/vnd.apple.mpegurl;base64,${btoa((0,be.stringify)(s))}`}var V="https://soaper.cc",Tn=async e=>{let r=await e.proxiedFetcher("/search.html",{baseUrl:V,query:{keyword:e.media.title}}),t=(0,lr.load)(r),o=[];t(".thumbnail").each((f,y)=>{let b=t(y).find("h5").find("a").first().text().trim(),C=t(y).find(".img-tip").first().text().trim(),x=t(y).find("h5").find("a").first().attr("href");!b||!x||o.push({title:b,year:C?parseInt(C,10):void 0,url:x})});let s=o.find(f=>f&&U(e.media,f.title,f.year))?.url;if(!s)throw new p("Content not found");if(e.media.type==="show"){let f=e.media.season.number,y=e.media.episode.number,b=await e.proxiedFetcher(s,{baseUrl:V}),C=(0,lr.load)(b),E=C("h4").filter((L,_)=>C(_).text().trim().split(":")[0].trim()===`Season${f}`).parent().find("a").toArray();s=C(E.find(L=>parseInt(C(L).text().split(".")[0],10)===y)).attr("href")}if(!s)throw new p("Content not found");let n=await e.proxiedFetcher(s,{baseUrl:V}),i=(0,lr.load)(n)("#hId").attr("value");if(!i)throw new p("Content not found");e.progress(50);let c=new URLSearchParams;c.append("pass",i),c.append("e2","0"),c.append("server","0");let l=e.media.type==="show"?"/home/index/getEInfoAjax":"/home/index/getMInfoAjax",d=await e.proxiedFetcher(l,{baseUrl:V,method:"POST",body:c,headers:{referer:`${V}${s}`,"User-Agent":"Mozilla/5.0 (iPhone; CPU iPhone OS 18_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.0 Mobile/15E148 Safari/604.1","Viewport-Width":"375"}}),u=JSON.parse(d),m=[];if(Array.isArray(u.subs))for(let f of u.subs){let y="";if(f.name.includes(".srt")){let b=f.name.split(".srt")[0].trim();y=q(b)}else if(f.name.includes(":")){let b=f.name.split(":")[0].trim();y=q(b)}else{let b=f.name.trim();y=q(b)}y&&m.push({id:f.path,url:`${V}${f.path}`,type:"srt",hasCorsRestrictions:!1,language:y})}e.progress(90);let h={referer:`${V}${s}`,"User-Agent":"Mozilla/5.0 (iPhone; CPU iPhone OS 18_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.0 Mobile/15E148 Safari/604.1","Viewport-Width":"375",Origin:V};return{embeds:[],stream:[{id:"primary",playlist:await Qr(e.proxiedFetcher,`${V}/${u.val}`,h),type:"hls",proxyDepth:2,flags:[g.CORS_ALLOWED],captions:m},...u.val_bak?[{id:"backup",playlist:await Qr(e.proxiedFetcher,`${V}/${u.val_bak}`,h),type:"hls",flags:[g.CORS_ALLOWED],proxyDepth:2,captions:m}]:[]]}},Nn=S({id:"soapertv",name:"SoaperTV",rank:130,disabled:!0,flags:[g.CORS_ALLOWED],scrapeMovie:Tn,scrapeShow:Tn});var _n="https://vidjoy.pro/embed/api/fastfetch";async function Dn(e){let r=await e.proxiedFetcher(e.media.type==="movie"?`${_n}/${e.media.tmdbId}?sr=0`:`${_n}/${e.media.tmdbId}/${e.media.season.number}/${e.media.episode.number}?sr=0`);if(!r)throw new p("Failed to fetch StreamBox data");console.log(r);let t=await r,o={};t.url.forEach(a=>{o[a.resulation]=a.link});let s=t.tracks.map(a=>({id:a.lang,url:a.url,language:a.code,type:"srt"}));if(t.provider==="MovieBox")return{embeds:[],stream:[{id:"primary",captions:s,qualities:{...o[1080]&&{1080:{type:"mp4",url:o[1080]}},...o[720]&&{720:{type:"mp4",url:o[720]}},...o[480]&&{480:{type:"mp4",url:o[480]}},...o[360]&&{360:{type:"mp4",url:o[360]}}},type:"file",flags:[g.CORS_ALLOWED],preferredHeaders:{Referer:t.headers?.Referer}}]};let n=t.url.find(a=>a.type==="hls")||t.url[0];return{embeds:[],stream:[{id:"primary",captions:s,playlist:n.link,type:"hls",flags:[g.CORS_ALLOWED],preferredHeaders:{Referer:t.headers?.Referer}}]}}var qn=S({id:"streambox",name:"StreamBox",rank:119,disabled:!0,flags:[g.CORS_ALLOWED],scrapeMovie:Dn,scrapeShow:Dn});var Bn="https://vidapi.click";async function jn(e){let r=e.media.type==="show"?`${Bn}/api/video/tv/${e.media.tmdbId}/${e.media.season.number}/${e.media.episode.number}`:`${Bn}/api/video/movie/${e.media.tmdbId}`,t=await e.proxiedFetcher(r,{headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"}});if(!t)throw new p("Failed to fetch video source");if(!t.sources[0].file)throw new p("No video source found");return e.progress(50),e.progress(90),{embeds:[],stream:[{id:"primary",type:"hls",playlist:t.sources[0].file,flags:[g.CORS_ALLOWED],captions:[]}]}}var Hn=S({id:"vidapi-click",name:"vidapi.click",rank:89,disabled:!0,flags:[g.CORS_ALLOWED],scrapeMovie:jn,scrapeShow:jn});async function Wn(e){let r={type:e.media.type,title:e.media.title,tmdbId:e.media.tmdbId,imdbId:e.media.imdbId,...e.media.type==="show"&&{season:e.media.season.number,episode:e.media.episode.number},releaseYear:e.media.releaseYear};return{embeds:[{embedId:"vidify-alfa",url:JSON.stringify(r)},{embedId:"vidify-bravo",url:JSON.stringify(r)},{embedId:"vidify-charlie",url:JSON.stringify(r)},{embedId:"vidify-delta",url:JSON.stringify(r)},{embedId:"vidify-echo",url:JSON.stringify(r)},{embedId:"vidify-foxtrot",url:JSON.stringify(r)},{embedId:"vidify-golf",url:JSON.stringify(r)},{embedId:"vidify-hotel",url:JSON.stringify(r)},{embedId:"vidify-india",url:JSON.stringify(r)},{embedId:"vidify-juliett",url:JSON.stringify(r)}]}}var zn=S({id:"vidify",name:"Vidify",rank:124,disabled:!0,flags:[],scrapeMovie:Wn,scrapeShow:Wn});var Vn="https://backend.vidnest.fun",al=["hollymoviehd","allmovies","flixhq","official"];async function Kn(e,r){let t=[];for(let o of al){let s="";r==="movie"?s=`${Vn}/${o}/movie/${e.media.tmdbId}`:e.media.type==="show"&&(s=`${Vn}/${o}/tv/${e.media.tmdbId}/${e.media.season.number}/${e.media.episode.number}`),t.push({embedId:`vidnest-${o}`,url:s})}return{embeds:t}}var il=S({id:"vidnest",name:"Vidnest",rank:130,flags:[g.CORS_ALLOWED],scrapeMovie:e=>Kn(e,"movie"),scrapeShow:e=>Kn(e,"tv")}),Jn=il;async function cl(e,r,t){let o=[];for(let s of r.split(",")){await t.proxiedFetcher("/getEmbed.php",{baseUrl:de,headers:{Referer:`${de}/getEmbed.php?${new URLSearchParams({id:e,sv:s})}`},method:"HEAD",query:{id:e,sv:s}});let a=(await t.proxiedFetcher("/getPlay.php",{baseUrl:de,headers:{Referer:`${de}/getEmbed.php?${new URLSearchParams({id:e,sv:s})}`},query:{id:e,sv:s}})).match(/window.location.href\s*=\s*"([^"]+)"/)?.[1];a&&s==="warezcdn"?o.push({embedId:rr.id,url:a},{embedId:pe.id,url:a},{embedId:tr.id,url:a}):a&&s==="mixdrop"&&o.push({embedId:ze.id,url:a})}return{embeds:o}}var Gn=S({id:"warezcdn",name:"WarezCDN",disabled:!0,rank:115,flags:[],scrapeMovie:async e=>{if(!e.media.imdbId)throw new p("This source requires IMDB id.");let r=await e.proxiedFetcher(`/filme/${e.media.imdbId}`,{baseUrl:de}),[,t,o]=r.match(/let\s+data\s*=\s*'\[\s*\{\s*"id":"([^"]+)".*?"servers":"([^"]+)"/);if(!t||!o)throw new p("Failed to find episode id");return e.progress(40),cl(t,o,e)}});var te=require("cheerio");var Se="https://mycima.pics/",Yn=S({id:"wecima",name:"Wecima (Arabic)",rank:55,disabled:!0,flags:[g.IP_LOCKED],scrapeMovie:async e=>{let r=await e.proxiedFetcher(`/search/${encodeURIComponent(e.media.title)}/`,{baseUrl:Se}),t=(0,te.load)(r),o=t(".Grid--WecimaPosts .GridItem a"),s;for(let d of o){let u=t(d).find(".title").text().trim(),m=t(d).find(".year").text().trim();if(U(e.media,u,m?parseInt(m,10):void 0)){s=t(d).attr("href");break}}if(!s)throw new p("Movie not found");e.progress(40);let n=await e.proxiedFetcher(s,{baseUrl:Se}),a=(0,te.load)(n),i=[],c=a(".servers-list a, .server-item a, button[data-server]");for(let d of c){let u=a(d).attr("href")||a(d).attr("data-url")||a(d).attr("data-server");u&&(u.includes("fdewsdc.sbs")||u.includes("/embed/"))&&i.push({embedId:"wecima-embed",url:u.startsWith("http")?u:`https:${u}`})}let l=a('iframe[src*="/embed/"], iframe[src*="fdewsdc"], iframe[src*="player"]');for(let d of l){let u=a(d).attr("src");u&&i.push({embedId:"wecima-embed",url:u.startsWith("http")?u:`https:${u}`})}return e.progress(90),{embeds:i}},scrapeShow:async e=>{let r=await e.proxiedFetcher(`/search/${encodeURIComponent(e.media.title)}/`,{baseUrl:Se}),t=(0,te.load)(r),o=t(".Grid--WecimaPosts .GridItem a"),s;for(let x of o){let E=t(x).find(".title").text().trim(),L=t(x).find(".year").text().trim();if(U(e.media,E,L?parseInt(L,10):void 0)){s=t(x).attr("href");break}}if(!s)throw new p("Show not found");e.progress(30);let n=await e.proxiedFetcher(s,{baseUrl:Se}),a=(0,te.load)(n),i=a(".List--Seasons--Episodes a, .season-link"),c;for(let x of i){let E=a(x).text().trim();if(E.includes(`\u0645\u0648\u0633\u0645 ${e.media.season.number}`)||E.includes(`Season ${e.media.season.number}`)){c=a(x).attr("href");break}}if(!c)throw new p(`Season ${e.media.season.number} not found`);e.progress(50);let l=await e.proxiedFetcher(c,{baseUrl:Se}),d=(0,te.load)(l),u=d(".Episodes--Seasons--Episodes a, .episode-link"),m;for(let x of u){let E=d(x).text().trim();if(E.includes(`\u0627\u0644\u062D\u0644\u0642\u0629 ${e.media.episode.number}`)||E.includes(`Episode ${e.media.episode.number}`)){m=d(x).attr("href");break}}if(!m)throw new p(`Episode ${e.media.episode.number} not found`);e.progress(70);let h=await e.proxiedFetcher(m,{baseUrl:Se}),f=(0,te.load)(h),y=[],b=f(".servers-list a, .server-item a, button[data-server]");for(let x of b){let E=f(x).attr("href")||f(x).attr("data-url")||f(x).attr("data-server");E&&(E.includes("fdewsdc.sbs")||E.includes("/embed/"))&&y.push({embedId:"wecima-embed",url:E.startsWith("http")?E:`https:${E}`})}let C=f('iframe[src*="/embed/"], iframe[src*="fdewsdc"], iframe[src*="player"]');for(let x of C){let E=f(x).attr("src");E&&y.push({embedId:"wecima-embed",url:E.startsWith("http")?E:`https:${E}`})}return e.progress(90),{embeds:y}}});var Xn=new Map;function Zn(e){return e.toLowerCase().replace(/[^a-z0-9]+/g," ").trim()}function ll(e,r){return e==="show"?["TV","TV_SHORT","OVA","ONA","SPECIAL"].includes(r.format):r.format==="MOVIE"}var dl=`
query ($search: String, $type: MediaType) {
  Page(page: 1, perPage: 20) {
    media(search: $search, type: $type, sort: POPULARITY_DESC) {
      id
      type
      format
      seasonYear
      title {
        romaji
        english
        native
      }
    }
  }
}
`;async function Qn(e,r){let t=`${r.type}:${r.title}:${r.releaseYear}`,o=Xn.get(t);if(o)return o;let n=(await e.proxiedFetcher("",{baseUrl:"https://graphql.anilist.co",method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({query:dl,variables:{search:r.title,type:"ANIME"}})})).data?.Page?.media??[];if(!n.length)throw new Error("AniList id not found");let a=Zn(r.title),l=(n.filter(d=>ll(r.type,d)).map(d=>{let u=[d.title.romaji];d.title.english&&u.push(d.title.english),d.title.native&&u.push(d.title.native);let m=u.map(Zn).filter(Boolean),h=m.includes(a),f=m.some(C=>C.includes(a)||a.includes(C)),y=d.seasonYear?Math.abs(d.seasonYear-r.releaseYear):5,b=0;return h?b+=100:f&&(b+=50),b+=Math.max(0,20-y*4),{it:d,score:b}}).sort((d,u)=>u.score-d.score)[0]?.it??n[0])?.id;if(!l)throw new Error("AniList id not found");return Xn.set(t,l),l}async function ea(e){let r=[];if(e.media.type==="movie"){let t=`https://vidnest.fun/movie/${e.media.tmdbId}`;r=[{embedId:"zunime-hd-2",url:t},{embedId:"zunime-miko",url:t},{embedId:"zunime-shiro",url:t},{embedId:"zunime-zaza",url:t}]}else if(e.media.type==="show")try{let o=`https://vidnest.fun/anime/${await Qn(e,e.media)}/${e.media.episode.number}/dub`;r=[{embedId:"zunime-hd-2",url:o},{embedId:"zunime-miko",url:o},{embedId:"zunime-shiro",url:o},{embedId:"zunime-zaza",url:o}]}catch{let t=`https://vidnest.fun/tv/${e.media.tmdbId}/${e.media.season.number}/${e.media.episode.number}`;r=[{embedId:"zunime-hd-2",url:t},{embedId:"zunime-miko",url:t},{embedId:"zunime-shiro",url:t},{embedId:"zunime-zaza",url:t}]}return{embeds:r}}var ra=S({id:"zunime",name:"Zunime",rank:125,disabled:!0,flags:[],scrapeMovie:ea,scrapeShow:ea});function et(){return[Ys,Pn,sn,Gn,mo,Nn,Qt,xo,co,po,Fo,Do,yo,Zs,Un,cn,pn,Hn,Ks,qn,En,Ds,Yn,Bs,Ws,wo,ko,Uo,bn,On,zn,ra,Jn,js,gn]}function ta(){return[Ve,ds,ze,Ze,Ye,zt,ns,ts,rr,pe,tr,jo,Ho,Wo,zo,Vo,Jt,es,rs,bs,Ss,ws,vs,Es,ks,Cs,xs,Os,Rs,Ms,Is,$s,Ps,ls,as,is,cs,os,...Ko,Yo,Xo,Zo,Qo,...ms,...Ls,...Bo,fs,hs,gs,ys,Fs]}function G(){return et().filter(e=>!e.disabled&&!e.externalSource)}function Y(){return et().filter(e=>e.externalSource&&!e.disabled)}function ee(){return ta().filter(e=>!e.disabled)}function rt(e,r){let t=new Map;for(let o of e){let s=r(o);t.has(s)||t.set(s,[]),t.get(s).push(o)}return Array.from(t.entries()).filter(([o,s])=>s.length>1).map(([o,s])=>({key:o,items:s}))}function tt(e,r,t){let o=r.map(({key:s,items:n})=>{let a=n.map(i=>i.name||i.id).join(", ");return`  ${t} ${s}: ${a}`}).join(`
`);return`${e} have duplicate ${t}s:
${o}`}function ot(e,r){let t=r.sources.filter(c=>!c?.disabled),o=r.embeds.filter(c=>!c?.disabled),s=[...t,...o],n=rt(s,c=>c.id);if(n.length>0)throw new Error(tt("Sources/embeds",n,"ID"));let a=rt(t,c=>c.rank);if(a.length>0)throw new Error(tt("Sources",a,"rank"));let i=rt(o,c=>c.rank);if(i.length>0)throw new Error(tt("Embeds",i,"rank"));return{sources:t.filter(c=>X(e,c.flags)),embeds:o}}function st(e){let r=qr(e.proxyStreams?"any":e.target,e.consistentIpForRequests??!1,e.proxyStreams),t=[...G()];e.externalSources==="all"?t.push(...Y()):e.externalSources?.forEach(s=>{let n=Y().find(a=>a.id===s);n&&t.push(n)});let o=ot(r,{embeds:ee(),sources:t});return Hr({embeds:o.embeds,sources:o.sources,features:r,fetcher:e.fetcher,proxiedFetcher:e.proxiedFetcher,proxyStreams:e.proxyStreams})}var sa=P(require("form-data"),1);var oa=()=>{try{return require("react-native"),!0}catch{return!1}};function na(e){return e===void 0||typeof e=="string"||e instanceof URLSearchParams||e instanceof sa.default?e instanceof URLSearchParams&&oa()?{headers:{"Content-Type":"application/x-www-form-urlencoded"},body:e.toString()}:{headers:{},body:e}:{headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}}function pl(e,r){let t=new Headers;return e.forEach(o=>{let s=o.toLowerCase(),n=r.headers.get(s),i=r.extraHeaders?.get(s)??n;i&&t.set(s,i)}),t}function Ue(e){return async(t,o)=>{let s=Nr(t,o),n=na(o.body),a=new AbortController,i=15e3,c=setTimeout(()=>a.abort(),i);try{let l=await e(s,{method:o.method,headers:{...n.headers,...o.headers},body:n.body,credentials:o.credentials,signal:a.signal});clearTimeout(c);let d;return l.headers.get("content-type")?.includes("application/json")?d=await l.json():d=await l.text(),{body:d,finalUrl:l.extraUrl??l.url,headers:pl(o.readHeaders,l),statusCode:l.status}}catch(l){throw l.name==="AbortError"?new Error(`Fetch request to ${s} timed out after ${i}ms`):l}}}var id=P(ri(),1);function ti(){let e=process.env.MOVIE_WEB_TMDB_API_KEY??"";if(e=e.trim(),!e)throw new Error("Missing MOVIE_WEB_TMDB_API_KEY environment variable");let r=process.env.MOVIE_WEB_PROXY_URL;return r=r||void 0,{tmdbApiKey:e,proxyUrl:r}}async function xr(e,r){let t={accept:"application/json"},o=new URL(e),s=ti().tmdbApiKey;return s.startsWith("ey")?t.authorization=`Bearer ${s}`:o.searchParams.append("api_key",s),r&&o.searchParams.append("append_to_response",r),fetch(o,{method:"GET",headers:t})}async function oi(e){let t=await(await xr(`https://api.themoviedb.org/3/movie/${e}`,"external_ids")).json();if(t.success===!1)throw new Error(t.status_message);if(!t.release_date)throw new Error(`${t.title} has no release_date. Assuming unreleased`);return{type:"movie",title:t.title,releaseYear:Number(t.release_date.split("-")[0]),tmdbId:e,imdbId:t.imdb_id}}async function si(e,r,t){let o=await xr(`https://api.themoviedb.org/3/tv/${e}`,"external_ids"),s=await o.json();if(s.success===!1)throw new Error(s.status_message);if(!s.first_air_date)throw new Error(`${s.name} has no first_air_date. Assuming unaired`);o=await xr(`https://api.themoviedb.org/3/tv/${e}/season/${r}`);let n=await o.json();if(n.success===!1)throw new Error(n.status_message);o=await xr(`https://api.themoviedb.org/3/tv/${e}/season/${r}/episode/${t}`);let a=await o.json();if(a.success===!1)throw new Error(a.status_message);return{type:"show",title:s.name,releaseYear:Number(s.first_air_date.split("-")[0]),tmdbId:e,episode:{number:a.episode_number,tmdbId:a.id},season:{number:n.season_number,tmdbId:n.id},imdbId:s.external_ids.imdb_id}}async function cd(e,r,t){throw new Error("Browser scraping is no longer supported.")}async function Or(e,r,t){if(t.fetcher==="browser")return cd(e,r,t);let o=st(e);if(r.type==="embed")return o.runEmbedScraper({disableOpensubtitles:!0,url:t.url,id:r.id});if(r.type==="source"){let s;return t.type==="movie"?s=await oi(t.tmdbId):s=await si(t.tmdbId,t.season,t.episode),o.runSourceScraper({disableOpensubtitles:!0,media:s,id:r.id})}throw new Error("Invalid source type")}var ni=P(require("node-fetch"),1);async function Rr(e,r){let t=["node-fetch","native","browser"];if(!t.includes(r.fetcher))throw new Error(`Fetcher must be any of: ${t.join()}`);if(!r.sourceId.trim())throw new Error("Source ID must be provided");let o=e.find(({id:a})=>a===r.sourceId);if(!o)throw new Error("Invalid source ID. No source found");if(o.type==="embed"&&!r.url.trim())throw new Error("Must provide an embed URL for embed sources");if(o.type==="source"){if(!r.tmdbId.trim())throw new Error("Must provide a TMDB ID for provider sources");if(Number.isNaN(Number(r.tmdbId))||Number(r.tmdbId)<0)throw new Error("TMDB ID must be a number greater than 0");if(!r.type.trim())throw new Error("Must provide a type for provider sources");if(r.type!=="movie"&&r.type!=="show")throw new Error("Invalid media type. Must be either 'movie' or 'show'");if(r.type==="show"){if(!r.season.trim())throw new Error("Must provide a season number for TV shows");if(!r.episode.trim())throw new Error("Must provide an episode number for TV shows");if(Number.isNaN(Number(r.season))||Number(r.season)<=0)throw new Error("Season number must be a number greater than 0");if(Number.isNaN(Number(r.episode))||Number(r.episode)<=0)throw new Error("Episode number must be a number greater than 0")}}let s;return r.fetcher==="native"?s=Ue(fetch):s=Ue(ni.default),{providerOptions:{fetcher:s,target:Dr.ANY,consistentIpForRequests:!0,externalSources:"all"},options:r,source:o}}De();var ld=1800*1e3,hi={tmdbId:"19995",type:"movie",title:"Avatar",year:"2009"},gi=[];async function dd(e){let r=Date.now();try{let t={fetcher:"native",sourceId:e,tmdbId:hi.tmdbId,type:hi.type,season:"0",episode:"0",url:""},{providerOptions:o,source:s,options:n}=await Rr(gi,t),i=!!(await Or(o,s,n))?.stream?.length,c=Date.now()-r;await Et(e,{status:i?"operational":"offline",latency:c,lastChecked:Date.now(),error:i?null:"No streams found"}),console.log(`[HEALTH] ${e}: ${i?"OK":"FAIL"} (${c}ms)`)}catch(t){let o=Date.now()-r;await Et(e,{status:"offline",latency:o,lastChecked:Date.now(),error:t.message}),console.error(`[HEALTH] ${e}: ERROR (${o}ms) - ${t.message}`)}}function yi(){console.log("[HEALTH] Starting health check loop...");let e=[...G(),...Y()].sort((o,s)=>s.rank-o.rank),r=ee().sort((o,s)=>s.rank-o.rank);gi=[...e,...r];let t=async()=>{let o=G();console.log(`[HEALTH] Checking ${o.length} providers...`);for(let s of o)await dd(s.id),await new Promise(n=>{setTimeout(n,5e3)});console.log("[HEALTH] All checks completed.")};t(),setInterval(t,ld)}De();var kt=class{constructor(){this.maxSegmentsPerMinute=500;this.maxBurstSegments=100;this.burstWindowMs=5e3}async checkRateLimit(r,t){let o=`ratelimit:${r}:${t}`,s=await Me(o),n=Date.now();if(!s)return await this.recordRequest(o,n),{allowed:!0};let a=n-s.firstRequest;if(a<this.burstWindowMs&&s.count>=this.maxBurstSegments)return console.log(`[RATE LIMIT] Burst limit exceeded for ${t} - ${s.count} requests in ${a}ms`),{allowed:!1,reason:"Too many requests. Please wait a moment."};let i=n-6e4;if(s.firstRequest>i){if(s.count>=this.maxSegmentsPerMinute)return console.log(`[RATE LIMIT] Sustained limit exceeded for ${t} - ${s.count} requests/min`),{allowed:!1,reason:"Rate limit exceeded. Are you trying to download this video?"}}else return await this.recordRequest(o,n,void 0,!0),{allowed:!0};return await this.recordRequest(o,n,s,!1),{allowed:!0}}async recordRequest(r,t,o,s=!1){let n=s||!o?{count:1,firstRequest:t,lastRequest:t}:{count:o.count+1,firstRequest:o.firstRequest,lastRequest:t};await Ie(r,n)}detectDownloadTool(r){let t=["ffmpeg","youtube-dl","yt-dlp","curl","wget","aria2","IDM","streamlink","vlc","python-requests","Lavf"],o=r.toLowerCase();return t.some(s=>o.includes(s.toLowerCase()))}},Ct=new kt;De();var xt={};function qe(e,r,t){xt[e]||(xt[e]={status:"operational",responseTime:0,uptime:100,totalRequests:0,successfulRequests:0,failedRequests:0,lastChecked:Date.now()});let o=xt[e];o.totalRequests++,o.lastChecked=Date.now(),r?(o.successfulRequests++,o.responseTime=Math.round((o.responseTime*(o.successfulRequests-1)+t)/o.successfulRequests)):o.failedRequests++,o.uptime=Math.round(o.successfulRequests/o.totalRequests*100),o.uptime>=80?o.status="operational":o.uptime>=50?o.status="degraded":o.status="offline"}Rt();async function wi(e,r){let t=process.env.CLOUDFLARE_TURNSTILE_SECRET_KEY;if(!t)return!0;try{let o=new URLSearchParams;return o.append("secret",t),o.append("response",e),r&&o.append("remoteip",r),!!(await(await fetch("https://challenges.cloudflare.com/turnstile/v0/siteverify",{method:"POST",body:o,headers:{"Content-Type":"application/x-www-form-urlencoded"}})).json()).success}catch{return!1}}function vi(e,r,t){if(process.env.CLOUDFLARE_TURNSTILE_ENABLED!=="true")return t();let o=e.get("referer")||e.get("origin")||"";if((process.env.ALLOWED_DOMAINS?.split(",").map(a=>a.trim())||[]).some(a=>o.includes(a))){let a=e.get("cf-turnstile-token")||e.query.turnstileToken;if(!a)return t();wi(a,e.ip).then(i=>i?t():r.status(403).json({error:"Invalid challenge response"})).catch(()=>r.status(500).json({error:"Challenge verification failed"}))}else{let a=e.get("cf-turnstile-token")||e.query.turnstileToken;if(!a)return r.status(403).json({error:"Challenge required",message:"Please complete the security challenge"});wi(a,e.ip).then(i=>i?t():r.status(403).json({error:"Invalid challenge response"})).catch(()=>r.status(500).json({error:"Challenge verification failed"}))}}Mi.default.config();var j=(0,Mt.default)(),Ci=process.env.PORT||3e3,xi=process.env.API_KEY;j.set("trust proxy",1);j.use((0,Ri.default)());j.use(Mt.default.json());var fd=(0,It.default)({windowMs:900*1e3,max:100,message:"Too many requests from this IP, please try again later.",standardHeaders:!0,legacyHeaders:!1,skip:e=>e.ip==="127.0.0.1"||e.ip==="::1"}),hd=(0,It.default)({windowMs:300*1e3,max:20,message:"Too many scraping requests, please slow down.",standardHeaders:!0,legacyHeaders:!1,skip:e=>e.ip==="127.0.0.1"||e.ip==="::1"}),gd=(0,Ii.default)({windowMs:900*1e3,delayAfter:50,delayMs:()=>500,maxDelayMs:5e3,skip:e=>e.ip==="127.0.0.1"||e.ip==="::1"});j.use(fd);j.use(gd);var yd=(e,r,t)=>{if(process.env.CLOUDFLARE_MODE==="true"){let o=e.get("cf-ray"),s=e.get("cf-connecting-ip");if(!o&&!s&&(console.log("[SECURITY] Request without Cloudflare headers from:",e.ip),process.env.CLOUDFLARE_STRICT==="true"))return r.status(403).json({error:"Access denied"})}t()};j.use(yd);var $i=process.env.ALLOWED_DOMAINS?process.env.ALLOWED_DOMAINS.split(",").map(e=>e.trim()):["localhost:3000","localhost:3001"];console.log("Allowed domains for stream access:",$i);function Pi(e,r,t){let o=e.get("referer")||e.get("origin")||"",s=e.get("host")||"";return o?o.includes(s)||$i.some(a=>o.includes(a)||o.includes(`://${a}`))?t():(console.log(`[BLOCKED] Unauthorized domain access from: ${o}`),r.status(403).send("Access denied: Domain not authorized")):(console.log(`[BLOCKED] Direct URL access attempt (No Referer) from IP: ${e.ip}`),r.status(403).send("Access denied: Direct access not allowed"))}j.get("/test",(e,r)=>{r.sendFile("test-api.html",{root:process.cwd()})});var bd=[...G(),...Y()].sort((e,r)=>r.rank-e.rank),Sd=ee().sort((e,r)=>r.rank-e.rank),$t=[...bd,...Sd],Ai=(e,r,t)=>{let o=e.headers["x-api-key"]||e.query.apiKey;return xi?o===xi?t():r.status(401).json({error:"Unauthorized: Invalid API Key"}):(console.warn("API_KEY not set in environment variables. allowing all requests (NOT RECOMMENDED)"),t())};j.get("/sources",Ai,(e,r)=>{let t=$t.map(o=>({id:o.id,name:o.name,rank:o.rank,type:o.type,mediaTypes:o.mediaTypes||[]}));r.json(t)});j.get("/status",async(e,r)=>{let t=await fi(),o={},s=$t.filter(n=>n.type==="source");for(let n of s)t[n.id]?o[n.id]=t[n.id]:o[n.id]={status:"untested",latency:0,lastChecked:0,error:null};r.json(o)});j.get("/cdn",Ai,hd,vi,async(e,r)=>{let t=Date.now();try{let{sourceId:o,tmdbId:s,type:n,season:a,episode:i,url:c,force:l}=e.query;if(!o)return r.status(400).json({error:"Missing sourceId"});let d=String(o),u=String(s||""),m=String(n||"movie"),h=String(a||"0"),f=String(i||"0"),y=String(c||""),b=mi(d,u,m,h,f);if(l!=="true"){let D=await Me(b);if(D){console.log(`[Cache Hit] ${b}`);let H=Date.now()-t;qe(d,!0,H);let K={...D,stream:await Promise.all((D.stream||[]).map(async J=>{let Fr=await Mr(J.playlist,J.headers||{},e.ip,e.get("user-agent"));return{...J,playlist:`${e.protocol}://${e.get("host")}/s/${Fr}`,headers:{}}}))};return r.json(K)}}console.log(`[Scraping] ${d} - ${m} ${u}`);let C={fetcher:"native",sourceId:d,tmdbId:u,type:m,season:h,episode:f,url:y},{providerOptions:x,source:E,options:L}=await Rr($t,C),_=await Or(x,E,L);if(_){let{getMediaMetadata:D}=await Promise.resolve().then(()=>(ki(),Ei)),H=await D(u,m,h,f),K={..._,metadata:H?{...H,scrapedAt:new Date().toISOString(),timestamp:Date.now()}:void 0};await Ie(b,K);let J=Date.now()-t;qe(d,!0,J);let Fr={..._,stream:await Promise.all((_.stream||[]).map(async Lr=>{let Fi=await Mr(Lr.playlist,Lr.headers||{},e.ip,e.get("user-agent"));return{...Lr,playlist:`${e.protocol}://${e.get("host")}/s/${Fi}`,headers:{}}}))};return r.json(Fr)}let k=Date.now()-t;return qe(d,!1,k),r.status(404).json({error:"Stream not found"})}catch(o){console.error("Scraping Error:",o);let s=String(e.query.sourceId||"unknown"),n=Date.now()-t;return qe(s,!1,n),r.status(500).json({error:o.message||"Internal Server Error"})}});j.get("/s/:token",Pi,async(e,r)=>{try{let{token:t}=e.params,o=e.ip||"",s=e.get("user-agent")||"",n=await Ir(t,o,s);if(!n)return r.status(404).send("Not found");let a=await fetch(n.url,{headers:n.headers});if(!a.ok)return r.status(a.status).send("Failed to fetch");let i=await a.text();console.log("[STREAM PROXY] Original playlist URL:",n.url),console.log("[STREAM PROXY] Original playlist length:",i.length);let c=/RESOLUTION=(\d+x\d+)/g,l=Array.from(i.matchAll(c)).map(m=>m[1]);l.length>0&&console.log("[STREAM PROXY] Available qualities:",l.join(", "));let d=`${e.protocol}://${e.get("host")}`,u=await $r(i,d,t,n.url,o,s);r.setHeader("Content-Type","application/vnd.apple.mpegurl"),r.setHeader("Access-Control-Allow-Origin","*"),r.send(u)}catch(t){console.error("[STREAM PROXY ERROR]",{message:t.message,stack:t.stack,token:e.params.token}),r.status(500).send(`Stream Proxy Error: ${t.message}`)}});j.get("/s/:token/chunk/:segmentToken",Pi,async(e,r)=>{try{let{token:t,segmentToken:o}=e.params,s=e.ip||"",n=e.get("user-agent")||"";if(Ct.detectDownloadTool(n))return console.log(`[SECURITY] Download tool detected: ${n.substring(0,100)} from IP: ${s}`),r.status(403).send("Download tools are not permitted");let a=await Ct.checkRateLimit(t,s);if(!a.allowed)return console.log(`[RATE LIMIT] Blocked ${s} - ${a.reason}`),r.status(429).send(a.reason||"Too many requests");let i=await Ir(t,s,n);if(!i)return r.status(404).send("Not found");let{verifyEncryptedSegmentToken:c}=await Promise.resolve().then(()=>(Rt(),Si)),l=await c(o,t);if(!l)return r.status(404).send("Not found");let d=l.url,u=await fetch(d,{headers:i.headers});if(!u.ok)return r.status(u.status).send("Failed");let m=u.headers.get("content-type")||"";if(m.includes("mpegurl")||m.includes("m3u8")||d.includes(".m3u8")){let f=await u.text(),y=`${e.protocol}://${e.get("host")}`,b=await $r(f,y,t,d,s,n);r.setHeader("Content-Type","application/vnd.apple.mpegurl"),r.setHeader("Access-Control-Allow-Origin","*"),r.send(b)}else{let f=u.headers.get("content-length");r.setHeader("Content-Type",m||"video/mp2t"),r.setHeader("Access-Control-Allow-Origin","*"),r.setHeader("Cache-Control","public, max-age=31536000, immutable"),r.setHeader("Accept-Ranges","bytes"),f&&r.setHeader("Content-Length",f),u.body&&Oi.Readable.fromWeb(u.body).pipe(r)}}catch(t){console.error("Segment proxy error:",t),r.status(500).send("Error")}});yi();j.listen(Ci,()=>{console.log(`Server running on port ${Ci}`)});

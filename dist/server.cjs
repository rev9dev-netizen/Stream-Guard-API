"use strict";var $i=Object.create;var Lr=Object.defineProperty;var Pi=Object.getOwnPropertyDescriptor;var Fi=Object.getOwnPropertyNames;var Ai=Object.getPrototypeOf,Li=Object.prototype.hasOwnProperty;var Ur=(e,r)=>()=>(e&&(r=e(e=0)),r);var M=(e,r)=>()=>(r||e((r={exports:{}}).exports,r),r.exports),Mt=(e,r)=>{for(var t in r)Lr(e,t,{get:r[t],enumerable:!0})},Ui=(e,r,t,o)=>{if(r&&typeof r=="object"||typeof r=="function")for(let s of Fi(r))!Li.call(e,s)&&s!==t&&Lr(e,s,{get:()=>r[s],enumerable:!(o=Pi(r,s))||o.enumerable});return e};var P=(e,r,t)=>(t=e!=null?$i(Ai(e)):{},Ui(r||!e||!e.__esModule?Lr(t,"default",{value:e,enumerable:!0}):t,e));async function we(e){if(!V)return null;try{return await V.get(e)}catch(r){return console.error("Redis get error:",r),null}}async function ve(e,r,t=ia){if(V)try{await V.set(e,r,{ex:t})}catch(o){console.error("Redis set error:",o)}}async function ca(e,r,t=ia){if(V)try{let o=`seg:${e}`;await V.hset(o,r),await V.expire(o,t)}catch(o){console.error("Redis batch set error:",o)}}async function da(e,r){if(!V)return null;try{let t=`seg:${e}`;return await V.hget(t,r)}catch(t){return console.error("Redis hash get error:",t),null}}function la(e,r,t,o,s){return`stream:${e}:${r}:${t}:${o||"0"}:${s||"0"}`}var na,aa,oa,sa,V,ia,dr=Ur(()=>{"use strict";na=require("@upstash/redis"),aa=P(require("dotenv"),1);aa.default.config();oa=process.env.UPSTASH_REDIS_REST_URL,sa=process.env.UPSTASH_REDIS_REST_TOKEN,V=null;oa&&sa?(console.log("Initializing Redis connection..."),V=new na.Redis({url:oa,token:sa})):console.warn("UPSTASH_REDIS_REST_URL or UPSTASH_REDIS_REST_TOKEN not set, caching will be disabled");ia=3600*4});var ma={};Mt(ma,{encryptPlaylistContent:()=>mr,generateStreamToken:()=>pr,getStreamMetadata:()=>ur,verifyEncryptedSegmentToken:()=>dd});async function cd(e,r,t){let o=[];e.replace(r,(n,...a)=>(o.push(t(n,...a)),n));let s=await Promise.all(o);return e.replace(r,()=>s.shift()||"")}async function pr(e,r,t,o){let s=Z.default.randomBytes(32).toString("hex"),n=Date.now()+14400*1e3,a={url:e,headers:r,expiresAt:n,ip:t,userAgent:o};return await ve(`stream:token:${s}`,a),s}async function ur(e,r,t){let o=await we(`stream:token:${e}`);return!o||Date.now()>o.expiresAt?null:o.ip&&r&&o.ip!==r?(console.log(`[SECURITY] IP mismatch for token. Expected: ${o.ip}, Got: ${r}`),null):o.userAgent&&t&&o.userAgent!==t?(console.log("[SECURITY] User-Agent mismatch for token"),null):o}async function ua(e,r,t){let o=Z.default.createHash("sha256").update(t).digest(),s=Z.default.randomBytes(12),n=Z.default.createCipheriv("aes-256-gcm",o,s),a=JSON.stringify({url:e,exp:r}),i=at.default.deflateSync(a),c=n.update(i),d=n.final();c=Buffer.concat([c,d]);let l=n.getAuthTag(),m=Buffer.concat([s,c,l]).toString("base64url");return{shortId:Z.default.randomBytes(8).toString("hex"),encryptedData:m}}async function mr(e,r,t,o,s,n){let a=e.split(`
`),i={},c=Date.now()+14400*1e3,d=await Promise.all(a.map(async u=>{let m=u.trim();if(m.startsWith("#")&&m.includes('URI="'))return cd(u,/URI="([^"]+)"/g,async(y,C)=>{let x=C;if(!C.startsWith("http")){let _=new URL(o);if(C.startsWith("/"))x=`${_.protocol}//${_.host}${C}`;else{let k=_.pathname.split("/");k.pop(),x=`${_.protocol}//${_.host}${k.join("/")}/${C}`}}let{shortId:E,encryptedData:L}=await ua(x,c,t);return i[E]=L,`URI="${r}/s/${t}/chunk/${E}"`});if(!m||m.startsWith("#"))return u;let h=m;if(!m.startsWith("http")){let y=new URL(o);if(m.startsWith("/"))h=`${y.protocol}//${y.host}${m}`;else{let C=y.pathname.split("/");C.pop(),h=`${y.protocol}//${y.host}${C.join("/")}/${m}`}}let{shortId:f,encryptedData:b}=await ua(h,c,t);return i[f]=b,`${r}/s/${t}/chunk/${f}`})),l=Math.ceil((c-Date.now())/1e3);return await ca(t,i,l),d.join(`
`)}async function dd(e,r){try{let t=await da(r,e);if(!t)return null;let o=Buffer.from(t,"base64url"),s=o.subarray(0,12),n=o.subarray(o.length-16),a=o.subarray(12,o.length-16),i=Z.default.createHash("sha256").update(r).digest(),c=Z.default.createDecipheriv("aes-256-gcm",i,s);c.setAuthTag(n);let d=Buffer.concat([c.update(a),c.final()]),l=at.default.inflateSync(d).toString("utf8"),u=JSON.parse(l);return u.exp<Date.now()?null:{url:u.url,expiresAt:u.exp}}catch{return null}}var Z,at,it=Ur(()=>{"use strict";Z=P(require("crypto"),1),at=P(require("zlib"),1);dr()});var ba=M((oS,ga)=>{"use strict";var ld=/[|\\{}()[\]^$+*?.]/g;ga.exports=function(e){if(typeof e!="string")throw new TypeError("Expected a string");return e.replace(ld,"\\$&")}});var Sa=M((sS,ya)=>{"use strict";ya.exports={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]}});var ct=M((nS,ka)=>{var re=Sa(),Ea={};for(fr in re)re.hasOwnProperty(fr)&&(Ea[re[fr]]=fr);var fr,w=ka.exports={rgb:{channels:3,labels:"rgb"},hsl:{channels:3,labels:"hsl"},hsv:{channels:3,labels:"hsv"},hwb:{channels:3,labels:"hwb"},cmyk:{channels:4,labels:"cmyk"},xyz:{channels:3,labels:"xyz"},lab:{channels:3,labels:"lab"},lch:{channels:3,labels:"lch"},hex:{channels:1,labels:["hex"]},keyword:{channels:1,labels:["keyword"]},ansi16:{channels:1,labels:["ansi16"]},ansi256:{channels:1,labels:["ansi256"]},hcg:{channels:3,labels:["h","c","g"]},apple:{channels:3,labels:["r16","g16","b16"]},gray:{channels:1,labels:["gray"]}};for(N in w)if(w.hasOwnProperty(N)){if(!("channels"in w[N]))throw new Error("missing channels property: "+N);if(!("labels"in w[N]))throw new Error("missing channel labels property: "+N);if(w[N].labels.length!==w[N].channels)throw new Error("channel and label counts mismatch: "+N);wa=w[N].channels,va=w[N].labels,delete w[N].channels,delete w[N].labels,Object.defineProperty(w[N],"channels",{value:wa}),Object.defineProperty(w[N],"labels",{value:va})}var wa,va,N;w.rgb.hsl=function(e){var r=e[0]/255,t=e[1]/255,o=e[2]/255,s=Math.min(r,t,o),n=Math.max(r,t,o),a=n-s,i,c,d;return n===s?i=0:r===n?i=(t-o)/a:t===n?i=2+(o-r)/a:o===n&&(i=4+(r-t)/a),i=Math.min(i*60,360),i<0&&(i+=360),d=(s+n)/2,n===s?c=0:d<=.5?c=a/(n+s):c=a/(2-n-s),[i,c*100,d*100]};w.rgb.hsv=function(e){var r,t,o,s,n,a=e[0]/255,i=e[1]/255,c=e[2]/255,d=Math.max(a,i,c),l=d-Math.min(a,i,c),u=function(m){return(d-m)/6/l+1/2};return l===0?s=n=0:(n=l/d,r=u(a),t=u(i),o=u(c),a===d?s=o-t:i===d?s=1/3+r-o:c===d&&(s=2/3+t-r),s<0?s+=1:s>1&&(s-=1)),[s*360,n*100,d*100]};w.rgb.hwb=function(e){var r=e[0],t=e[1],o=e[2],s=w.rgb.hsl(e)[0],n=1/255*Math.min(r,Math.min(t,o));return o=1-1/255*Math.max(r,Math.max(t,o)),[s,n*100,o*100]};w.rgb.cmyk=function(e){var r=e[0]/255,t=e[1]/255,o=e[2]/255,s,n,a,i;return i=Math.min(1-r,1-t,1-o),s=(1-r-i)/(1-i)||0,n=(1-t-i)/(1-i)||0,a=(1-o-i)/(1-i)||0,[s*100,n*100,a*100,i*100]};function pd(e,r){return Math.pow(e[0]-r[0],2)+Math.pow(e[1]-r[1],2)+Math.pow(e[2]-r[2],2)}w.rgb.keyword=function(e){var r=Ea[e];if(r)return r;var t=1/0,o;for(var s in re)if(re.hasOwnProperty(s)){var n=re[s],a=pd(e,n);a<t&&(t=a,o=s)}return o};w.keyword.rgb=function(e){return re[e]};w.rgb.xyz=function(e){var r=e[0]/255,t=e[1]/255,o=e[2]/255;r=r>.04045?Math.pow((r+.055)/1.055,2.4):r/12.92,t=t>.04045?Math.pow((t+.055)/1.055,2.4):t/12.92,o=o>.04045?Math.pow((o+.055)/1.055,2.4):o/12.92;var s=r*.4124+t*.3576+o*.1805,n=r*.2126+t*.7152+o*.0722,a=r*.0193+t*.1192+o*.9505;return[s*100,n*100,a*100]};w.rgb.lab=function(e){var r=w.rgb.xyz(e),t=r[0],o=r[1],s=r[2],n,a,i;return t/=95.047,o/=100,s/=108.883,t=t>.008856?Math.pow(t,1/3):7.787*t+16/116,o=o>.008856?Math.pow(o,1/3):7.787*o+16/116,s=s>.008856?Math.pow(s,1/3):7.787*s+16/116,n=116*o-16,a=500*(t-o),i=200*(o-s),[n,a,i]};w.hsl.rgb=function(e){var r=e[0]/360,t=e[1]/100,o=e[2]/100,s,n,a,i,c;if(t===0)return c=o*255,[c,c,c];o<.5?n=o*(1+t):n=o+t-o*t,s=2*o-n,i=[0,0,0];for(var d=0;d<3;d++)a=r+1/3*-(d-1),a<0&&a++,a>1&&a--,6*a<1?c=s+(n-s)*6*a:2*a<1?c=n:3*a<2?c=s+(n-s)*(2/3-a)*6:c=s,i[d]=c*255;return i};w.hsl.hsv=function(e){var r=e[0],t=e[1]/100,o=e[2]/100,s=t,n=Math.max(o,.01),a,i;return o*=2,t*=o<=1?o:2-o,s*=n<=1?n:2-n,i=(o+t)/2,a=o===0?2*s/(n+s):2*t/(o+t),[r,a*100,i*100]};w.hsv.rgb=function(e){var r=e[0]/60,t=e[1]/100,o=e[2]/100,s=Math.floor(r)%6,n=r-Math.floor(r),a=255*o*(1-t),i=255*o*(1-t*n),c=255*o*(1-t*(1-n));switch(o*=255,s){case 0:return[o,c,a];case 1:return[i,o,a];case 2:return[a,o,c];case 3:return[a,i,o];case 4:return[c,a,o];case 5:return[o,a,i]}};w.hsv.hsl=function(e){var r=e[0],t=e[1]/100,o=e[2]/100,s=Math.max(o,.01),n,a,i;return i=(2-t)*o,n=(2-t)*s,a=t*s,a/=n<=1?n:2-n,a=a||0,i/=2,[r,a*100,i*100]};w.hwb.rgb=function(e){var r=e[0]/360,t=e[1]/100,o=e[2]/100,s=t+o,n,a,i,c;s>1&&(t/=s,o/=s),n=Math.floor(6*r),a=1-o,i=6*r-n,(n&1)!==0&&(i=1-i),c=t+i*(a-t);var d,l,u;switch(n){default:case 6:case 0:d=a,l=c,u=t;break;case 1:d=c,l=a,u=t;break;case 2:d=t,l=a,u=c;break;case 3:d=t,l=c,u=a;break;case 4:d=c,l=t,u=a;break;case 5:d=a,l=t,u=c;break}return[d*255,l*255,u*255]};w.cmyk.rgb=function(e){var r=e[0]/100,t=e[1]/100,o=e[2]/100,s=e[3]/100,n,a,i;return n=1-Math.min(1,r*(1-s)+s),a=1-Math.min(1,t*(1-s)+s),i=1-Math.min(1,o*(1-s)+s),[n*255,a*255,i*255]};w.xyz.rgb=function(e){var r=e[0]/100,t=e[1]/100,o=e[2]/100,s,n,a;return s=r*3.2406+t*-1.5372+o*-.4986,n=r*-.9689+t*1.8758+o*.0415,a=r*.0557+t*-.204+o*1.057,s=s>.0031308?1.055*Math.pow(s,1/2.4)-.055:s*12.92,n=n>.0031308?1.055*Math.pow(n,1/2.4)-.055:n*12.92,a=a>.0031308?1.055*Math.pow(a,1/2.4)-.055:a*12.92,s=Math.min(Math.max(0,s),1),n=Math.min(Math.max(0,n),1),a=Math.min(Math.max(0,a),1),[s*255,n*255,a*255]};w.xyz.lab=function(e){var r=e[0],t=e[1],o=e[2],s,n,a;return r/=95.047,t/=100,o/=108.883,r=r>.008856?Math.pow(r,1/3):7.787*r+16/116,t=t>.008856?Math.pow(t,1/3):7.787*t+16/116,o=o>.008856?Math.pow(o,1/3):7.787*o+16/116,s=116*t-16,n=500*(r-t),a=200*(t-o),[s,n,a]};w.lab.xyz=function(e){var r=e[0],t=e[1],o=e[2],s,n,a;n=(r+16)/116,s=t/500+n,a=n-o/200;var i=Math.pow(n,3),c=Math.pow(s,3),d=Math.pow(a,3);return n=i>.008856?i:(n-16/116)/7.787,s=c>.008856?c:(s-16/116)/7.787,a=d>.008856?d:(a-16/116)/7.787,s*=95.047,n*=100,a*=108.883,[s,n,a]};w.lab.lch=function(e){var r=e[0],t=e[1],o=e[2],s,n,a;return s=Math.atan2(o,t),n=s*360/2/Math.PI,n<0&&(n+=360),a=Math.sqrt(t*t+o*o),[r,a,n]};w.lch.lab=function(e){var r=e[0],t=e[1],o=e[2],s,n,a;return a=o/360*2*Math.PI,s=t*Math.cos(a),n=t*Math.sin(a),[r,s,n]};w.rgb.ansi16=function(e){var r=e[0],t=e[1],o=e[2],s=1 in arguments?arguments[1]:w.rgb.hsv(e)[2];if(s=Math.round(s/50),s===0)return 30;var n=30+(Math.round(o/255)<<2|Math.round(t/255)<<1|Math.round(r/255));return s===2&&(n+=60),n};w.hsv.ansi16=function(e){return w.rgb.ansi16(w.hsv.rgb(e),e[2])};w.rgb.ansi256=function(e){var r=e[0],t=e[1],o=e[2];if(r===t&&t===o)return r<8?16:r>248?231:Math.round((r-8)/247*24)+232;var s=16+36*Math.round(r/255*5)+6*Math.round(t/255*5)+Math.round(o/255*5);return s};w.ansi16.rgb=function(e){var r=e%10;if(r===0||r===7)return e>50&&(r+=3.5),r=r/10.5*255,[r,r,r];var t=(~~(e>50)+1)*.5,o=(r&1)*t*255,s=(r>>1&1)*t*255,n=(r>>2&1)*t*255;return[o,s,n]};w.ansi256.rgb=function(e){if(e>=232){var r=(e-232)*10+8;return[r,r,r]}e-=16;var t,o=Math.floor(e/36)/5*255,s=Math.floor((t=e%36)/6)/5*255,n=t%6/5*255;return[o,s,n]};w.rgb.hex=function(e){var r=((Math.round(e[0])&255)<<16)+((Math.round(e[1])&255)<<8)+(Math.round(e[2])&255),t=r.toString(16).toUpperCase();return"000000".substring(t.length)+t};w.hex.rgb=function(e){var r=e.toString(16).match(/[a-f0-9]{6}|[a-f0-9]{3}/i);if(!r)return[0,0,0];var t=r[0];r[0].length===3&&(t=t.split("").map(function(i){return i+i}).join(""));var o=parseInt(t,16),s=o>>16&255,n=o>>8&255,a=o&255;return[s,n,a]};w.rgb.hcg=function(e){var r=e[0]/255,t=e[1]/255,o=e[2]/255,s=Math.max(Math.max(r,t),o),n=Math.min(Math.min(r,t),o),a=s-n,i,c;return a<1?i=n/(1-a):i=0,a<=0?c=0:s===r?c=(t-o)/a%6:s===t?c=2+(o-r)/a:c=4+(r-t)/a+4,c/=6,c%=1,[c*360,a*100,i*100]};w.hsl.hcg=function(e){var r=e[1]/100,t=e[2]/100,o=1,s=0;return t<.5?o=2*r*t:o=2*r*(1-t),o<1&&(s=(t-.5*o)/(1-o)),[e[0],o*100,s*100]};w.hsv.hcg=function(e){var r=e[1]/100,t=e[2]/100,o=r*t,s=0;return o<1&&(s=(t-o)/(1-o)),[e[0],o*100,s*100]};w.hcg.rgb=function(e){var r=e[0]/360,t=e[1]/100,o=e[2]/100;if(t===0)return[o*255,o*255,o*255];var s=[0,0,0],n=r%1*6,a=n%1,i=1-a,c=0;switch(Math.floor(n)){case 0:s[0]=1,s[1]=a,s[2]=0;break;case 1:s[0]=i,s[1]=1,s[2]=0;break;case 2:s[0]=0,s[1]=1,s[2]=a;break;case 3:s[0]=0,s[1]=i,s[2]=1;break;case 4:s[0]=a,s[1]=0,s[2]=1;break;default:s[0]=1,s[1]=0,s[2]=i}return c=(1-t)*o,[(t*s[0]+c)*255,(t*s[1]+c)*255,(t*s[2]+c)*255]};w.hcg.hsv=function(e){var r=e[1]/100,t=e[2]/100,o=r+t*(1-r),s=0;return o>0&&(s=r/o),[e[0],s*100,o*100]};w.hcg.hsl=function(e){var r=e[1]/100,t=e[2]/100,o=t*(1-r)+.5*r,s=0;return o>0&&o<.5?s=r/(2*o):o>=.5&&o<1&&(s=r/(2*(1-o))),[e[0],s*100,o*100]};w.hcg.hwb=function(e){var r=e[1]/100,t=e[2]/100,o=r+t*(1-r);return[e[0],(o-r)*100,(1-o)*100]};w.hwb.hcg=function(e){var r=e[1]/100,t=e[2]/100,o=1-t,s=o-r,n=0;return s<1&&(n=(o-s)/(1-s)),[e[0],s*100,n*100]};w.apple.rgb=function(e){return[e[0]/65535*255,e[1]/65535*255,e[2]/65535*255]};w.rgb.apple=function(e){return[e[0]/255*65535,e[1]/255*65535,e[2]/255*65535]};w.gray.rgb=function(e){return[e[0]/100*255,e[0]/100*255,e[0]/100*255]};w.gray.hsl=w.gray.hsv=function(e){return[0,0,e[0]]};w.gray.hwb=function(e){return[0,100,e[0]]};w.gray.cmyk=function(e){return[0,0,0,e[0]]};w.gray.lab=function(e){return[e[0],0,0]};w.gray.hex=function(e){var r=Math.round(e[0]/100*255)&255,t=(r<<16)+(r<<8)+r,o=t.toString(16).toUpperCase();return"000000".substring(o.length)+o};w.rgb.gray=function(e){var r=(e[0]+e[1]+e[2])/3;return[r/255*100]}});var xa=M((aS,Ca)=>{var hr=ct();function ud(){for(var e={},r=Object.keys(hr),t=r.length,o=0;o<t;o++)e[r[o]]={distance:-1,parent:null};return e}function md(e){var r=ud(),t=[e];for(r[e].distance=0;t.length;)for(var o=t.pop(),s=Object.keys(hr[o]),n=s.length,a=0;a<n;a++){var i=s[a],c=r[i];c.distance===-1&&(c.distance=r[o].distance+1,c.parent=o,t.unshift(i))}return r}function fd(e,r){return function(t){return r(e(t))}}function hd(e,r){for(var t=[r[e].parent,e],o=hr[r[e].parent][e],s=r[e].parent;r[s].parent;)t.unshift(r[s].parent),o=fd(hr[r[s].parent][s],o),s=r[s].parent;return o.conversion=t,o}Ca.exports=function(e){for(var r=md(e),t={},o=Object.keys(r),s=o.length,n=0;n<s;n++){var a=o[n],i=r[a];i.parent!==null&&(t[a]=hd(a,r))}return t}});var Ra=M((iS,Oa)=>{var dt=ct(),gd=xa(),Ee={},bd=Object.keys(dt);function yd(e){var r=function(t){return t==null?t:(arguments.length>1&&(t=Array.prototype.slice.call(arguments)),e(t))};return"conversion"in e&&(r.conversion=e.conversion),r}function Sd(e){var r=function(t){if(t==null)return t;arguments.length>1&&(t=Array.prototype.slice.call(arguments));var o=e(t);if(typeof o=="object")for(var s=o.length,n=0;n<s;n++)o[n]=Math.round(o[n]);return o};return"conversion"in e&&(r.conversion=e.conversion),r}bd.forEach(function(e){Ee[e]={},Object.defineProperty(Ee[e],"channels",{value:dt[e].channels}),Object.defineProperty(Ee[e],"labels",{value:dt[e].labels});var r=gd(e),t=Object.keys(r);t.forEach(function(o){var s=r[o];Ee[e][o]=Sd(s),Ee[e][o].raw=yd(s)})});Oa.exports=Ee});var Ia=M((cS,Ma)=>{"use strict";var ke=Ra(),gr=(e,r)=>function(){return`\x1B[${e.apply(ke,arguments)+r}m`},br=(e,r)=>function(){let t=e.apply(ke,arguments);return`\x1B[${38+r};5;${t}m`},yr=(e,r)=>function(){let t=e.apply(ke,arguments);return`\x1B[${38+r};2;${t[0]};${t[1]};${t[2]}m`};function wd(){let e=new Map,r={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],gray:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};r.color.grey=r.color.gray;for(let s of Object.keys(r)){let n=r[s];for(let a of Object.keys(n)){let i=n[a];r[a]={open:`\x1B[${i[0]}m`,close:`\x1B[${i[1]}m`},n[a]=r[a],e.set(i[0],i[1])}Object.defineProperty(r,s,{value:n,enumerable:!1}),Object.defineProperty(r,"codes",{value:e,enumerable:!1})}let t=s=>s,o=(s,n,a)=>[s,n,a];r.color.close="\x1B[39m",r.bgColor.close="\x1B[49m",r.color.ansi={ansi:gr(t,0)},r.color.ansi256={ansi256:br(t,0)},r.color.ansi16m={rgb:yr(o,0)},r.bgColor.ansi={ansi:gr(t,10)},r.bgColor.ansi256={ansi256:br(t,10)},r.bgColor.ansi16m={rgb:yr(o,10)};for(let s of Object.keys(ke)){if(typeof ke[s]!="object")continue;let n=ke[s];s==="ansi16"&&(s="ansi"),"ansi16"in n&&(r.color.ansi[s]=gr(n.ansi16,0),r.bgColor.ansi[s]=gr(n.ansi16,10)),"ansi256"in n&&(r.color.ansi256[s]=br(n.ansi256,0),r.bgColor.ansi256[s]=br(n.ansi256,10)),"rgb"in n&&(r.color.ansi16m[s]=yr(n.rgb,0),r.bgColor.ansi16m[s]=yr(n.rgb,10))}return r}Object.defineProperty(Ma,"exports",{enumerable:!0,get:wd})});var Pa=M((dS,$a)=>{"use strict";$a.exports=(e,r)=>{r=r||process.argv;let t=e.startsWith("-")?"":e.length===1?"-":"--",o=r.indexOf(t+e),s=r.indexOf("--");return o!==-1&&(s===-1?!0:o<s)}});var Aa=M((lS,Fa)=>{"use strict";var vd=require("os"),H=Pa(),T=process.env,Ce;H("no-color")||H("no-colors")||H("color=false")?Ce=!1:(H("color")||H("colors")||H("color=true")||H("color=always"))&&(Ce=!0);"FORCE_COLOR"in T&&(Ce=T.FORCE_COLOR.length===0||parseInt(T.FORCE_COLOR,10)!==0);function Ed(e){return e===0?!1:{level:e,hasBasic:!0,has256:e>=2,has16m:e>=3}}function kd(e){if(Ce===!1)return 0;if(H("color=16m")||H("color=full")||H("color=truecolor"))return 3;if(H("color=256"))return 2;if(e&&!e.isTTY&&Ce!==!0)return 0;let r=Ce?1:0;if(process.platform==="win32"){let t=vd.release().split(".");return Number(process.versions.node.split(".")[0])>=8&&Number(t[0])>=10&&Number(t[2])>=10586?Number(t[2])>=14931?3:2:1}if("CI"in T)return["TRAVIS","CIRCLECI","APPVEYOR","GITLAB_CI"].some(t=>t in T)||T.CI_NAME==="codeship"?1:r;if("TEAMCITY_VERSION"in T)return/^(9\.(0*[1-9]\d*)\.|\d{2,}\.)/.test(T.TEAMCITY_VERSION)?1:0;if(T.COLORTERM==="truecolor")return 3;if("TERM_PROGRAM"in T){let t=parseInt((T.TERM_PROGRAM_VERSION||"").split(".")[0],10);switch(T.TERM_PROGRAM){case"iTerm.app":return t>=3?3:2;case"Apple_Terminal":return 2}}return/-256(color)?$/i.test(T.TERM)?2:/^screen|^xterm|^vt100|^vt220|^rxvt|color|ansi|cygwin|linux/i.test(T.TERM)||"COLORTERM"in T?1:(T.TERM==="dumb",r)}function lt(e){let r=kd(e);return Ed(r)}Fa.exports={supportsColor:lt,stdout:lt(process.stdout),stderr:lt(process.stderr)}});var _a=M((pS,Na)=>{"use strict";var Cd=/(?:\\(u[a-f\d]{4}|x[a-f\d]{2}|.))|(?:\{(~)?(\w+(?:\([^)]*\))?(?:\.\w+(?:\([^)]*\))?)*)(?:[ \t]|(?=\r?\n)))|(\})|((?:.|[\r\n\f])+?)/gi,La=/(?:^|\.)(\w+)(?:\(([^)]*)\))?/g,xd=/^(['"])((?:\\.|(?!\1)[^\\])*)\1$/,Od=/\\(u[a-f\d]{4}|x[a-f\d]{2}|.)|([^\\])/gi,Rd=new Map([["n",`
`],["r","\r"],["t","	"],["b","\b"],["f","\f"],["v","\v"],["0","\0"],["\\","\\"],["e","\x1B"],["a","\x07"]]);function Ta(e){return e[0]==="u"&&e.length===5||e[0]==="x"&&e.length===3?String.fromCharCode(parseInt(e.slice(1),16)):Rd.get(e)||e}function Md(e,r){let t=[],o=r.trim().split(/\s*,\s*/g),s;for(let n of o)if(!isNaN(n))t.push(Number(n));else if(s=n.match(xd))t.push(s[2].replace(Od,(a,i,c)=>i?Ta(i):c));else throw new Error(`Invalid Chalk template style argument: ${n} (in style '${e}')`);return t}function Id(e){La.lastIndex=0;let r=[],t;for(;(t=La.exec(e))!==null;){let o=t[1];if(t[2]){let s=Md(o,t[2]);r.push([o].concat(s))}else r.push([o])}return r}function Ua(e,r){let t={};for(let s of r)for(let n of s.styles)t[n[0]]=s.inverse?null:n.slice(1);let o=e;for(let s of Object.keys(t))if(Array.isArray(t[s])){if(!(s in o))throw new Error(`Unknown Chalk style: ${s}`);t[s].length>0?o=o[s].apply(o,t[s]):o=o[s]}return o}Na.exports=(e,r)=>{let t=[],o=[],s=[];if(r.replace(Cd,(n,a,i,c,d,l)=>{if(a)s.push(Ta(a));else if(c){let u=s.join("");s=[],o.push(t.length===0?u:Ua(e,t)(u)),t.push({inverse:i,styles:Id(c)})}else if(d){if(t.length===0)throw new Error("Found extraneous } in Chalk template literal");o.push(Ua(e,t)(s.join(""))),s=[],t.pop()}else s.push(l)}),o.push(s.join("")),t.length>0){let n=`Chalk template literal is missing ${t.length} closing bracket${t.length===1?"":"s"} (\`}\`)`;throw new Error(n)}return o.join("")}});var Wa=M((uS,_e)=>{"use strict";var ut=ba(),I=Ia(),pt=Aa().stdout,$d=_a(),qa=process.platform==="win32"&&!(process.env.TERM||"").toLowerCase().startsWith("xterm"),Ba=["ansi","ansi","ansi256","ansi16m"],ja=new Set(["gray"]),xe=Object.create(null);function Da(e,r){r=r||{};let t=pt?pt.level:0;e.level=r.level===void 0?t:r.level,e.enabled="enabled"in r?r.enabled:e.level>0}function Ne(e){if(!this||!(this instanceof Ne)||this.template){let r={};return Da(r,e),r.template=function(){let t=[].slice.call(arguments);return Ad.apply(null,[r.template].concat(t))},Object.setPrototypeOf(r,Ne.prototype),Object.setPrototypeOf(r.template,r),r.template.constructor=Ne,r.template}Da(this,e)}qa&&(I.blue.open="\x1B[94m");for(let e of Object.keys(I))I[e].closeRe=new RegExp(ut(I[e].close),"g"),xe[e]={get(){let r=I[e];return Sr.call(this,this._styles?this._styles.concat(r):[r],this._empty,e)}};xe.visible={get(){return Sr.call(this,this._styles||[],!0,"visible")}};I.color.closeRe=new RegExp(ut(I.color.close),"g");for(let e of Object.keys(I.color.ansi))ja.has(e)||(xe[e]={get(){let r=this.level;return function(){let o={open:I.color[Ba[r]][e].apply(null,arguments),close:I.color.close,closeRe:I.color.closeRe};return Sr.call(this,this._styles?this._styles.concat(o):[o],this._empty,e)}}});I.bgColor.closeRe=new RegExp(ut(I.bgColor.close),"g");for(let e of Object.keys(I.bgColor.ansi)){if(ja.has(e))continue;let r="bg"+e[0].toUpperCase()+e.slice(1);xe[r]={get(){let t=this.level;return function(){let s={open:I.bgColor[Ba[t]][e].apply(null,arguments),close:I.bgColor.close,closeRe:I.bgColor.closeRe};return Sr.call(this,this._styles?this._styles.concat(s):[s],this._empty,e)}}}}var Pd=Object.defineProperties(()=>{},xe);function Sr(e,r,t){let o=function(){return Fd.apply(o,arguments)};o._styles=e,o._empty=r;let s=this;return Object.defineProperty(o,"level",{enumerable:!0,get(){return s.level},set(n){s.level=n}}),Object.defineProperty(o,"enabled",{enumerable:!0,get(){return s.enabled},set(n){s.enabled=n}}),o.hasGrey=this.hasGrey||t==="gray"||t==="grey",o.__proto__=Pd,o}function Fd(){let e=arguments,r=e.length,t=String(arguments[0]);if(r===0)return"";if(r>1)for(let s=1;s<r;s++)t+=" "+e[s];if(!this.enabled||this.level<=0||!t)return this._empty?"":t;let o=I.dim.open;qa&&this.hasGrey&&(I.dim.open="");for(let s of this._styles.slice().reverse())t=s.open+t.replace(s.closeRe,s.open)+s.close,t=t.replace(/\r?\n/g,`${s.close}$&${s.open}`);return I.dim.open=o,t}function Ad(e,r){if(!Array.isArray(r))return[].slice.call(arguments,1).join(" ");let t=[].slice.call(arguments,2),o=[r.raw[0]];for(let s=1;s<r.length;s++)o.push(String(t[s-1]).replace(/[{}\\]/g,"\\$&")),o.push(String(r.raw[s]));return $d(e,o.join(""))}Object.defineProperties(Ne.prototype,xe);_e.exports=Ne();_e.exports.supportsColor=pt;_e.exports.default=_e.exports});var za=M((mS,mt)=>{"use strict";var Ha=(e,r)=>{for(let t of Reflect.ownKeys(r))Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t));return e};mt.exports=Ha;mt.exports.default=Ha});var Ka=M((fS,vr)=>{"use strict";var Ld=za(),wr=new WeakMap,Va=(e,r={})=>{if(typeof e!="function")throw new TypeError("Expected a function");let t,o=0,s=e.displayName||e.name||"<anonymous>",n=function(...a){if(wr.set(n,++o),o===1)t=e.apply(this,a),e=null;else if(r.throw===!0)throw new Error(`Function \`${s}\` can only be called once`);return t};return Ld(n,e),wr.set(n,o),n};vr.exports=Va;vr.exports.default=Va;vr.exports.callCount=e=>{if(!wr.has(e))throw new Error(`The given function \`${e.name}\` is not wrapped by the \`onetime\` package`);return wr.get(e)}});var Ja=M((hS,Er)=>{Er.exports=["SIGABRT","SIGALRM","SIGHUP","SIGINT","SIGTERM"];process.platform!=="win32"&&Er.exports.push("SIGVTALRM","SIGXCPU","SIGXFSZ","SIGUSR2","SIGTRAP","SIGSYS","SIGQUIT","SIGIOT");process.platform==="linux"&&Er.exports.push("SIGIO","SIGPOLL","SIGPWR","SIGSTKFLT","SIGUNUSED")});var Qa=M((gS,Me)=>{var R=global.process,te=function(e){return e&&typeof e=="object"&&typeof e.removeListener=="function"&&typeof e.emit=="function"&&typeof e.reallyExit=="function"&&typeof e.listeners=="function"&&typeof e.kill=="function"&&typeof e.pid=="number"&&typeof e.on=="function"};te(R)?(Ga=require("assert"),Oe=Ja(),Ya=/^win/i.test(R.platform),De=require("events"),typeof De!="function"&&(De=De.EventEmitter),R.__signal_exit_emitter__?A=R.__signal_exit_emitter__:(A=R.__signal_exit_emitter__=new De,A.count=0,A.emitted={}),A.infinite||(A.setMaxListeners(1/0),A.infinite=!0),Me.exports=function(e,r){if(!te(global.process))return function(){};Ga.equal(typeof e,"function","a callback must be provided for exit handler"),Re===!1&&ft();var t="exit";r&&r.alwaysLast&&(t="afterexit");var o=function(){A.removeListener(t,e),A.listeners("exit").length===0&&A.listeners("afterexit").length===0&&kr()};return A.on(t,e),o},kr=function(){!Re||!te(global.process)||(Re=!1,Oe.forEach(function(r){try{R.removeListener(r,Cr[r])}catch{}}),R.emit=xr,R.reallyExit=ht,A.count-=1)},Me.exports.unload=kr,oe=function(r,t,o){A.emitted[r]||(A.emitted[r]=!0,A.emit(r,t,o))},Cr={},Oe.forEach(function(e){Cr[e]=function(){if(te(global.process)){var t=R.listeners(e);t.length===A.count&&(kr(),oe("exit",null,e),oe("afterexit",null,e),Ya&&e==="SIGHUP"&&(e="SIGINT"),R.kill(R.pid,e))}}}),Me.exports.signals=function(){return Oe},Re=!1,ft=function(){Re||!te(global.process)||(Re=!0,A.count+=1,Oe=Oe.filter(function(r){try{return R.on(r,Cr[r]),!0}catch{return!1}}),R.emit=Za,R.reallyExit=Xa)},Me.exports.load=ft,ht=R.reallyExit,Xa=function(r){te(global.process)&&(R.exitCode=r||0,oe("exit",R.exitCode,null),oe("afterexit",R.exitCode,null),ht.call(R,R.exitCode))},xr=R.emit,Za=function(r,t){if(r==="exit"&&te(global.process)){t!==void 0&&(R.exitCode=t);var o=xr.apply(this,arguments);return oe("exit",R.exitCode,null),oe("afterexit",R.exitCode,null),o}else return xr.apply(this,arguments)}):Me.exports=function(){return function(){}};var Ga,Oe,Ya,De,A,kr,oe,Cr,Re,ft,ht,Xa,xr,Za});var ri=M((bS,ei)=>{"use strict";var Ud=Ka(),Td=Qa();ei.exports=Ud(()=>{Td(()=>{process.stderr.write("\x1B[?25h")},{alwaysLast:!0})})});var ti=M(Ie=>{"use strict";var Nd=ri(),Or=!1;Ie.show=(e=process.stderr)=>{e.isTTY&&(Or=!1,e.write("\x1B[?25h"))};Ie.hide=(e=process.stderr)=>{e.isTTY&&(Nd(),Or=!0,e.write("\x1B[?25l"))};Ie.toggle=(e,r)=>{e!==void 0&&(Or=e),Or?Ie.show(r):Ie.hide(r)}});var gt=M((SS,_d)=>{_d.exports={dots:{interval:50,frames:["\u280B","\u2819","\u2839","\u2838","\u283C","\u2834","\u2826","\u2827","\u2807","\u280F"]},dashes:{interval:80,frames:["-","_"]}}});var si=M((wS,oi)=>{"use strict";oi.exports=e=>{e=Object.assign({onlyFirst:!1},e);let r=["[\\u001B\\u009B][[\\]()#;?]*(?:(?:(?:(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]+)*|[a-zA-Z\\d]+(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]*)*)?\\u0007)","(?:(?:\\d{1,4}(?:;\\d{0,4})*)?[\\dA-PR-TZcf-ntqry=><~]))"].join("|");return new RegExp(r,e.onlyFirst?void 0:"g")}});var ai=M((vS,bt)=>{"use strict";var Dd=si(),ni=e=>typeof e=="string"?e.replace(Dd(),""):e;bt.exports=ni;bt.exports.default=ni});var vt=M((ES,ii)=>{"use strict";var se=require("readline"),qd=ai(),{dashes:Bd,dots:jd}=gt(),Wd=["succeed","fail","spinning","non-spinnable","stopped"],Hd=["black","red","green","yellow","blue","magenta","cyan","white","gray","redBright","greenBright","yellowBright","blueBright","magentaBright","cyanBright","whiteBright"];function zd(e){let{text:r,status:t,indent:o}=e,s={text:r,status:t,indent:o},n=St(e);return Wd.includes(t)||delete s.status,typeof r!="string"&&delete s.text,typeof o!="number"&&delete s.indent,{...n,...s}}function Vd({spinner:e,disableSpins:r,...t}){let o=St(t),s=Jd(t),n=typeof r=="boolean"?{disableSpins:r}:{};return e=Kd(e),{...o,...s,...n,spinner:e}}function Kd(e={}){let r=wt()?jd:Bd,{interval:t,frames:o}=e;return(!Array.isArray(o)||o.length<1)&&(o=r.frames),typeof t!="number"&&(t=r.interval),{interval:t,frames:o}}function St({color:e,succeedColor:r,failColor:t,spinnerColor:o}){let s={color:e,succeedColor:r,failColor:t,spinnerColor:o};return Object.keys(s).forEach(n=>{Hd.includes(s[n])||delete s[n]}),s}function Jd({succeedPrefix:e,failPrefix:r}){return wt()?(e=e||"\u2713",r=r||"\u2716"):(e=e||"\u221A",r=r||"\xD7"),{succeedPrefix:e,failPrefix:r}}function Gd(e,r){return e.split(`
`).map((t,o)=>o===0?yt(t,r):yt(t,0)).join(`
`)}function yt(e,r){let t=process.stderr.columns||95;return e.length>=t-r?`${e.substring(0,t-r-1)}
${yt(e.substring(t-r-1,e.length),0)}`:e}function Yd(e,r){return qd(e).split(`
`).map((t,o)=>o===0?t.length+r:t.length)}function Xd(e,r,t){e.write(r),se.moveCursor(e,0,-t.length)}function Zd(e,r){r.forEach((t,o)=>{se.moveCursor(e,t,o),se.clearLine(e,1),se.moveCursor(e,-t,-o)}),se.moveCursor(e,0,r.length),se.clearScreenDown(e),se.moveCursor(e,0,-r.length)}function wt(){return process.platform!=="win32"||process.env.TERM_PROGRAM==="vscode"||!!process.env.WT_SESSION}ii.exports={purgeSpinnersOptions:Vd,purgeSpinnerOptions:zd,colorOptions:St,breakText:Gd,getLinesLength:Yd,writeStream:Xd,cleanStream:Zd,terminalSupportsUnicode:wt}});var pi=M((CS,Mr)=>{"use strict";var Et=require("readline"),ne=Wa(),kt=ti(),{dashes:di,dots:li}=gt(),{purgeSpinnerOptions:ci,purgeSpinnersOptions:Qd,colorOptions:el,breakText:Rr,getLinesLength:rl,terminalSupportsUnicode:tl}=vt(),{isValidStatus:kS,writeStream:ol,cleanStream:sl}=vt(),Ct=class{constructor(r={}){r=Qd(r),this.options={spinnerColor:"greenBright",succeedColor:"green",failColor:"red",spinner:tl()?li:di,disableSpins:!1,...r},this.spinners={},this.isCursorHidden=!1,this.currentInterval=null,this.stream=process.stderr,this.lineCount=0,this.currentFrameIndex=0,this.spin=!this.options.disableSpins&&!process.env.CI&&process.stderr&&process.stderr.isTTY,this.bindSigint()}pick(r){return this.spinners[r]}add(r,t={}){if(typeof r!="string")throw Error("A spinner reference name must be specified");t.text||(t.text=r);let o={...el(this.options),succeedPrefix:this.options.succeedPrefix,failPrefix:this.options.failPrefix,status:"spinning",...ci(t)};return this.spinners[r]=o,this.updateSpinnerState(),o}update(r,t={}){let{status:o}=t;return this.setSpinnerProperties(r,t,o),this.updateSpinnerState(),this.spinners[r]}succeed(r,t={}){return this.setSpinnerProperties(r,t,"succeed"),this.updateSpinnerState(),this.spinners[r]}fail(r,t={}){return this.setSpinnerProperties(r,t,"fail"),this.updateSpinnerState(),this.spinners[r]}remove(r){if(typeof r!="string")throw Error("A spinner reference name must be specified");let t=this.spinners[r];return delete this.spinners[r],t}stopAll(r="stopped"){return Object.keys(this.spinners).forEach(t=>{let{status:o}=this.spinners[t];o!=="fail"&&o!=="succeed"&&o!=="non-spinnable"&&(r==="succeed"||r==="fail"?(this.spinners[t].status=r,this.spinners[t].color=this.options[`${r}Color`]):(this.spinners[t].status="stopped",this.spinners[t].color="grey"))}),this.checkIfActiveSpinners(),this.spinners}hasActiveSpinners(){return!!Object.values(this.spinners).find(({status:r})=>r==="spinning")}setSpinnerProperties(r,t,o){if(typeof r!="string")throw Error("A spinner reference name must be specified");if(!this.spinners[r])throw Error(`No spinner initialized with name ${r}`);t=ci(t),o=o||"spinning",this.spinners[r]={...this.spinners[r],...t,status:o}}updateSpinnerState(r,t={},o){this.spin?(clearInterval(this.currentInterval),this.currentInterval=this.loopStream(),this.isCursorHidden||kt.hide(),this.isCursorHidden=!0,this.checkIfActiveSpinners()):this.setRawStreamOutput()}loopStream(){let{frames:r,interval:t}=this.options.spinner;return setInterval(()=>{this.setStreamOutput(r[this.currentFrameIndex]),this.currentFrameIndex=this.currentFrameIndex===r.length-1?0:++this.currentFrameIndex},t)}setStreamOutput(r=""){let t="",o=[],s=this.hasActiveSpinners();Object.values(this.spinners).map(({text:n,status:a,color:i,spinnerColor:c,succeedColor:d,failColor:l,succeedPrefix:u,failPrefix:m,indent:h})=>{let f,b=h||0;a==="spinning"?(b+=r.length+1,n=Rr(n,b),f=`${ne[c](r)} ${i?ne[i](n):n}`):a==="succeed"?(b+=u.length+1,s&&(n=Rr(n,b)),f=`${ne.green(u)} ${ne[d](n)}`):a==="fail"?(b+=m.length+1,s&&(n=Rr(n,b)),f=`${ne.red(m)} ${ne[l](n)}`):(s&&(n=Rr(n,b)),f=i?ne[i](n):n),o.push(...rl(n,b)),t+=h?`${" ".repeat(h)}${f}
`:`${f}
`}),s||Et.clearScreenDown(this.stream),ol(this.stream,t,o),s&&sl(this.stream,o),this.lineCount=o.length}setRawStreamOutput(){Object.values(this.spinners).forEach(r=>{process.stderr.write(`- ${r.text}
`)})}checkIfActiveSpinners(){this.hasActiveSpinners()||(this.spin&&(this.setStreamOutput(),Et.moveCursor(this.stream,0,this.lineCount),clearInterval(this.currentInterval),this.isCursorHidden=!1,kt.show()),this.spinners={})}bindSigint(r){process.removeAllListeners("SIGINT"),process.on("SIGINT",()=>{kt.show(),Et.moveCursor(process.stderr,0,this.lineCount),process.exit(0)})}};Mr.exports=Ct;Mr.exports.dots=li;Mr.exports.dashes=di});var yi={};Mt(yi,{getMediaMetadata:()=>il});async function Pr(e,r={}){if(!$r)return console.warn("TMDB API key not found (MOVIE_WEB_TMDB_API_KEY or TMDB_READ_API_KEY)"),null;let t=new URL(`https://api.themoviedb.org/3${e}`),o={"Content-Type":"application/json"};$r.startsWith("ey")?o.Authorization=`Bearer ${$r}`:t.searchParams.append("api_key",$r),Object.entries(r).forEach(([s,n])=>{t.searchParams.append(s,n)});try{let s=await fetch(t.toString(),{headers:o});return s.ok?await s.json():(console.warn(`TMDB request failed: ${s.status} ${s.statusText}`),null)}catch(s){return console.error("TMDB request error:",s),null}}async function il(e,r,t,o){try{if(r==="movie"){let n=await Pr(`/movie/${e}`,{append_to_response:"external_ids"});return n?{title:n.title,tmdbId:String(n.id),imdbId:n.external_ids?.imdb_id||n.imdb_id,posterPath:n.poster_path,backdropPath:n.backdrop_path,releaseDate:n.release_date,runtime:n.runtime,genres:n.genres?.map(a=>a.name),type:"movie"}:null}if(t&&o){let n=await Pr(`/tv/${e}`,{append_to_response:"external_ids"}),a=await Pr(`/tv/${e}/season/${t}/episode/${o}`);return n?{title:n.name,tmdbId:String(n.id),imdbId:n.external_ids?.imdb_id,posterPath:a?.still_path||n.poster_path,backdropPath:n.backdrop_path,releaseDate:a?.air_date||n.first_air_date,runtime:a?.runtime||n.episode_run_time?.[0],genres:n.genres?.map(i=>i.name),type:"show",season:Number(t),episode:Number(o)}:null}let s=await Pr(`/tv/${e}`,{append_to_response:"external_ids"});return s?{title:s.name,tmdbId:String(s.id),imdbId:s.external_ids?.imdb_id,posterPath:s.poster_path,backdropPath:s.backdrop_path,releaseDate:s.first_air_date,genres:s.genres?.map(n=>n.name),type:"show"}:null}catch(s){return console.error("Error fetching metadata:",s),null}}var $r,Si=Ur(()=>{"use strict";$r=process.env.MOVIE_WEB_TMDB_API_KEY||process.env.TMDB_READ_API_KEY});var Ei=require("stream"),ki=P(require("cors"),1),Ci=P(require("dotenv"),1),xt=P(require("express"),1),Ot=P(require("express-rate-limit"),1),xi=P(require("express-slow-down"),1);var p=class extends Error{constructor(r){super(`Couldn't find a stream: ${r??"not found"}`),this.name="NotFoundError"}};function It(e){let r=[];return e.scrapeMovie&&r.push("movie"),e.scrapeShow&&r.push("show"),{type:"source",id:e.id,rank:e.rank,name:e.name,mediaTypes:r}}function $t(e){return{type:"embed",id:e.id,rank:e.rank,name:e.name}}function Pt(e){return e.sources.sort((r,t)=>t.rank-r.rank).map(It)}function Ft(e){return e.embeds.sort((r,t)=>t.rank-r.rank).map($t)}function At(e,r){let t=e.sources.find(s=>s.id===r);if(t)return It(t);let o=e.embeds.find(s=>s.id===r);return o?$t(o):null}function Tr(e,r){let t=r?.baseUrl??"",o=e;t.length>0&&!t.endsWith("/")&&(t+="/"),o.startsWith("/")&&(o=o.slice(1));let s=t+o;if(!s.startsWith("http://")&&!s.startsWith("https://")&&!s.startsWith("data:"))throw new Error(`Invald URL -- URL doesn't start with a http scheme: '${s}'`);let n=new URL(s);return Object.entries(r?.query??{}).forEach(([a,i])=>{n.searchParams.set(a,i)}),n.toString()}function Nr(e){let r=(o,s)=>e(o,{headers:s?.headers??{},method:s?.method??"GET",query:s?.query??{},baseUrl:s?.baseUrl??"",readHeaders:s?.readHeaders??[],body:s?.body,credentials:s?.credentials}),t=async(o,s)=>(await r(o,s)).body;return t.full=r,t}var g={CORS_ALLOWED:"cors-allowed",IP_LOCKED:"ip-locked",CF_BLOCKED:"cf-blocked",PROXY_BLOCKED:"proxy-blocked"},_r={BROWSER:"browser",BROWSER_EXTENSION:"browser-extension",NATIVE:"native",ANY:"any"},Ti={browser:{requires:[g.CORS_ALLOWED],disallowed:[]},"browser-extension":{requires:[],disallowed:[]},native:{requires:[],disallowed:[]},any:{requires:[],disallowed:[]}};function Dr(e,r,t){let o=Ti[e];return r||o.disallowed.push(g.IP_LOCKED),t&&o.disallowed.push(g.PROXY_BLOCKED),o}function G(e,r){return!(!e.requires.every(s=>r.includes(s))||e.disallowed.some(s=>r.includes(s)))}var Lt="https://proxy.nsbx.ru/proxy",Ni="https://proxy2.pstream.mov";function ae(e){return!!(!e.flags.includes(g.CORS_ALLOWED)||e.headers&&Object.keys(e.headers).length>0)}function ie(e){let r=e.headers&&Object.keys(e.headers).length>0?e.headers:void 0,t={...e.type==="hls"&&{depth:e.proxyDepth??0}},o={headers:r,options:t};return e.type==="hls"&&(o.type="hls",o.url=e.playlist,e.playlist=`${Lt}?${new URLSearchParams({payload:Buffer.from(JSON.stringify(o)).toString("base64url")})}`),e.type==="file"&&(o.type="mp4",Object.entries(e.qualities).forEach(s=>{o.url=s[1].url,s[1].url=`${Lt}?${new URLSearchParams({payload:Buffer.from(JSON.stringify(o)).toString("base64url")})}`})),e.headers={},e.flags=[g.CORS_ALLOWED],e}function O(e,r={}){let t=encodeURIComponent(e),o=encodeURIComponent(JSON.stringify(r));return`${Ni}/m3u8-proxy?url=${t}${r?`&headers=${o}`:""}`}function S(e){let r=[];return e.scrapeMovie&&r.push("movie"),e.scrapeShow&&r.push("show"),{...e,type:"source",disabled:e.disabled??!1,externalSource:e.externalSource??!1,mediaTypes:r}}function v(e){return{...e,type:"embed",disabled:e.disabled??!1,mediaTypes:void 0}}var ce="https://embed.warezcdn.link";var qe="https://warezcdn.link/player",Ut="https://workerproxy.warezcdn.workers.dev";function _i(e){let r=atob(e);r=r.trim(),r=r.split("").reverse().join("");let t=r.slice(-5);return t=t.split("").reverse().join(""),r=r.slice(0,-5),`${r}${t}`}async function Be(e){let t=(await e.proxiedFetcher("/player.php",{baseUrl:qe,headers:{Referer:`${qe}/getEmbed.php?${new URLSearchParams({id:e.url,sv:"warezcdn"})}`},query:{id:e.url}})).match(/let allowanceKey = "(.*?)";/)?.[1];if(!t)throw new p("Failed to get allowanceKey");let o=await e.proxiedFetcher("/functions.php",{baseUrl:qe,method:"POST",body:new URLSearchParams({getVideo:e.url,key:t})}),s=JSON.parse(o);if(!s.id)throw new p("can't get stream id");let n=_i(s.id);if(!n)throw new p("can't get file id");return n}var Di=[50,51,52,53,54,55,56,57,58,59,60,61,62,63,64];async function qi(e,r){for(let t of Di){let o=`https://cloclo${t}.cloud.mail.ru/weblink/view/${r}`;if((await e.proxiedFetcher.full(o,{method:"GET",headers:{Range:"bytes=0-1"}})).statusCode===206)return o}return null}var de=v({id:"warezcdnembedmp4",name:"WarezCDN MP4",rank:82,disabled:!0,async scrape(e){let r=await Be(e);if(!r)throw new p("can't get file id");let t=await qi(e,r);if(!t)throw new p("can't get stream id");return{stream:[{id:"primary",captions:[],qualities:{unknown:{type:"mp4",url:`${Ut}/?${new URLSearchParams({url:t})}`}},type:"file",flags:[g.CORS_ALLOWED]}]}}});var Nt=[de.id,"cloudnestra"];function le(e){return e?e.type==="hls"?!!e.playlist:e.type==="file"?Object.values(e.qualities).filter(t=>t.url.length>0).length!==0:!1:!1}function Tt(e){return e.includes("/m3u8-proxy?url=")}async function je(e,r,t){if(Nt.includes(t))return e;let o=!1;if(e.type==="hls"){if(e.playlist.startsWith("data:"))return e;let s=o||Tt(e.playlist),n;if(s)try{let a=await fetch(e.playlist,{method:"GET",headers:{...e.preferredHeaders,...e.headers}});n={statusCode:a.status,body:await a.text(),finalUrl:a.url}}catch{return null}else n=await r.proxiedFetcher.full(e.playlist,{method:"GET",headers:{...e.preferredHeaders,...e.headers}});return n.statusCode<200||n.statusCode>=400?null:e}if(e.type==="file"){let s=await Promise.all(Object.values(e.qualities).map(async a=>{if(o||Tt(a.url))try{let c=await fetch(a.url,{method:"GET",headers:{...e.preferredHeaders,...e.headers,Range:"bytes=0-1"}});return{statusCode:c.status,body:await c.text(),finalUrl:c.url}}catch{return{statusCode:500,body:"",finalUrl:a.url}}return r.proxiedFetcher.full(a.url,{method:"GET",headers:{...e.preferredHeaders,...e.headers,Range:"bytes=0-1"}})})),n=e.qualities;return Object.keys(e.qualities).forEach((a,i)=>{(s[i].statusCode<200||s[i].statusCode>=400)&&delete n[a]}),Object.keys(n).length===0?null:{...e,qualities:n}}return null}async function qr(e,r,t){return Nt.includes(t)?e:(await Promise.all(e.map(o=>je(o,r,t)))).filter(o=>o!==null)}async function _t(e,r){let t=e.sources.find(n=>r.id===n.id);if(!t)throw new Error("Source with ID not found");if(r.media.type==="movie"&&!t.scrapeMovie)throw new Error("Source is not compatible with movies");if(r.media.type==="show"&&!t.scrapeShow)throw new Error("Source is not compatible with shows");let o={fetcher:r.fetcher,proxiedFetcher:r.proxiedFetcher,progress(n){r.events?.update?.({id:t.id,percentage:n,status:"pending"})}},s=null;if(r.media.type==="movie"&&t.scrapeMovie?s=await t.scrapeMovie({...o,media:r.media}):r.media.type==="show"&&t.scrapeShow&&(s=await t.scrapeShow({...o,media:r.media})),s?.stream&&(s.stream=s.stream.filter(n=>le(n)).filter(n=>G(r.features,n.flags)),s.stream=s.stream.map(n=>ae(n)&&r.proxyStreams?ie(n):n)),!s)throw new Error("output is null");if(s.embeds=s.embeds.filter(n=>{let a=e.embeds.find(i=>i.id===n.embedId);return!(!a||a.disabled)}),(!s.stream||s.stream.length===0)&&s.embeds.length===0)throw new p("No streams found");if(s.stream&&s.stream.length>0&&s.embeds.length===0){let n=await qr(s.stream,r,t.id);if(n.length===0)throw new p("No playable streams found");s.stream=n}return s}async function Dt(e,r){let t=e.embeds.find(a=>r.id===a.id);if(!t)throw new Error("Embed with ID not found");let o=r.url,s=await t.scrape({fetcher:r.fetcher,proxiedFetcher:r.proxiedFetcher,url:o,progress(a){r.events?.update?.({id:t.id,percentage:a,status:"pending"})}});if(s.stream=s.stream.filter(a=>le(a)).filter(a=>G(r.features,a.flags)),s.stream.length===0)throw new p("No streams found");s.stream=s.stream.map(a=>ae(a)&&r.proxyStreams?ie(a):a);let n=await qr(s.stream,r,t.id);if(n.length===0)throw new p("No playable streams found");return s.stream=n,s}function Br(e,r){let t=[...r];return t.sort((o,s)=>{let n=e.indexOf(o.id),a=e.indexOf(s.id);return n>=0&&a>=0?n-a:a>=0?1:n>=0?-1:s.rank-o.rank}),t}async function qt(e,r){let t=Br(r.sourceOrder??[],e.sources).filter(i=>r.media.type==="movie"?!!i.scrapeMovie:r.media.type==="show"?!!i.scrapeShow:!1),o=Br(r.embedOrder??[],e.embeds),s=o.map(i=>i.id),n="",a={fetcher:r.fetcher,proxiedFetcher:r.proxiedFetcher,progress(i){r.events?.update?.({id:n,percentage:i,status:"pending"})}};r.events?.init?.({sourceIds:t.map(i=>i.id)});for(let i of t){r.events?.start?.(i.id),n=i.id;let c=null;try{if(r.media.type==="movie"&&i.scrapeMovie?c=await i.scrapeMovie({...a,media:r.media}):r.media.type==="show"&&i.scrapeShow&&(c=await i.scrapeShow({...a,media:r.media})),c&&(c.stream=(c.stream??[]).filter(le).filter(l=>G(r.features,l.flags)),c.stream=c.stream.map(l=>ae(l)&&r.proxyStreams?ie(l):l)),!c||!c.stream?.length&&!c.embeds.length)throw new p("No streams found")}catch(l){let u={id:i.id,percentage:100,status:l instanceof p?"notfound":"failure",reason:l instanceof p?l.message:void 0,error:l instanceof p?void 0:l};r.events?.update?.(u);continue}if(!c)throw new Error("Invalid media type");if(c.stream?.[0]){let l=await je(c.stream[0],r,i.id);if(!l)throw new p("No streams found");return{sourceId:i.id,stream:l}}let d=c.embeds.filter(l=>{let u=e.embeds.find(m=>m.id===l.embedId);return u&&!u.disabled}).sort((l,u)=>s.indexOf(l.embedId)-s.indexOf(u.embedId));d.length>0&&r.events?.discoverEmbeds?.({embeds:d.map((l,u)=>({id:[i.id,u].join("-"),embedScraperId:l.embedId})),sourceId:i.id});for(let[l,u]of d.entries()){let m=o.find(b=>b.id===u.embedId);if(!m)throw new Error("Invalid embed returned");let h=[i.id,l].join("-");r.events?.start?.(h),n=h;let f;try{if(f=await m.scrape({...a,url:u.url}),f.stream=f.stream.filter(le).filter(y=>G(r.features,y.flags)),f.stream=f.stream.map(y=>ae(y)&&r.proxyStreams?ie(y):y),f.stream.length===0)throw new p("No streams found");let b=await je(f.stream[0],r,u.embedId);if(!b)throw new p("No streams found");f.stream=[b]}catch(b){let y={id:h,percentage:100,status:b instanceof p?"notfound":"failure",reason:b instanceof p?b.message:void 0,error:b instanceof p?void 0:b};r.events?.update?.(y);continue}return{sourceId:i.id,embedId:m.id,stream:f.stream[0]}}}return null}function jr(e){let r={embeds:e.embeds,sources:e.sources},t={features:e.features,fetcher:Nr(e.fetcher),proxiedFetcher:Nr(e.proxiedFetcher??e.fetcher),proxyStreams:e.proxyStreams};return{runAll(o){return qt(r,{...t,...o})},runSourceScraper(o){return _t(r,{...t,...o})},runEmbedScraper(o){return Dt(r,{...t,...o})},getMetadata(o){return At(r,o)},listSources(){return Pt(r)},listEmbeds(){return Ft(r)}}}var Bt=require("nanoid");var Bi=(0,Bt.customAlphabet)("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",10),We="https://d000d.com",jt=v({id:"dood",name:"dood",rank:173,async scrape(e){let r=e.url;e.url.includes("primewire")&&(r=(await e.proxiedFetcher.full(e.url)).finalUrl);let t=r.split("/d/")[1]||r.split("/e/")[1],o=await e.proxiedFetcher(`/e/${t}`,{method:"GET",baseUrl:We}),s=o.match(/\?token=([^&]+)&expiry=/)?.[1],n=o.match(/\$\.get\('\/pass_md5([^']+)/)?.[1],a=o.match(/thumbnails:\s\{\s*vtt:\s'([^']*)'/),c=`${await e.proxiedFetcher(`/pass_md5${n}`,{headers:{Referer:`${We}/e/${t}`},method:"GET",baseUrl:We})}${Bi()}?token=${s}&expiry=${Date.now()}`;if(!c.startsWith("http"))throw new Error("Invalid URL");return{stream:[{id:"primary",type:"file",flags:[],captions:[],qualities:{unknown:{type:"mp4",url:c}},headers:{Referer:We},...a?{thumbnailTrack:{type:"vtt",url:`https:${a[1]}`}}:{}}]}}});var Ht=P(require("unpacker"),1);var Wt="https://mixdrop.ag",ji=/(eval\(function\(p,a,c,k,e,d\){.*{}\)\))/,Wi=/MDCore\.wurl="(.*?)";/,He=v({id:"mixdrop",name:"MixDrop",rank:198,async scrape(e){let r=e.url;e.url.includes("primewire")&&(r=(await e.fetcher.full(e.url)).finalUrl);let t=new URL(r).pathname.split("/")[2],s=(await e.proxiedFetcher(`/e/${t}`,{baseUrl:Wt})).match(ji);if(!s)throw new Error("failed to find packed mixdrop JavaScript");let a=Ht.unpack(s[1]).match(Wi);if(!a)throw new Error("failed to find packed mixdrop source link");let i=a[1];return{stream:[{id:"primary",type:"file",flags:[g.IP_LOCKED],captions:[],qualities:{unknown:{type:"mp4",url:i.startsWith("http")?i:`https:${i}`,headers:{Referer:Wt}}}}]}}});function Hi(e){return String.fromCharCode(parseInt(e,16))}function zi(e,r){return(e.match(/../g)?.map(Hi).join("")||"").split("").map((o,s)=>String.fromCharCode(o.charCodeAt(0)^r.charCodeAt(s%r.length))).join("")}var zt=v({id:"turbovid",name:"Turbovid",rank:122,async scrape(e){let r=new URL(e.url).origin,t=await e.proxiedFetcher(e.url);e.progress(30);let o=t.match(/const\s+apkey\s*=\s*"(.*?)";/)?.[1],s=t.match(/const\s+xxid\s*=\s*"(.*?)";/)?.[1];if(!o||!s)throw new Error("Failed to get required values");let n=JSON.parse(await e.proxiedFetcher("/api/cucked/juice_key",{baseUrl:r,headers:{referer:e.url,"User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/135.0.0.0 Safari/537.36",Accept:"*/*","Accept-Language":"en-US,en;q=0.9",Connection:"keep-alive","Content-Type":"application/json","X-Turbo":"TurboVidClient","Sec-Fetch-Dest":"empty","Sec-Fetch-Mode":"cors","Sec-Fetch-Site":"same-origin"}})).juice;if(!n)throw new Error("Failed to fetch the key");let a=atob(n);e.progress(60);let i=JSON.parse(await e.proxiedFetcher("/api/cucked/the_juice_v2/",{baseUrl:r,query:{[o]:s},headers:{"User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/135.0.0.0 Safari/537.36",Accept:"*/*","Accept-Language":"en-US,en;q=0.9",Connection:"keep-alive","Content-Type":"application/json","X-Turbo":"TurboVidClient","Sec-Fetch-Dest":"empty","Sec-Fetch-Mode":"cors","Sec-Fetch-Site":"same-origin",referer:e.url}})).data;if(!i)throw new Error("Failed to fetch required data");e.progress(90);let c=zi(i,a),d={referer:`${r}/`,origin:r};return{stream:[{type:"hls",id:"primary",playlist:O(c,d),flags:[],captions:[]}]}}});var Jt=P(require("crypto-js"),1);var Vt=P(require("iso-639-1"),1),Vi={srt:"srt",vtt:"vtt"};function pe(e){let t=Object.keys(Vi).find(o=>e.endsWith(`.${o}`));return t||null}function q(e){let t={"chinese - hong kong":"zh","chinese - traditional":"zh",czech:"cs",danish:"da",dutch:"nl",english:"en","english - sdh":"en",finnish:"fi",french:"fr",german:"de",greek:"el",hungarian:"hu",italian:"it",korean:"ko",norwegian:"no",polish:"pl",portuguese:"pt","portuguese - brazilian":"pt",romanian:"ro","spanish - european":"es","spanish - latin american":"es",spanish:"es",swedish:"sv",turkish:"tr",\u0627\u064E\u0644\u0652\u0639\u064E\u0631\u064E\u0628\u0650\u064A\u064E\u0651\u0629\u064F:"ar",\u09AC\u09BE\u0982\u09B2\u09BE:"bn",filipino:"tl",indonesia:"id",\u0627\u0631\u062F\u0648:"ur",English:"en",Arabic:"ar",Bosnian:"bs",Bulgarian:"bg",Croatian:"hr",Czech:"cs",Danish:"da",Dutch:"nl",Estonian:"et",Finnish:"fi",French:"fr",German:"de",Greek:"el",Hebrew:"he",Hungarian:"hu",Indonesian:"id",Italian:"it",Norwegian:"no",Persian:"fa",Polish:"pl",Portuguese:"pt","Protuguese (BR)":"pt-br",Romanian:"ro",Russian:"ru",russian:"ru",Serbian:"sr",Slovenian:"sl",Spanish:"es",Swedish:"sv",Thai:"th",Turkish:"tr",ng:"en",re:"fr",pa:"es"}[e.toLowerCase()];if(t)return t;let o=Vt.default.getCode(e);return o.length===0?null:o}function Kt(e){let r={};return e.filter(t=>r[t.language]?!1:(r[t.language]=!0,!0))}var Ki="https://rabbitstream.net",Ji="https://rabbitstream.net/",{AES:Gi,enc:Yi}=Jt.default;function Xi(e){try{return JSON.parse(e),!0}catch{return!1}}function Zi(e){let r=e.lastIndexOf("switch"),t=e.indexOf("partKeyStartPosition"),o=e.slice(r,t),s=[],n=o.matchAll(/:[a-zA-Z0-9]+=([a-zA-Z0-9]+),[a-zA-Z0-9]+=([a-zA-Z0-9]+);/g);for(let a of n){let i=[];for(let c of[a[1],a[2]]){let d=new RegExp(`${c}=0x([a-zA-Z0-9]+)`,"g"),l=[...e.matchAll(d)],u=l[l.length-1];if(!u)return null;let m=parseInt(u[1],16);i.push(m)}s.push([i[0],i[1]])}return s}var ze=v({id:"upcloud",name:"UpCloud",rank:200,disabled:!0,async scrape(e){let r=new URL(e.url.replace("embed-5","embed-4")),t=r.pathname.split("/"),o=t[t.length-1],s=await e.proxiedFetcher(`${r.origin}/ajax/embed-4/getSources?id=${o}`,{headers:{Referer:r.origin,"X-Requested-With":"XMLHttpRequest"}}),n=null;if(!Xi(s.sources)){let i=await e.proxiedFetcher("https://rabbitstream.net/js/player/prod/e4-player.min.js",{query:{v:Date.now().toString()}}),c=Zi(i);if(!c)throw new Error("Key extraction failed");let d="",l=s.sources,u=0;c.forEach(([f,b])=>{let y=f+u,C=y+b;d+=s.sources.slice(y,C),l=l.replace(s.sources.substring(y,C),""),u+=b});let m=Gi.decrypt(l,d).toString(Yi.Utf8),h=JSON.parse(m)[0];if(!h)throw new Error("No stream found");n=h}if(!n)throw new Error("upcloud source not found");let a=[];return s.tracks.forEach(i=>{if(i.kind!=="captions")return;let c=pe(i.file);if(!c)return;let d=q(i.label.split(" ")[0]);d&&a.push({id:i.file,language:d,hasCorsRestrictions:!1,type:c,url:i.file})}),{stream:[{id:"primary",type:"hls",playlist:n.file,flags:[g.CORS_ALLOWED],captions:a,preferredHeaders:{Referer:Ji,Origin:Ki}}]}}});var Wr="https://tom.autoembed.cc";async function Gt(e){let r=e.media.type==="show"?"tv":"movie",t=e.media.tmdbId;e.media.type==="show"&&(t=`${t}/${e.media.season.number}/${e.media.episode.number}`);let o=await e.proxiedFetcher("/api/getVideoSource",{baseUrl:Wr,query:{type:r,id:t},headers:{Referer:Wr,Origin:Wr}});if(!o)throw new p("Failed to fetch video source");if(!o.videoSource)throw new p("No video source found");e.progress(50);let s=[{embedId:"autoembed-english",url:o.videoSource}];return e.progress(90),{embeds:s}}var Yt=S({id:"autoembed",name:"Autoembed",rank:110,disabled:!0,flags:[g.CORS_ALLOWED],scrapeMovie:Gt,scrapeShow:Gt});function Xt(e){let r=e.trim().toLowerCase();return r!=="the movie"&&r.endsWith("the movie")&&(r=r.replace("the movie","")),r!=="the series"&&r.endsWith("the series")&&(r=r.replace("the series","")),r.replace(/['":]/g,"").replace(/[^a-zA-Z0-9]+/g,"_")}function $e(e,r){return Xt(e)===Xt(r)}function U(e,r,t){let o=t===void 0?!0:e.releaseYear===t;return $e(e.title,r)&&o}var Zt=P(require("cookie"),1),Hr=P(require("set-cookie-parser"),1);function F(e){return Object.entries(e).map(([r,t])=>Zt.default.serialize(r,t)).join("; ")}function Qt(e){let r=Hr.default.splitCookiesString(e);return Hr.default.parse(r,{map:!0})}var ue="https://ee3.me",eo="_sf_",ro="defonotscraping";var to=require("cheerio");async function oo(e,r,t){let o=await t.proxiedFetcher.full("/login",{baseUrl:ue,method:"POST",body:new URLSearchParams({user:e,pass:r,action:"login"}),readHeaders:["Set-Cookie"]}),s=JSON.parse(o.body);return Qt(s.status===1?o.headers.get("Set-Cookie")??"":"PHPSESSID=mk2p73c77qc28o5i5120843ruu;").PHPSESSID.value}function so(e){let r=[],t=(0,to.load)(e);return t("div").each((o,s)=>{let n=t(s).find(".title").text().trim(),a=parseInt(t(s).find(".details span").first().text().trim(),10),i=t(s).find(".control-buttons").attr("data-id");n&&a&&i&&r.push({title:n,year:a,id:i})}),r}async function Qi(e){let r=await oo(eo,ro,e);if(!r)throw new Error("Login failed");let o=so(await e.proxiedFetcher("/get",{baseUrl:ue,method:"POST",body:new URLSearchParams({query:e.media.title,action:"search"}),headers:{cookie:F({PHPSESSID:r})}})).find(l=>l&&U(e.media,l.title,l.year))?.id;if(!o)throw new p("No watchable item found");e.progress(20);let s=JSON.parse(await e.proxiedFetcher("/get",{baseUrl:ue,method:"POST",body:new URLSearchParams({id:o,action:"get_movie_info"}),headers:{cookie:F({PHPSESSID:r})}}));if(!s.message.video)throw new Error("Failed to get the stream");e.progress(40);let n=JSON.parse(await e.proxiedFetcher("/renew",{baseUrl:ue,method:"POST",headers:{cookie:F({PHPSESSID:r})}}));if(!n.k)throw new Error("Failed to get the key");e.progress(60);let a=s.message.server==="1"?"https://vid.ee3.me/vid/":"https://vault.rips.cc/video/",i=n.k,c=`${a}${s.message.video}?${new URLSearchParams({k:i})}`,d=[];return s.message.subs?.toLowerCase()==="yes"&&s.message.imdbID&&d.push({id:`https://rips.cc/subs/${s.message.imdbID}.vtt`,url:`https://rips.cc/subs/${s.message.imdbID}.vtt`,type:"vtt",hasCorsRestrictions:!1,language:"en"}),e.progress(90),{embeds:[],stream:[{id:"primary",type:"file",flags:[g.CORS_ALLOWED],captions:d,qualities:{720:{type:"mp4",url:c}}}]}}var no=S({id:"ee3",name:"EE3",rank:120,disabled:!0,flags:[g.CORS_ALLOWED],scrapeMovie:Qi});var ao=require("cheerio");function me(e){switch(e.toLowerCase().replace("p","")){case"360":return"360";case"480":return"480";case"720":return"720";case"1080":return"1080";case"2160":return"4k";case"4k":return"4k";default:return"unknown"}}var Ve="https://fsharetv.co";async function ec(e){let r=await e.proxiedFetcher("/search",{baseUrl:Ve,query:{q:e.media.title}}),t=(0,ao.load)(r),o=[];t(".movie-item").each((l,u)=>{let[,m,h]=t(u).find("b").text()?.match(/^(.*?)\s*(?:\(?\s*(\d{4})(?:\s*-\s*\d{0,4})?\s*\)?)?\s*$/)||[],f=t(u).find("a").attr("href");!m||!f||o.push({title:m,year:Number(h)??void 0,url:f})});let s=o.find(l=>l&&U(e.media,l.title,l.year))?.url;if(!s)throw new p("No watchable item found");e.progress(50);let a=(await e.proxiedFetcher(s.replace("/movie","/w"),{baseUrl:Ve})).match(/Movie\.setSource\('([^']*)'/)?.[1];if(!a)throw new Error("File ID not found");let i=await e.proxiedFetcher(`/api/file/${a}/source`,{baseUrl:Ve,query:{type:"watch"}});if(!i.data.file.sources.length)throw new Error("No sources found");let c=new URL((await e.proxiedFetcher.full(i.data.file.sources[0].src,{baseUrl:Ve})).finalUrl).origin,d=i.data.file.sources.reduce((l,u)=>{let m=typeof u.quality=="number"?u.quality.toString():u.quality,h=me(m);return l[h]={type:"mp4",url:`${c}${u.src.replace("/api","")}`},l},{});return e.progress(90),{embeds:[],stream:[{id:"primary",type:"file",flags:[],headers:{referer:"https://fsharetv.co"},qualities:d,captions:[]}]}}var io=S({id:"fsharetv",name:"FshareTV",rank:190,disabled:!0,flags:[],scrapeMovie:ec});var rc="https://isut.streamflix.one";async function co(e){let t=(await e.fetcher(`${rc}/api/source/${e.media.type==="movie"?`${e.media.tmdbId}`:`${e.media.tmdbId}/${e.media.season.number}/${e.media.episode.number}`}`)).sources;if(!t||t.length===0)throw new p("No sources found");let o=t[0].file;if(!o)throw new p("No file URL found");return e.progress(90),{embeds:[],stream:[{id:"primary",playlist:o,type:"hls",flags:[g.CORS_ALLOWED],captions:[]}]}}var lo=S({id:"insertunit",name:"Insertunit",rank:12,disabled:!0,flags:[g.CORS_ALLOWED,g.IP_LOCKED],scrapeMovie:co,scrapeShow:co});var mo=require("cheerio");var po="https://mp4hydra.org/";async function uo(e){let r=await e.proxiedFetcher("/search",{baseUrl:po,query:{q:e.media.title}});e.progress(40);let t=(0,mo.load)(r),o=[];t(".search-details").each((i,c)=>{let[,d,l]=t(c).find("a").first().text().trim().match(/^(.*?)\s*(?:\(?\s*(\d{4})(?:\s*-\s*\d{0,4})?\s*\)?)?\s*$/)||[],u=t(c).find("a").attr("href")?.split("/")[4];!d||!u||o.push({title:d,year:l?parseInt(l,10):void 0,url:u})});let s=o.find(i=>i&&U(e.media,i.title,i.year))?.url;if(!s)throw new p("No watchable item found");e.progress(60);let n=await e.proxiedFetcher("/info2?v=8",{method:"POST",body:new URLSearchParams({z:JSON.stringify([{s,t:"movie"}])}),baseUrl:po});if(!n.playlist[0].src||!n.servers)throw new p("No watchable item found");e.progress(80);let a=[];return[n.servers[n.servers.auto],...Object.values(n.servers).filter(i=>i!==n.servers[n.servers.auto]&&i!==n.servers.auto)].forEach((i,c)=>a.push({embedId:`mp4hydra-${c+1}`,url:`${i}${n.playlist[0].src}|${n.playlist[0].label}`})),e.progress(90),{embeds:a}}var fo=S({id:"mp4hydra",name:"Mp4Hydra",rank:4,disabled:!0,flags:[g.CORS_ALLOWED],scrapeMovie:uo,scrapeShow:uo});var ho="https://nscrape.andresdev.org/api";async function go(e){let r=e.media.tmdbId,t;e.media.type==="movie"?t=`${ho}/get-stream?tmdbId=${r}`:t=`${ho}/get-show-stream?tmdbId=${r}&season=${e.media.season.number}&episode=${e.media.episode.number}`;let o=await e.proxiedFetcher(t);if(!o.success||!o.rurl)throw new p("No stream found");return{stream:[{id:"nepu",type:"hls",playlist:o.rurl,flags:[g.CORS_ALLOWED],captions:[]}],embeds:[]}}var bo=S({id:"nepu",name:"Nepu",rank:201,disabled:!0,flags:[g.CORS_ALLOWED],scrapeMovie:go,scrapeShow:go});var Ke="https://mbp.pirxcy.dev";function yo(e){let r=e.list.reduce((o,s)=>{let{path:n,quality:a,format:i}=s,c=s.real_quality;if(i!=="mp4")return o;let d;if(a==="4K"||c==="4K")d=2160;else{let l=a.replace("p","");d=parseInt(l,10)}return Number.isNaN(d)||o[d]||(o[d]=n),o},{}),t=Object.entries(r).reduce((o,[s,n])=>(o[s]=n,o),{});return{...t[2160]&&{"4k":{type:"mp4",url:t[2160]}},...t[1080]&&{1080:{type:"mp4",url:t[1080]}},...t[720]&&{720:{type:"mp4",url:t[720]}},...t[480]&&{480:{type:"mp4",url:t[480]}},...t[360]&&{360:{type:"mp4",url:t[360]}},...t.unknown&&{unknown:{type:"mp4",url:t.unknown}}}}async function So(e,r,t,o,s){let n=`${Ke}/search?q=${encodeURIComponent(t)}&type=${o}${s?`&year=${s}`:""}`,a=await e.proxiedFetcher(n);if(!a.data||a.data.length===0)throw new p("No results found in search");for(let i of a.data){let c=`${Ke}/details/${o}/${i.id}`,d=await e.proxiedFetcher(c);if(d.data&&d.data.tmdb_id.toString()===r)return i.id}throw new p("Could not find matching media item for TMDB ID")}async function tc(e){let r=e.media.tmdbId,t=e.media.title,o=e.media.releaseYear?.toString();if(!r||!t)throw new p("Missing required media information");let s=await So(e,r,t,"movie",o),n=`${Ke}/movie/${s}`,a=await e.proxiedFetcher(n);if(!a.data||!a.data.list)throw new p("No streams found for this movie");return{stream:[{id:"pirxcy",type:"file",qualities:yo(a.data),flags:[g.CORS_ALLOWED],captions:[]}],embeds:[]}}async function oc(e){let r=e.media.tmdbId,t=e.media.title,o=e.media.releaseYear?.toString(),s=e.media.season.number,n=e.media.episode.number;if(!r||!t||!s||!n)throw new p("Missing required media information");let a=await So(e,r,t,"tv",o),i=`${Ke}/tv/${a}/${s}/${n}`,c=await e.proxiedFetcher(i);if(!c.data||!c.data.list)throw new p("No streams found for this episode");let d=yo(c.data);return{embeds:[],stream:[{id:"primary",type:"file",qualities:d,flags:[g.CORS_ALLOWED],captions:[]}]}}var wo=S({id:"pirxcy",name:"Pirxcy",rank:230,disabled:!0,flags:[g.CORS_ALLOWED],scrapeMovie:tc,scrapeShow:oc});var fe=require("cheerio");var vo=require("cheerio"),Y="https://tugaflix.love/";function zr(e){let r=[],t=(0,vo.load)(e);return t(".items .poster").each((o,s)=>{let n=t(s).find("a"),a=n.attr("href"),[,i,c]=n.attr("title")?.match(/^(.*?)\s*(?:\((\d{4})\))?\s*$/)||[];!i||!a||r.push({title:i,year:c?parseInt(c,10):void 0,url:a})}),r}var Eo=S({id:"tugaflix",name:"Tugaflix",rank:70,disabled:!0,flags:[g.IP_LOCKED],scrapeMovie:async e=>{let r=zr(await e.proxiedFetcher("/filmes/",{baseUrl:Y,query:{s:e.media.title}}));if(r.length===0)throw new p("No watchable item found");let t=r.find(i=>i&&U(e.media,i.title,i.year))?.url;if(!t)throw new p("No watchable item found");e.progress(50);let o=await e.proxiedFetcher(t,{baseUrl:Y}),s=(0,fe.load)(o),n=[],a=s('iframe[src*="mixdrop"], a[href*="mixdrop"], button[data-url*="mixdrop"]');for(let i of a){let c=s(i).attr("src")||s(i).attr("href")||s(i).attr("data-url");c&&c.includes("mixdrop")&&n.push({embedId:"mixdrop",url:c.startsWith("http")?c:`https:${c}`})}if(n.length===0){let i=s('a:contains("Watch"), a:contains("Assistir"), .watch-btn, .play-btn');for(let c of i){let d=s(c).attr("href");if(d)try{let l=await e.proxiedFetcher(d,{baseUrl:Y}),u=(0,fe.load)(l),m=u('iframe[src*="mixdrop"], a[href*="mixdrop"]');for(let h of m){let f=u(h).attr("src")||u(h).attr("href");f&&f.includes("mixdrop")&&n.push({embedId:"mixdrop",url:f.startsWith("http")?f:`https:${f}`})}}catch{continue}}}return e.progress(90),{embeds:n}},scrapeShow:async e=>{let r=zr(await e.proxiedFetcher("/series/",{baseUrl:Y,query:{s:e.media.title}}));if(r.length===0)throw new p("No watchable item found");let t=r.find(m=>m&&U(e.media,m.title,m.year))?.url;if(!t)throw new p("No watchable item found");e.progress(50);let o=await e.proxiedFetcher(t,{baseUrl:Y}),s=(0,fe.load)(o),n=[],a=e.media.season.number<10?`0${e.media.season.number}`:e.media.season.number.toString(),i=e.media.episode.number<10?`0${e.media.episode.number}`:e.media.episode.number.toString(),c=s(`a:contains("S${a}E${i}"), a:contains("${e.media.season.number}x${e.media.episode.number}")`).attr("href"),d=o;if(c)d=await e.proxiedFetcher(c,{baseUrl:Y});else try{d=await e.proxiedFetcher(t,{method:"POST",body:new URLSearchParams({[`S${a}E${i}`]:""}),baseUrl:Y})}catch{}let l=(0,fe.load)(d),u=l('iframe[src*="mixdrop"], a[href*="mixdrop"], button[data-url*="mixdrop"]');for(let m of u){let h=l(m).attr("src")||l(m).attr("href")||l(m).attr("data-url");h&&h.includes("mixdrop")&&n.push({embedId:"mixdrop",url:h.startsWith("http")?h:`https:${h}`})}if(n.length===0){let m=l('iframe[name="player"], iframe[src]');for(let h of m){let f=l(h).attr("src");if(f)try{let b=await e.proxiedFetcher(f.startsWith("http")?f:`https:${f}`),y=(0,fe.load)(b),C=y('iframe[src*="mixdrop"], a[href*="mixdrop"]');for(let x of C){let E=y(x).attr("src")||y(x).attr("href");E&&E.includes("mixdrop")&&n.push({embedId:"mixdrop",url:E.startsWith("http")?E:`https:${E}`})}}catch{continue}}}return e.progress(90),{embeds:n}}});var W={decoder1:e=>{let t=[];for(let o=0;o<e.length;o+=3)t.push(e.substring(o,Math.min(o+3,e.length)));return t.reverse().join("")},decoder2:e=>{let r="pWB9V)[*4I`nJpp?ozyB~dbr9yt!_n4u".split("").map(n=>n.charCodeAt(0)),t=3,s=(e.match(/.{2}/g)||[]).map(n=>parseInt(n,16)).map((n,a)=>(n^r[a%r.length])-t);return Buffer.from(String.fromCharCode(...s),"base64").toString("utf-8")},decoder3:e=>{let r=e.split("").map(t=>/[a-mA-M]/.test(t)?String.fromCharCode(t.charCodeAt(0)+13):/[n-zN-Z]/.test(t)?String.fromCharCode(t.charCodeAt(0)-13):t);return Buffer.from(r.join(""),"base64").toString("utf-8")},decoder4:e=>{let r=e.split("").reverse().join(""),t=Array.from(r).filter((o,s)=>s%2===0).join("");return Buffer.from(t,"base64").toString("utf-8")},decoder5:e=>{try{let r=e.split("").reverse().join("");return(Array.from(r).map(n=>String.fromCharCode(n.charCodeAt(0)-1)).join("").match(/.{1,2}/g)||[]).map(n=>{let a=parseInt(n,16);return Number.isNaN(a)?"":String.fromCharCode(a)}).join("")}catch{return""}},decoder6:e=>{let r=Array.from(e).reverse().map(o=>o.charCodeAt(0)-1),t=[];for(let o=0;o<r.length;o+=2)t.push(parseInt(String.fromCharCode(r[o],r[o+1]),16));return Buffer.from(t).toString("utf8")},decoder7:e=>{let r=e.slice(10,-16),t='3SAY~#%Y(V%>5d/Yg"$G[Lh1rK4a;7ok'.split("").map(a=>a.charCodeAt(0)),n=Buffer.from(r,"base64").toString("binary").split("").map(a=>a.charCodeAt(0)).map((a,i)=>a^t[i%t.length]);return String.fromCharCode(...n)},decoder8:e=>{let r={x:"a",y:"b",z:"c",a:"d",b:"e",c:"f",d:"g",e:"h",f:"i",g:"j",h:"k",i:"l",j:"m",k:"n",l:"o",m:"p",n:"q",o:"r",p:"s",q:"t",r:"u",s:"v",t:"w",u:"x",v:"y",w:"z",X:"A",Y:"B",Z:"C",A:"D",B:"E",C:"F",D:"G",E:"H",F:"I",G:"J",H:"K",I:"L",J:"M",K:"N",L:"O",M:"P",N:"Q",O:"R",P:"S",Q:"T",R:"U",S:"V",T:"W",U:"X",V:"Y",W:"Z"};return Array.from(e).map(t=>r[t]||t).join("")},decoder9:e=>r=>{let t=r.split("").reverse().map(n=>n==="-"?"+":n==="_"?"/":n).join(""),s=Buffer.from(t,"base64").toString("binary").split("").map(n=>n.charCodeAt(0)-e);return String.fromCharCode(...s)}},sc={NdonQLf1Tzyx7bMG:W.decoder1,sXnL9MQIry:W.decoder2,IhWrImMIGL:W.decoder3,KJHidj7det:W.decoder7,Oi3v1dAlaM:W.decoder9(5),TsA2KGDGux:W.decoder9(7),JoAHUMCLXV:W.decoder9(3),eSfH1IRMyL:W.decoder6,o2VSUnjnZl:W.decoder8,xTyBxQyGTA:W.decoder4,ux8qjPHC66:W.decoder5};function ko(e,r){let t=sc[e];if(!t)return console.log(`[Cloudnestra] Unknown decoder ID: ${e}`),null;try{let o=t(r);return!o||!o.includes("http")&&!o.includes(".m3u8")?(console.log(`[Cloudnestra] Decoder ${e} produced invalid result. Length: ${o?.length||0}, Preview: ${o?.substring(0,50)||"empty"}`),null):o}catch(o){return console.log(`[Cloudnestra] Decoder ${e} failed:`,o),null}}function Co(e){let r=/<div id="([^"]+)" style="display:none;">([^<]+)<\/div>/,t=e.match(r);return t?{id:t[1],content:t[2]}:null}var Oo=require("tough-cookie"),Ro=require("undici"),xo=new Oo.CookieJar;async function Vr(e,r={}){let{referer:t,origin:o,retries:s=3,delay:n=2e3}=r,a={"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8","Accept-Language":"en-US,en;q=0.5","Accept-Encoding":"gzip, deflate, br",DNT:"1",Connection:"keep-alive","Upgrade-Insecure-Requests":"1","Sec-Fetch-Dest":"document","Sec-Fetch-Mode":"navigate","Sec-Fetch-Site":"none","Cache-Control":"max-age=0"};t&&(a.Referer=t),o&&(a.Origin=o);let i=await xo.getCookies(e);i.length>0&&(a.Cookie=i.map(d=>`${d.key}=${d.value}`).join("; "));let c=null;for(let d=0;d<s;d++)try{if(d>0){let h=Math.floor(Math.random()*1e3)+n;await new Promise(f=>{setTimeout(f,h)})}let l=await(0,Ro.fetch)(e,{headers:a,redirect:"follow"}),u=l.headers.get("set-cookie");if(u){let h=Array.isArray(u)?u:[u];for(let f of h)await xo.setCookie(f,e)}if(!l.ok){if(l.status===403){c=new Error("Cloudflare blocked (403)");continue}if(l.status===503){c=new Error("Service unavailable (503)");continue}throw new Error(`HTTP ${l.status}: ${l.statusText}`)}let m=await l.text();if(m.includes("cf-turnstile")||m.includes("Checking your browser")||m.includes("cf-challenge")){c=new Error("Cloudflare challenge cannot be bypassed without browser");continue}return m}catch(l){c=l}throw c||new Error("Failed to fetch after multiple retries")}function Mo(e){let r=/<script[^>]*>([\s\S]*?)<\/script>/gi,t=[],o=e.matchAll(r);for(let s of o)t.push(s[1]);return t}async function Io(e){let r=e.media.imdbId;if(!r)throw new p("IMDb ID not found");let t=e.media.type==="show",o,s;if(t){let k=e.media;o=k.season?.number,s=k.episode?.number}let n=t?`https://vidsrc-embed.ru/embed/tv?imdb=${r}&season=${o}&episode=${s}`:`https://vidsrc-embed.ru/embed/${r}`;e.progress(10);let a=await e.proxiedFetcher(n,{headers:{Referer:"https://vidsrc-embed.ru/","User-Agent":"Mozilla/5.0"}});e.progress(30);let i=a.match(/<iframe[^>]*id="player_iframe"[^>]*src="([^"]*)"[^>]*>/);if(!i)throw new p("Initial iframe not found");let c=i[1].startsWith("//")?`https:${i[1]}`:i[1];e.progress(50);let d=await Vr(c,{referer:n,retries:3,delay:3e3}),l=d.match(/src:\s+'(\/prorcp\/[^']+)'/);if(!l){let k=d.match(/file\s*:\s*['"]([^'"]*\.m3u8[^'"]*)['"]/);if(!k)throw new p("Could not find prorcp iframe or direct m3u8 URL - Cloudflare may be blocking");return{stream:[{id:"vidsrc-cloudnestra-0",type:"hls",playlist:k[1],headers:{referer:"https://cloudnestra.com/",origin:"https://cloudnestra.com"},proxyDepth:2,flags:[],captions:[]}],embeds:[]}}let u=`https://cloudnestra.com${l[1]}`;e.progress(70);let m=await Vr(u,{referer:c,retries:3,delay:2e3}),h=Mo(m),f="";for(let k of h)if(k.includes("Playerjs")){f=k;break}if(!f)throw new p("No Playerjs config found");let b="",y=f.match(/file\s*:\s*['"]([^'"]+)['"]/);if(y)b=y[1];else{let k=f.match(/file\s*:\s*([a-zA-Z0-9_]+)\s*[,}]/);if(k){let D=k[1],j=m.match(new RegExp(`<div id="${D}"[^>]*>\\s*([^<]+)\\s*</div>`,"s"));if(j){let K=j[1].trim();try{b=Buffer.from(K,"base64").toString("utf-8")}catch{b=K}}else throw new p("No file data found in referenced div")}else throw new p("No file field in Playerjs")}let C=Co(m);if(C){let k=ko(C.id,C.content);k&&(k.includes("http")||k.includes(".m3u8"))&&(b=k)}if(!b.includes(".m3u8")&&!b.startsWith("http"))throw new p("Could not decode stream URL - decoder params not found or invalid");let x=b.split(" or "),E=[],L={};for(let k of h){let D=k.match(/v1\s*=\s*['"]([^'"]+)['"]/),j=k.match(/v2\s*=\s*['"]([^'"]+)['"]/),K=k.match(/v3\s*=\s*['"]([^'"]+)['"]/),J=k.match(/v4\s*=\s*['"]([^'"]+)['"]/);D&&(L.v1=D[1]),j&&(L.v2=j[1]),K&&(L.v3=K[1]),J&&(L.v4=J[1])}L.v1||(L.v1="shadowlandschronicles.com");let _={referer:"https://cloudnestra.com/",origin:"https://cloudnestra.com"};for(let k of x){k=k.trim();for(let[D,j]of Object.entries(L))k.includes(`{${D}}`)&&(k=k.replace(new RegExp(`{${D}}`,"g"),j));k.includes("tmstr5")&&(k=k.replace(/tmstr5/g,"tmstr2")),!k.match(/{v\d+}/)&&E.push({id:`vidsrc-cloudnestra-${E.length}`,type:"hls",playlist:k,headers:_,proxyDepth:2,flags:[],captions:[]})}if(e.progress(90),E.length===0)throw new p("No valid streams found");return{stream:E,embeds:[]}}var $o=S({id:"cloudnestra",name:"Cloudnestra",rank:180,flags:[],scrapeMovie:Io,scrapeShow:Io});var nc="https://api2.vidsrc.vip";function ac(e){return["a","b","c","d","e","f","g","h","i","j"][parseInt(e,10)]}function ic(e,r,t,o){let s;r==="show"&&t&&o?s=`${e}-${t}-${o}`:s=e.split("").map(ac).join("");let n=s.split("").reverse().join("");return btoa(btoa(n))}async function Po(e){let r=e.media.type==="show"?"tv":"movie",t=ic(e.media.tmdbId,e.media.type,e.media.type==="show"?e.media.season.number:void 0,e.media.type==="show"?e.media.episode.number:void 0),o=`${nc}/${r}/${t}`,s=await e.proxiedFetcher(o);if(!s||!s.source1)throw new p("No sources found");let n=[],a=["vidsrc-comet","vidsrc-pulsar","vidsrc-nova"],i=0;for(let c=1;s[`source${c}`];c++){let d=s[`source${c}`];d?.url&&(n.push({embedId:a[i%a.length],url:d.url}),i++)}if(n.length===0)throw new p("No embeds found");return{embeds:n}}var Fo=S({id:"vidsrcvip",name:"VidSrc.vip",rank:150,disabled:!0,flags:[g.CORS_ALLOWED],scrapeMovie:Po,scrapeShow:Po});var Je=require("cheerio"),Uo=require("unpacker");var Pe="https://zoechip.org";function Ao(e){return e.toLowerCase().replace(/[^a-z0-9\s-]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").trim()}async function cc(e,r){let t={Referer:Pe,"User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36"},s=(await e.proxiedFetcher.full(r,{method:"HEAD",headers:t})).finalUrl;if(!s)return null;let n=await e.proxiedFetcher(s,{headers:t}),i=(0,Je.load)(n)("iframe").attr("src");if(!i)throw new p("No iframe URL found");let d=(await e.proxiedFetcher(i,{headers:t})).match(/eval\(function\(p,a,c,k,e,.*\)\)/i);if(!d)throw new p("No packed JavaScript found");let u=(0,Uo.unpack)(d[0]).match(/file\s*:\s*"([^"]+)"/i);if(!u)throw new p("No file URL found in unpacked JavaScript");return u[1]}async function Lo(e){let r={Referer:Pe,"User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36"},t,o;if(e.media.type==="movie"){let h=Ao(e.media.title);t=`${Pe}/film/${h}-${e.media.releaseYear}`}else{let h=Ao(e.media.title);t=`${Pe}/episode/${h}-season-${e.media.season.number}-episode-${e.media.episode.number}`}e.progress(20);let s=await e.proxiedFetcher(t,{headers:r}),n=(0,Je.load)(s);if(o=n("div#show_player_ajax").attr("movie-id"),!o){let h=n("[data-movie-id]").attr("data-movie-id")||n("[movie-id]").attr("movie-id")||n(".player-wrapper").attr("data-id");if(h)o=h;else throw new p(`No content found for ${e.media.type==="movie"?"movie":"episode"}`)}e.progress(40);let a=`${Pe}/wp-admin/admin-ajax.php`,i={...r,"X-Requested-With":"XMLHttpRequest","Content-Type":"application/x-www-form-urlencoded; charset=UTF-8",Referer:t},c=new URLSearchParams({action:"lazy_player",movieID:o}),d=await e.proxiedFetcher(a,{method:"POST",headers:i,body:c.toString()}),l=(0,Je.load)(d),u=l("ul.nav a:contains(Filemoon)").attr("data-server");if(!u)throw l("ul.nav a").map((f,b)=>({name:l(b).text().trim(),url:l(b).attr("data-server")})).get().length===0?new p("No streaming servers found"):new p("Filemoon server not available");e.progress(60);let m=await cc(e,u);if(!m)throw new p("Failed to extract file URL from streaming server");return e.progress(90),{stream:[{id:"primary",type:"hls",playlist:m,flags:[g.CORS_ALLOWED],captions:[]}],embeds:[]}}var To=S({id:"zoechip",name:"ZoeChip",rank:170,disabled:!0,flags:[],scrapeMovie:Lo,scrapeShow:Lo});var dc=["pahe","zoro","zaza","meg","bato"],lc="https://backend.animetsu.to",No={referer:"https://animetsu.to/",origin:"https://backend.animetsu.to",accept:"application/json, text/plain, */*","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"};function pc(e,r=100){return v({id:`animetsu-${e}`,name:`${e.charAt(0).toUpperCase()+e.slice(1)}`,rank:r,async scrape(t){let o=e,s=JSON.parse(t.url),{type:n,animetsuId:a,episode:i}=s;if(n!=="movie"&&n!=="show")throw new p("Unsupported media type");let c=await t.proxiedFetcher("/api/anime/tiddies",{baseUrl:lc,headers:No,query:{server:o,id:String(a),num:String(i??1),subType:"dub"}});console.log("Animetsu API Response:",JSON.stringify(c,null,2));let d=c?.sources?.[0];if(!d?.url)throw new p("No source URL found");let l=d.url,u=d.type,m=d.quality,h={...No};if(l.includes("animetsu.cc")){let{referer:f,origin:b,...y}=h;h={...y,origin:"https://backend.animetsu.cc",referer:"https://backend.animetsu.cc/"}}if(t.progress(100),u==="mp4"){let f="unknown";if(m){let b=m.match(/(\d+)p?/);b&&(f=parseInt(b[1],10))}return{stream:[{id:"primary",captions:[],qualities:{[f]:{type:"mp4",url:l}},type:"file",headers:h,flags:[]}]}}return{stream:[{id:"primary",type:"hls",playlist:l,headers:h,flags:[],captions:[]}]}}})}var _o=dc.map((e,r)=>pc(e,300-r));var uc=[{id:"autoembed-english",rank:10},{id:"autoembed-hindi",rank:9,disabled:!0},{id:"autoembed-tamil",rank:8,disabled:!0},{id:"autoembed-telugu",rank:7,disabled:!0},{id:"autoembed-bengali",rank:6,disabled:!0}];function mc(e){return v({id:e.id,name:e.id.split("-").map(r=>r[0].toUpperCase()+r.slice(1)).join(" "),disabled:e.disabled,rank:e.rank,async scrape(r){return{stream:[{id:"primary",type:"hls",playlist:r.url,flags:[g.CORS_ALLOWED],captions:[]}]}}})}var[Do,qo,Bo,jo,Wo]=uc.map(mc);var fc=atob("aHR0cHM6Ly9jaW5lbWFvcy12My52ZXJjZWwuYXBwL2FwaS9uZW8vYmFja2VuZGZldGNo");function hc(e,r){return v({id:`cinemaos-${e}`,name:`${e.charAt(0).toUpperCase()+e.slice(1)}`,rank:r,disabled:!0,async scrape(t){let o=JSON.parse(t.url),{tmdbId:s,type:n,season:a,episode:i}=o,c=`${fc}?requestID=${n==="show"?"tvVideoProvider":"movieVideoProvider"}&id=${s}&service=${e}`;n==="show"&&(c+=`&season=${a}&episode=${i}`);let d=await t.proxiedFetcher(c),u=(typeof d=="string"?JSON.parse(d):d)?.data?.sources;if(!u||!Array.isArray(u)||u.length===0)throw new p("No sources found");if(t.progress(80),u.length===1)return{stream:[{id:"primary",type:"hls",playlist:u[0].url,flags:[g.CORS_ALLOWED],captions:[]}]};let m={};for(let h of u){let f=(h.quality||h.source||"unknown").toString(),b;f==="4K"?b=2160:b=parseInt(f.replace("P",""),10),!(Number.isNaN(b)||m[b])&&(m[b]={type:"mp4",url:h.url})}return{stream:[{id:"primary",type:"file",flags:[g.CORS_ALLOWED],qualities:m,captions:[]}]}}})}var gc=["shadow","asiacloud","ophim"],Ho=gc.map((e,r)=>hc(e,300-r));function bc(e,r=100){return v({id:`cinemaos-hexa-${e}`,name:`Hexa ${e.charAt(0).toUpperCase()+e.slice(1)}`,disabled:!0,rank:r,async scrape(t){let s=JSON.parse(t.url).directUrl;if(!s)throw new p("No directUrl provided for Hexa embed");return{stream:[{id:"primary",type:"hls",playlist:O(s,{referer:"https://megacloud.store/",origin:"https://megacloud.store"}),flags:[g.CORS_ALLOWED],captions:[]}]}}})}var yc=["alpha","bravo","charlie","delta","echo","foxtrot","golf","hotel","india"],Yu=yc.map((e,r)=>bc(e,315-r));var zo=require("cheerio"),Vo=require("unpacker");function Sc(e){let r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",t=e.replace(/=+$/,""),o="";if(t.length%4===1)throw new Error("The string to be decoded is not correctly encoded.");for(let s=0,n=0,a=0;a<t.length;a++){let i=t.charAt(a),c=r.indexOf(i);c!==-1&&(n=s%4?n*64+c:c,s++%4&&(o+=String.fromCharCode(255&n>>(-2*s&6))))}return o}function wc(e){let t=e.join("");t=atob(t),t=t.replace(/[a-zA-Z]/g,function(n){let i=n.charCodeAt(0)+13,c=n<="Z"?90:122;return String.fromCharCode(i<=c?i:i-26)}),t=t.split("").reverse().join("");let o="";for(let s=0;s<t.length;s++){let n=t.charCodeAt(s);n=(n-399756995%(s+5)+256)%256,o+=String.fromCharCode(n)}return o}var vc="https://ridomovies.tv/",Ge=v({id:"closeload",name:"CloseLoad",rank:106,async scrape(e){let r=new URL(e.url).origin,t=await e.proxiedFetcher(e.url,{headers:{referer:vc}}),o=(0,zo.load)(t),s=o("track").map((l,u)=>{let m=o(u),h=`${r}${m.attr("src")}`,f=m.attr("label")??"",b=q(f),y=pe(h);return!b||!y?null:{id:h,language:b,hasCorsRestrictions:!0,type:y,url:h}}).get().filter(l=>l!==null),n=o("script").filter((l,u)=>{let m=o(u);return(m.attr("type")==="text/javascript"&&m.html()?.includes("p,a,c,k,e,d"))??!1}).html();if(!n)throw new Error("Couldn't find eval code");let a=(0,Vo.unpack)(n),i,c=a.match(/dc_\w+\(\[([^\]]+)\]\)/);if(c){let u=c[1].match(/"([^"]+)"/g);if(u){let m=u.map(h=>h.slice(1,-1));try{let h=wc(m);(h.startsWith("http://")||h.startsWith("https://"))&&(i=h)}catch{}}}if(!i){let l=[/var\s+(\w+)\s*=\s*"([^"]+)";/g,/(\w+)\s*=\s*"([^"]+)"/g,/"([A-Za-z0-9+/=]+)"/g];for(let u of l){let m=u.exec(a);if(m){let h=m[2]||m[1];if(/^[A-Za-z0-9+/]*={0,2}$/.test(h)&&h.length>10){i=h;break}}}}if(!i)throw new p("Unable to find source url");let d;if(i.startsWith("http://")||i.startsWith("https://"))d=i;else{if(!/^[A-Za-z0-9+/]*={0,2}$/.test(i))throw new p("Invalid base64 encoding found in source url");let u;try{u=atob(i)}catch{try{u=Sc(i)}catch{throw new p(`Failed to decode base64 source url: ${i.substring(0,50)}...`)}}let m=u.match(/(https?:\/\/[^\s"']+)/);if(m)d=m[1];else if(u.startsWith("http://")||u.startsWith("https://"))d=u;else throw new p(`Decoded string is not a valid URL: ${u.substring(0,100)}...`)}return{stream:[{id:"primary",type:"hls",playlist:d,captions:s,flags:[g.IP_LOCKED],headers:{Referer:"https://closeload.top/",Origin:"https://closeload.top"}}]}}});var Ye="madplay.site",X={referer:"https://madplay.site/",origin:"https://madplay.site","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"},Ko=v({id:"madplay-base",name:"Base",rank:134,async scrape(e){let r=JSON.parse(e.url),{type:t,tmdbId:o,season:s,episode:n}=r,a=`https://${Ye}/api/playsrc`;t==="movie"?a+=`?id=${o}`:t==="show"&&(a+=`?id=${o}&season=${s}&episode=${n}`);let i=await e.proxiedFetcher(a,{headers:X});if(console.log(i),!Array.isArray(i)||i.length===0)throw new p("No streams found");let c=i[0];if(!c.file)throw new p("No file URL found in stream");return e.progress(100),{stream:[{id:"primary",type:"hls",playlist:O(c.file,X),flags:[g.CORS_ALLOWED],captions:[]}]}}}),Jo=v({id:"madplay-nsapi",name:"Northstar",rank:133,async scrape(e){let r=JSON.parse(e.url),{type:t,tmdbId:o,season:s,episode:n}=r,a=`https://${Ye}/api/nsapi/vid`;t==="movie"?a+=`?id=${o}`:t==="show"&&(a+=`?id=${o}&season=${s}&episode=${n}`);let i=await e.proxiedFetcher(a,{headers:X});if(console.log(i),!Array.isArray(i)||i.length===0)throw new p("No streams found");let c=i[0];if(!c.url)throw new p("No file URL found in stream");return e.progress(100),{stream:[{id:"primary",type:"hls",playlist:O(c.url,c.headers||X),flags:[g.CORS_ALLOWED],captions:[]}]}}}),Go=v({id:"madplay-roper",name:"Roper",rank:132,async scrape(e){let r=JSON.parse(e.url),{type:t,tmdbId:o,season:s,episode:n}=r,a=`https://${Ye}/api/roper/`;t==="movie"?a+=`?id=${o}&type=movie`:t==="show"&&(a+=`?id=${o}&season=${s}&episode=${n}&type=series`);let i=await e.proxiedFetcher(a,{headers:X});if(console.log(i),!Array.isArray(i)||i.length===0)throw new p("No streams found");let c=i[0];if(!c.url)throw new p("No file URL found in stream");return e.progress(100),{stream:[{id:"primary",type:"hls",playlist:O(c.url,c.headers||X),flags:[g.CORS_ALLOWED],captions:[]}]}}}),Yo=v({id:"madplay-vidfast",name:"Vidfast",rank:131,async scrape(e){let r=JSON.parse(e.url),{type:t,tmdbId:o,season:s,episode:n}=r,a=`https://${Ye}/api/nsapi/test?url=https://vidfast.pro/`;t==="movie"?a+=`/movie/${o}`:t==="show"&&(a+=`/tv/${o}/${s}/${n}`);let i=await e.proxiedFetcher(a,{headers:X});if(console.log(i),!Array.isArray(i)||i.length===0)throw new p("No streams found");let c=i[0];if(!c.url)throw new p("No file URL found in stream");return e.progress(100),{stream:[{id:"primary",type:"hls",playlist:O(c.url,c.headers||X),flags:[g.CORS_ALLOWED],captions:[]}]}}});var Ec=[{id:"mp4hydra-1",name:"MP4Hydra Server 1",rank:36},{id:"mp4hydra-2",name:"MP4Hydra Server 2",rank:35,disabled:!0}];function kc(e){return v({id:e.id,name:e.name,disabled:!0,rank:e.rank,async scrape(r){let[t,o]=r.url.split("|");return{stream:[{id:"primary",type:"file",qualities:{[me(o||"")]:{url:t,type:"mp4"}},flags:[g.CORS_ALLOWED],captions:[]}]}}})}var[Xo,Zo]=Ec.map(kc);var Cc="https://ridomovies.tv/",xc={referer:"https://ridoo.net/",origin:"https://ridoo.net"},Xe=v({id:"ridoo",name:"Ridoo",rank:121,async scrape(e){let r=await e.proxiedFetcher(e.url,{headers:{referer:Cc}}),o=/file:"([^"]+)"/g.exec(r)?.[1];if(!o)throw new p("Unable to find source url");return{stream:[{id:"primary",type:"hls",playlist:o,headers:xc,captions:[],flags:[g.CORS_ALLOWED]}]}}});var Oc=[{id:"streamtape",name:"Streamtape",rank:160},{id:"streamtape-latino",name:"Streamtape (Latino)",rank:159}];function Rc(e){return v({id:e.id,name:e.name,rank:e.rank,async scrape(r){let o=(await r.proxiedFetcher(r.url)).match(/robotlink'\).innerHTML = (.*)'/);if(!o)throw new Error("No match found");let[s,n]=o?.[1]?.split("+ ('")??[];if(!s||!n)throw new Error("No match found");let a=`https:${s?.replace(/'/g,"").trim()}${n?.substring(3).trim()}`;return{stream:[{id:"primary",type:"file",flags:[g.CORS_ALLOWED,g.IP_LOCKED],captions:[],qualities:{unknown:{type:"mp4",url:a}},headers:{Referer:"https://streamtape.com"}}]}}})}var[Qo,es]=Oc.map(Rc);var rs=P(require("unpacker"),1);var Mc=/(eval\(function\(p,a,c,k,e,d\).*\)\)\))/,Ic=/src:"(https:\/\/[^"]+)"/,ts=v({id:"streamvid",name:"Streamvid",rank:215,async scrape(e){let t=(await e.proxiedFetcher(e.url)).match(Mc);if(!t)throw new Error("streamvid packed not found");let s=rs.unpack(t[1]).match(Ic);if(!s)throw new Error("streamvid link not found");return{stream:[{type:"hls",id:"primary",playlist:s[1],flags:[g.CORS_ALLOWED],captions:[]}]}}});var Kr=class{constructor(r){this.ALPHABET={62:"0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",95:"' !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~'"};this.dictionary={};if(this.base=r,r>36&&r<62&&(this.ALPHABET[r]=this.ALPHABET[r]||this.ALPHABET[62].substring(0,r)),r>=2&&r<=36)this.unbase=t=>parseInt(t,r);else{try{[...this.ALPHABET[r]].forEach((t,o)=>{this.dictionary[t]=o})}catch{throw new Error("Unsupported base encoding.")}this.unbase=this._dictunbaser.bind(this)}}_dictunbaser(r){let t=0;return[...r].reverse().forEach((o,s)=>{t+=this.base**s*this.dictionary[o]}),t}};function $c(e){let r=[/}\('(.*)', *(\d+|\[\]), *(\d+), *'(.*)'\.split\('\|'\), *(\d+), *(.*)\)\)/,/}\('(.*)', *(\d+|\[\]), *(\d+), *'(.*)'\.split\('\|'\)/];for(let t of r){let o=t.exec(e);if(o)try{return{payload:o[1],symtab:o[4].split("|"),radix:parseInt(o[2],10),count:parseInt(o[3],10)}}catch{throw new Error("Corrupted p.a.c.k.e.r. data.")}}throw new Error("Could not make sense of p.a.c.k.e.r data (unexpected code structure)")}function Pc(e){let{payload:r,symtab:t,radix:o,count:s}=$c(e);if(s!==t.length)throw new Error("Malformed p.a.c.k.e.r. symtab.");let n;try{n=new Kr(o)}catch{throw new Error("Unknown p.a.c.k.e.r. encoding.")}let a=c=>{let d=c;return(o===1?t[parseInt(d,10)]:t[n.unbase(d)])||d},i=r.replace(/\b\w+\b/g,a);return i}var Fc=[{id:"streamwish-japanese",name:"StreamWish (Japanese Sub Espa\xF1ol)",rank:171},{id:"streamwish-latino",name:"streamwish (latino)",rank:170},{id:"streamwish-spanish",name:"streamwish (castellano)",rank:169},{id:"streamwish-english",name:"streamwish (english)",rank:168}];function Ac(e){return v({id:e.id,name:e.name,rank:e.rank,async scrape(r){let t={Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8","Accept-Encoding":"*","Accept-Language":"en-US,en;q=0.9","User-Agent":"Mozilla/5.0"},o;try{o=await r.proxiedFetcher(r.url,{headers:t})}catch(l){throw console.error("Error details:",{message:l instanceof Error?l.message:"Unknown error",cause:l.cause||void 0,url:r.url}),l}let s=o.match(/<script[^>]*>\s*(eval\(function\(p,a,c,k,e,d.*?\)[\s\S]*?)<\/script>/);if(!s)return{stream:[],embeds:[{embedId:e.id,url:r.url}]};let n;try{n=Pc(s[1])}catch{return{stream:[],embeds:[{embedId:e.id,url:r.url}]}}let i=Array.from(n.matchAll(/"(hls2|hls4)"\s*:\s*"([^"]*\.m3u8[^"]*)"/g)).map(l=>({key:l[1],url:l[2]}));if(!i.length)return{stream:[],embeds:[{embedId:e.id,url:r.url}]};let c=i[0].url;/^https?:\/\//.test(c)||(c=`https://swiftplayers.com/${c.replace(/^\/+/g,"")}`);try{let l=await r.proxiedFetcher(c,{headers:{Referer:r.url}}),u=Array.from(l.matchAll(/#EXT-X-STREAM-INF:[^\n]+\n(?!iframe)([^\n]*index[^\n]*\.m3u8[^\n]*)/gi));if(u.length>0){let m=u.find(f=>/#EXT-X-STREAM-INF/.test(f.input||""))||u[0];c=c.substring(0,c.lastIndexOf("/")+1)+m[1]}}catch{}let d={Referer:r.url,Origin:r.url};return{stream:[{id:"primary",type:"hls",playlist:O(c,d),flags:[g.CORS_ALLOWED],captions:[]}],embeds:[]}}})}var[os,ss,ns,as]=Fc.map(Ac);var is=v({id:"vidcloud",name:"VidCloud",rank:201,disabled:!0,async scrape(e){return{stream:(await ze.scrape(e)).stream.map(t=>({...t,flags:[]}))}}});var ds=["alfa","bravo","charlie","delta","echo","foxtrot","golf","hotel","india","juliett"],Lc="api.vidify.top",Ze="https://player.vidify.top/",Qe=null,cs=0;async function Uc(e){let r=Date.now();if(Qe&&r-cs<1e3*60*60)return Qe;let t=await e.proxiedFetcher(Ze,{headers:{Referer:Ze}}),o=/\/assets\/index-([a-zA-Z0-9-]+)\.js/,s=t.match(o);if(!s)throw new Error("Could not find the JS file URL in the player page");let n=new URL(s[0],Ze).href,a=await e.proxiedFetcher(n,{headers:{Referer:Ze}}),i=/Authorization:"Bearer\s*([^"]+)"/,c=a.match(i);if(!c||!c[1])throw new Error("Could not extract the authorization header from the JS file");return Qe=`Bearer ${c[1]}`,cs=r,Qe}function Tc(e,r=100){let t=ds.indexOf(e)+1;return v({id:`vidify-${e}`,name:`${e.charAt(0).toUpperCase()+e.slice(1)}`,rank:r,disabled:!0,async scrape(o){let s=JSON.parse(o.url),{type:n,tmdbId:a,season:i,episode:c}=s,d=`https://${Lc}/`;if(n==="movie")d+=`/movie/${a}?sr=${t}`;else if(n==="show")d+=`/tv/${a}/season/${i}/episode/${c}?sr=${t}`;else throw new p("Unsupported media type");let u={referer:"https://player.vidify.top/",origin:"https://player.vidify.top",Authorization:await Uc(o),"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"},m=await o.proxiedFetcher(d,{headers:u});console.log(m);let h=m.m3u8??m.url;if(Array.isArray(m.result)&&m.result.length>0){let y={};if(m.result.forEach(C=>{C.url.includes(".mp4")&&(y[`${C.resolution}p`]={type:"mp4",url:decodeURIComponent(C.url)})}),Object.keys(y).length===0)throw new p("No MP4 streams found");return console.log("Found MP4 streams: ",y),{stream:[{id:"primary",type:"file",qualities:y,flags:[],captions:[],headers:{Host:"proxy-worker.himanshu464121.workers.dev"}}]}}if(!h)throw new p("No playlist URL found");let f={...u},b;return h.includes("proxyv1.vidify.top")?(console.log("Found stream (proxyv1): ",h,f),f.Host="proxyv1.vidify.top",b=decodeURIComponent(h)):h.includes("proxyv2.vidify.top")?(console.log("Found stream (proxyv2): ",h,f),f.Host="proxyv2.vidify.top",b=decodeURIComponent(h)):(console.log("Found normal stream: ",h),b=O(decodeURIComponent(h),f)),o.progress(100),{stream:[{id:"primary",type:"hls",playlist:b,headers:f,flags:[],captions:[]}]}}})}var ls=ds.map((e,r)=>Tc(e,230-r));var ps=v({id:"vidnest-hollymoviehd",name:"HollyMovie",rank:104,async scrape(e){let r=await e.proxiedFetcher(e.url);if(!r.success||!r.sources)throw new p("No streams found");let t=[];for(let o of r.sources)o.file.includes("pkaystream.cc/pl/")&&t.push({id:`hollymoviehd-${o.label}`,type:"hls",playlist:O(o.file),flags:[g.CORS_ALLOWED],captions:[]});return{stream:t}}}),us=v({id:"vidnest-allmovies",name:"AllMovies (Hindi)",rank:103,async scrape(e){let r=await e.proxiedFetcher(e.url);if(!r.streams)throw new p("No streams found");let t=[];for(let o of r.streams)t.push({id:`allmovies-${o.language}`,type:"hls",playlist:o.url,flags:[g.CORS_ALLOWED],captions:[],preferredHeaders:o.headers});return{stream:t}}}),ms=v({id:"vidnest-flixhq",name:"FlixHQ",rank:102,disabled:!0,async scrape(){throw new Error("Not implemented")}}),fs=v({id:"vidnest-official",name:"Official",rank:101,disabled:!0,async scrape(){throw new Error("Not implemented")}});var Nc=[{id:"server-13",rank:112},{id:"server-18",rank:111},{id:"server-11",rank:102},{id:"server-7",rank:92},{id:"server-10",rank:82},{id:"server-1",rank:72},{id:"server-16",rank:64},{id:"server-3",rank:62},{id:"server-17",rank:52},{id:"server-2",rank:42},{id:"server-4",rank:32},{id:"server-5",rank:24},{id:"server-14",rank:22},{id:"server-6",rank:21},{id:"server-15",rank:20},{id:"server-8",rank:19},{id:"server-9",rank:18},{id:"server-19",rank:17},{id:"server-12",rank:16}];function _c(e){return v({id:e.id,name:e.name||e.id.split("-").map(r=>r[0].toUpperCase()+r.slice(1)).join(" "),disabled:!0,rank:e.rank,async scrape(r){return{stream:[{id:"primary",type:"hls",playlist:r.url,flags:[g.CORS_ALLOWED],captions:[]}]}}})}var[hs,gs,bs,ys,Ss,ws,vs,Es,ks,Cs,xs,Os,Rs]=Nc.map(_c);var Ms=v({id:"viper",name:"Viper",rank:182,disabled:!0,async scrape(e){let r=await e.proxiedFetcher.full(e.url,{headers:{Accept:"application/json",Referer:"https://embed.su/"}});if(!r.body.source)throw new p("No source found");let t=r.body.source.replace(/^.*\/viper\//,"https://");return{stream:[{type:"hls",id:"primary",playlist:O(t,{referer:"https://megacloud.store/",origin:"https://megacloud.store"}),flags:[g.CORS_ALLOWED],captions:[]}]}}});async function Dc(e,r){let t=await e.proxiedFetcher("https://cloud.mail.ru/public/uaRH/2PYWcJRpH"),s=/"videowl_view":\{"count":"(\d+)","url":"([^"]+)"\}/g.exec(t)?.[2];if(!s)throw new p("Failed to get videoOwlUrl");return`${s}/0p/${btoa(r)}.m3u8?${new URLSearchParams({double_encode:"1"})}`}var er=v({id:"warezcdnembedhls",name:"WarezCDN HLS",disabled:!0,rank:83,async scrape(e){let r=await Be(e);if(!r)throw new p("can't get file id");let t=await Dc(e,r);return{stream:[{id:"primary",type:"hls",flags:[g.IP_LOCKED],captions:[],playlist:t}]}}});var rr=v({id:"warezplayer",name:"warezPLAYER",disabled:!0,rank:85,async scrape(e){let r=new URL(e.url),t=r.pathname.split("/")[2],o=await e.proxiedFetcher("/player/index.php",{baseUrl:r.origin,query:{data:t,do:"getVideo"},method:"POST",body:new URLSearchParams({hash:t}),headers:{"X-Requested-With":"XMLHttpRequest"}}),s=JSON.parse(o);if(!s.videoSource)throw new Error("Playlist not found");return{stream:[{id:"primary",type:"hls",flags:[],captions:[],playlist:s.videoSource,headers:{Accept:"*/*"}}]}}});var Is=require("cheerio");var $s=v({id:"wecima-embed",name:"Wecima Embed",rank:90,async scrape(e){let r=await e.proxiedFetcher(e.url),t=(0,Is.load)(r),o,s=t("script");for(let n of s){let a=t(n).html()||"",i=a.match(/https?:\/\/[^"']+\/master\.m3u8/);if(i){o=i[0];break}let c=a.match(/https?:\/\/fdewsdc\.sbs\/stream\/[^"']+\/master\.m3u8/);if(c){o=c[0];break}}if(!o){let n=t("video, source, div[data-src], div[data-url]");for(let a of n){let i=t(a).attr("src")||t(a).attr("data-src")||t(a).attr("data-url");if(i&&i.includes("master.m3u8")){o=i;break}}}if(!o)throw new Error("No HLS stream URL found in wecima embed");return{stream:[{id:"primary",type:"hls",flags:[g.IP_LOCKED],captions:[],playlist:o,headers:{Referer:e.url,Origin:new URL(e.url).origin}}]}}});var qc=["hd-2","miko","shiro","zaza"],Bc="https://vidnest.fun",tr={referer:"https://vidnest.fun/",origin:"https://vidnest.fun","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"};function jc(e,r=100){return v({id:`zunime-${e}`,name:`${e.charAt(0).toUpperCase()+e.slice(1)}`,rank:r,async scrape(t){let o=e,s=t.url,n="",a={};if(s.includes("/movie/")){let m=s.split("/movie/")[1];n="/api/movie",a={tmdb:m,server:o}}else if(s.includes("/tv/")){let m=s.split("/tv/")[1].split("/"),h=m[0],f=m[1]||"1",b=m[2]||"1";n="/api/tv",a={tmdb:h,season:f,episode:b,server:o}}else if(s.includes("/anime/")){let m=s.split("/anime/")[1].split("/"),h=m[0],f=m[1]||"1",b=m[2]||"dub";n="/api/anime",a={anilist:h,episode:f,server:o,type:b}}else throw new p("Invalid embed URL format");let i=await t.proxiedFetcher(n,{baseUrl:Bc,headers:tr,query:a});console.log("API Response:",i);let c=i,d=null,l=tr;if(c?.success&&c?.sources?.url?(d=c.sources.url,l=c?.sources?.headers||tr):c?.url?d=c.url:c?.stream?.url?(d=c.stream.url,l=c?.stream?.headers||tr):typeof c=="string"&&c.startsWith("http")&&(d=c),!d)throw new p("No stream URL found in response");let u=d;return!d.includes("proxy.vidnest.fun")&&!d.includes("proxy-2.madaraverse.online")&&(u=`https://proxy-2.madaraverse.online/proxy?url=${encodeURIComponent(d)}`),t.progress(100),{stream:[{id:"primary",type:"hls",playlist:u,headers:l,flags:[],captions:[]}]}}})}var Ps=qc.map((e,r)=>jc(e,260-r));var Fs=P(require("cheerio"),1);async function or(e,r){try{let t="https://ftmoh345xme.com",o={Origin:"https://friness-cherlormur-i-275.site",Referer:"https://google.com/",Dnt:"1"},s=`${t}/play/${r}`,n=await e.proxiedFetcher(s,{headers:{...o},method:"GET"}),i=Fs.load(n)("script").last().html();if(!i)throw new p("Failed to extract script data");let c=i.match(/(\{[^;]+});/)?.[1]||i.match(/\((\{.*\})\)/)?.[1];if(!c)throw new p("Media not found");let d=JSON.parse(c),l=d.file;if(!l)throw new p("File not found");l.startsWith("/")&&(l=t+l);let u=d.key,m={Origin:"https://friness-cherlormur-i-275.site",Referer:"https://google.com/",Dnt:"1","X-Csrf-Token":u};return{success:!0,data:{playlist:await e.proxiedFetcher(l,{headers:{...m},method:"GET"}),key:u}}}catch(t){throw t instanceof p?t:new p("Failed to fetch media info")}}async function sr(e,r,t){let s=`${r.slice(1)}.txt`;try{let n="https://ftmoh345xme.com",a={Origin:"https://friness-cherlormur-i-275.site",Referer:"https://google.com/",Dnt:"1","X-Csrf-Token":t},i=`${n}/playlist/${s}`;return{success:!0,data:{link:await e.proxiedFetcher(i,{headers:{...a},method:"GET"})}}}catch{throw new p("Failed to fetch stream data")}}async function As(e,r,t="English"){try{let o=await or(e,r);if(o?.success){let s=o?.data?.playlist;if(!s||!Array.isArray(s))throw new p("Playlist not found or invalid");let n=s.find(d=>d?.title===t);if(n||(n=s?.[0]),!n)throw new p("No file found");let a=s.map(d=>d?.title),i=o?.data?.key;e.progress(70);let c=await sr(e,n?.file,i);if(c?.success)return{success:!0,data:c?.data,availableLang:a};throw new p("No stream url found")}throw new p("No media info found")}catch(o){throw o instanceof p?o:new p("Failed to fetch movie data")}}async function Ls(e,r,t,o,s){try{let n=await or(e,r);if(!n?.success)throw new p("No media info found");let i=(n?.data?.playlist).find(f=>f?.id===t.toString());if(!i)throw new p("No season found");let c=i?.folder.find(f=>f?.episode===o.toString());if(!c)throw new p("No episode found");let d=c?.folder.find(f=>f?.title===s);if(d||(d=c?.folder?.[0]),!d)throw new p("No file found");let u=(c?.folder.map(f=>f?.title)).filter(f=>f?.length>0),m=n?.data?.key;e.progress(70);let h=await sr(e,d?.file,m);if(h?.success)return{success:!0,data:h?.data,availableLang:u};throw new p("No stream url found")}catch(n){throw n instanceof p?n:new p("Failed to fetch TV data")}}async function Us(e){let r={title:e.media.title,releaseYear:e.media.releaseYear,tmdbId:e.media.tmdbId,imdbId:e.media.imdbId,type:e.media.type,season:"",episode:""};if(e.media.type==="show"&&(r.season=e.media.season.number.toString(),r.episode=e.media.episode.number.toString()),e.media.type==="movie"){e.progress(40);let t=await As(e,e.media.imdbId);if(t?.success)return e.progress(90),{embeds:[],stream:[{id:"primary",captions:[],playlist:t.data.link,type:"hls",flags:[g.CORS_ALLOWED]}]};throw new p("No providers available")}if(e.media.type==="show"){e.progress(40);let o=await Ls(e,e.media.imdbId,e.media.season.number,e.media.episode.number,"English");if(o?.success)return e.progress(90),{embeds:[],stream:[{id:"primary",captions:[],playlist:o.data.link,type:"hls",flags:[g.CORS_ALLOWED]}]};throw new p("No providers available")}throw new p("No providers available")}var Ts=S({id:"8stream",name:"8stream",rank:111,flags:[],disabled:!0,scrapeMovie:Us,scrapeShow:Us});var Fe=require("cheerio");var nr="https://www3.animeflv.net";async function Wc(e,r){let t=`${nr}/browse?q=${encodeURIComponent(r)}`,o=await e.proxiedFetcher(t),s=(0,Fe.load)(o),n=s("div.Container ul.ListAnimes li article");if(!n.length)throw new p("No se encontr\xF3 el anime en AnimeFLV");let a="";if(n.each((c,d)=>{if(s(d).find("a h3").text().trim().toLowerCase()===r.trim().toLowerCase())return a=s(d).find("div.Description a.Button").attr("href")||"",!1}),a||(a=n.first().find("div.Description a.Button").attr("href")||""),!a)throw new p("No se encontr\xF3 el anime en AnimeFLV");return a.startsWith("http")?a:`${nr}${a}`}async function Hc(e,r){let t=await e.proxiedFetcher(r),o=(0,Fe.load)(t),s=[];return o("script").each((n,a)=>{let i=o(a).html()||"";if(i.includes("var anime_info =")){let d=i.split("var anime_info = [")[1]?.split("];")[0]?.split(",")[2]?.replace(/"/g,"").trim(),l=i.split("var episodes = [")[1]?.split("];")[0];d&&l?s=l.split("],[").map(m=>{let h=m.replace("[","").replace("]","").split(",")[0];return{number:parseInt(h,10),url:`${nr}/ver/${d}-${h}`}}):console.log("[AnimeFLV] No se encontr\xF3 animeUri o lista de episodios en el script")}}),s.length===0&&console.log("[AnimeFLV] No se encontraron episodios"),s}async function zc(ctx,episodeUrl){let html=await ctx.proxiedFetcher(episodeUrl),$=(0,Fe.load)(html),script=$('script:contains("var videos =")').html();if(!script)return{};let match=script.match(/var videos = (\{[\s\S]*?\});/);if(!match)return{};let videos={};try{videos=eval(`(${match[1]})`)}catch{return{}}let streamwishJapanese;if(videos.SUB){let e=videos.SUB.find(r=>r.title?.toLowerCase()==="sw");e&&(e.url||e.code)&&(streamwishJapanese=e.url||e.code,streamwishJapanese&&streamwishJapanese.startsWith("/e/")&&(streamwishJapanese=`https://streamwish.to${streamwishJapanese}`))}let streamtapeLatino;if(videos.LAT){let e=videos.LAT.find(r=>r.title?.toLowerCase()==="stape"||r.title?.toLowerCase()==="streamtape");e&&(e.url||e.code)&&(streamtapeLatino=e.url||e.code,streamtapeLatino&&streamtapeLatino.startsWith("/e/")&&(streamtapeLatino=`https://streamtape.com${streamtapeLatino}`))}return{"streamwish-japanese":streamwishJapanese,"streamtape-latino":streamtapeLatino}}async function Ns(e){let r=e.media.title;if(!r)throw new p("Falta el t\xEDtulo");console.log(`[AnimeFLV] Iniciando scraping para: ${r}`);let t=await Wc(e,r),o=t;if(e.media.type==="show"){let a=e.media.episode?.number;if(!a)throw new p("Faltan datos de episodio");let c=(await Hc(e,t)).find(d=>d.number===a);if(!c)throw new p(`No se encontr\xF3 el episodio ${a}`);o=c.url}else if(e.media.type==="movie"){let a=await e.proxiedFetcher(t),i=(0,Fe.load)(a),c=null;if(i("script").each((d,l)=>{let u=i(l).html()||"";u.includes("var anime_info =")&&(c=u.split("var anime_info = [")[1]?.split("];")[0]?.split(",")[2]?.replace(/"/g,"").trim()||null)}),!c)throw new p("No se pudo obtener el animeUri para la pel\xEDcula");o=`${nr}/ver/${c}-1`}let s=await zc(e,o),n=Object.entries(s).filter(([,a])=>typeof a=="string"&&!!a).map(([a,i])=>({embedId:a,url:i}));if(n.length===0)throw new p("No se encontraron streams v\xE1lidos");return{embeds:n}}var _s=S({id:"animeflv",name:"AnimeFLV",rank:90,disabled:!0,flags:[g.CORS_ALLOWED],scrapeShow:Ns,scrapeMovie:Ns});async function Vc(e){let r=e.media.title;try{let t=await e.proxiedFetcher("/api/search",{baseUrl:"https://backend.animetsu.to",headers:{referer:"https://animetsu.cc/",origin:"https://animetsu.cc","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"},query:{q:r,limit:"10"}});console.log("Animetsu Search Response:",JSON.stringify(t,null,2));let o=t?.results||t?.data||[];if(!o||o.length===0)throw new p("No results found in animetsu search");let s=o[0],n=s?.id||s?.animetsu_id;if(!n)throw new p("No animetsu ID found in search results");let a={type:e.media.type,title:e.media.title,animetsuId:n,...e.media.type==="show"&&{season:e.media.season.number,episode:e.media.episode.number},...e.media.type==="movie"&&{episode:1},releaseYear:e.media.releaseYear};return{embeds:[{embedId:"animetsu-pahe",url:JSON.stringify(a)},{embedId:"animetsu-zoro",url:JSON.stringify(a)},{embedId:"animetsu-zaza",url:JSON.stringify(a)},{embedId:"animetsu-meg",url:JSON.stringify(a)},{embedId:"animetsu-bato",url:JSON.stringify(a)}]}}catch(t){throw new p(`Animetsu search failed: ${t instanceof Error?t.message:"Unknown error"}`)}}var Ds=S({id:"animetsu",name:"Animetsu",rank:112,disabled:!0,flags:[],scrapeShow:Vc});var Kc=["shadow","asiacloud","ophim"];async function qs(e){let r=[],t={type:e.media.type,tmdbId:e.media.tmdbId};e.media.type==="show"&&(t.season=e.media.season.number,t.episode=e.media.episode.number);for(let o of Kc)r.push({embedId:`cinemaos-${o}`,url:JSON.stringify({...t,service:o})});return e.progress(50),{embeds:r}}var Bs=S({id:"cinemaos",name:"CinemaOS",rank:149,disabled:!0,flags:[g.CORS_ALLOWED],scrapeMovie:qs,scrapeShow:qs});var js="https://api.coitus.ca";async function Ws(e){let r=e.media.type==="movie"?`${js}/movie/${e.media.tmdbId}`:`${js}/tv/${e.media.tmdbId}/${e.media.season.number}/${e.media.episode.number}`,t=await e.proxiedFetcher(r);if(!t.videoSource)throw new p("No watchable item found");let o=t.videoSource;if(o.includes("orbitproxy"))try{let s=o.split(/orbitproxy\.[^/]+\//);if(s.length>=2){let n=s[1].split(".m3u8")[0];try{let a=Buffer.from(n,"base64").toString("utf-8"),i=JSON.parse(a),c=i.u,l={referer:i.r||""};o=O(c,l)}catch(a){console.error("Error decoding/parsing orbitproxy data:",a)}}}catch(s){console.error("Error processing orbitproxy URL:",s)}return console.log(t),e.progress(90),{embeds:[],stream:[{id:"primary",captions:[],playlist:o,type:"hls",flags:[g.CORS_ALLOWED]}]}}var Hs=S({id:"coitus",name:"Autoembed+",rank:91,disabled:!0,flags:[g.CORS_ALLOWED],scrapeMovie:Ws,scrapeShow:Ws});var Jr=require("cheerio");var ar="https://www.cuevana3.eu";function zs(e){return e.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^a-z0-9\s-]/gi,"").replace(/\s+/g,"-").replace(/-+/g,"-")}async function Jc(e,r){try{let o=(await e.proxiedFetcher(r)).match(/var url = '([^']+)'/);if(o)return o[1]}catch{}return null}function Gc(e){return e.startsWith("https://")&&(e.includes("streamwish")||e.includes("filemoon")||e.includes("vidhide"))}async function ir(e,r){let t=[];for(let[o,s]of Object.entries(r))if(s)for(let n of s){if(!n.result)continue;let a=await Jc(e,n.result);if(!a||!Gc(a))continue;let i="";if(a.includes("filemoon"))i="filemoon";else if(a.includes("streamwish"))o==="latino"?i="streamwish-latino":o==="spanish"?i="streamwish-spanish":o==="english"?i="streamwish-english":i="streamwish-latino";else if(a.includes("vidhide"))i="vidhide";else if(a.includes("voe"))i="voe";else continue;t.push({embedId:i,url:a})}return t}async function Yc(e,r,t){let o=t==="movie"?`https://api.themoviedb.org/3/movie/${e}?api_key=${r}&language=es-ES`:`https://api.themoviedb.org/3/tv/${e}?api_key=${r}&language=es-ES`,s=await fetch(o);if(!s.ok)throw new Error(`Error fetching TMDB data: ${s.statusText}`);let n=await s.json();return t==="movie"?n.title:n.name}async function Xc(){try{let e=await fetch("https://raw.githubusercontent.com/moonpic/fixed-titles/refs/heads/main/main.json");if(!e.ok)throw new Error("Failed to fetch fallback titles");return await e.json()}catch{return{}}}async function Vs(e){let r=e.media.type,t=e.media.tmdbId,o="7604525319adb2db8e7e841cb98e9217";if(!t)throw new p("TMDB ID is required to fetch the title in Spanish");let s=await Yc(Number(t),o,r),n=zs(s),a=r==="movie"?`${ar}/ver-pelicula/${n}`:`${ar}/episodio/${n}-temporada-${e.media.season?.number}-episodio-${e.media.episode?.number}`;e.progress(60);let i=await e.proxiedFetcher(a),c=(0,Jr.load)(i),d=c("script").toArray().find(u=>(u.children[0]?.data||"").includes('{"props":{"pageProps":')),l=[];if(d){let u;try{let m=d.children[0].data,h=m.indexOf('{"props":{"pageProps":');if(h===-1)throw new Error("No valid JSON start found");let f=m.slice(h);u=JSON.parse(f)}catch(m){throw new p(`Failed to parse JSON: ${m.message}`)}if(r==="movie"){let m=u.props.pageProps.thisMovie;m?.videos&&(l=await ir(e,m.videos)??[])}else{let m=u.props.pageProps.episode;m?.videos&&(l=await ir(e,m.videos)??[])}}if(l.length===0){let m=(await Xc())[t.toString()];if(!m)throw new p("No embed data found and no fallback title available");if(n=zs(m),a=r==="movie"?`${ar}/ver-pelicula/${n}`:`${ar}/episodio/${n}-temporada-${e.media.season?.number}-episodio-${e.media.episode?.number}`,i=await e.proxiedFetcher(a),c=(0,Jr.load)(i),d=c("script").toArray().find(h=>(h.children[0]?.data||"").includes('{"props":{"pageProps":')),d){let h;try{let f=d.children[0].data,b=f.indexOf('{"props":{"pageProps":');if(b===-1)throw new Error("No valid JSON start found");let y=f.slice(b);h=JSON.parse(y)}catch(f){throw new p(`Failed to parse JSON: ${f.message}`)}if(r==="movie"){let f=h.props.pageProps.thisMovie;f?.videos&&(l=await ir(e,f.videos)??[])}else{let f=h.props.pageProps.episode;f?.videos&&(l=await ir(e,f.videos)??[])}}}if(l.length===0)throw new p("No valid streams found");return{embeds:l}}var Ks=S({id:"cuevana3",name:"Cuevana3",rank:80,disabled:!0,flags:[g.CORS_ALLOWED],scrapeMovie:Vs,scrapeShow:Vs});async function Gr(e){let r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",t=e.replace(/=+$/,""),o="";if(t.length%4===1)throw new Error("The string to be decoded is not correctly encoded.");for(let s=0,n=0,a=0;a<t.length;a++){let i=t.charAt(a),c=r.indexOf(i);c!==-1&&(n=s%4?n*64+c:c,s++%4&&(o+=String.fromCharCode(255&n>>(-2*s&6))))}return o}async function Js(e){let r=`https://embed.su/embed/${e.media.type==="movie"?`movie/${e.media.tmdbId}`:`tv/${e.media.tmdbId}/${e.media.season.number}/${e.media.episode.number}`}`,s=(await e.proxiedFetcher(r,{headers:{Referer:"https://embed.su/","User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36"}})).match(/window\.vConfig\s*=\s*JSON\.parse\(atob\(`([^`]+)/i)?.[1];if(!s)throw new p("No encoded config found");let n=JSON.parse(await Gr(s));if(!n?.hash)throw new p("No stream hash found");let a=(await Gr(n.hash)).split(".").map(d=>d.split("").reverse().join("")),i=JSON.parse(await Gr(a.join("").split("").reverse().join("")));if(!i?.length)throw new p("No servers found");e.progress(50);let c=i.map(d=>({embedId:"viper",url:`https://embed.su/api/e/${d.hash}`}));return e.progress(90),{embeds:c}}var Gs=S({id:"embedsu",name:"embed.su",rank:165,disabled:!0,flags:[],scrapeMovie:Js,scrapeShow:Js});var en=require("cheerio");function Ys(){let e=()=>Math.floor(Math.random()*16).toString(16),r=t=>Array.from({length:t},e).join("");return`${r(8)}-${r(4)}-${r(4)}-${r(4)}-${r(12)}`}function Xs(e){if(!e||typeof e=="boolean")return[];let r=e.split(","),t=[];return r.forEach(o=>{let s=o.match(/\[([^\]]+)\](https?:\/\/\S+?)(?=,\[|$)/);if(s){let n=pe(s[2]),a=q(s[1]);if(!n||!a)return;t.push({id:s[2],language:a,hasCorsRestrictions:!1,type:n,url:s[2]})}}),t}function Zs(e){if(!e)throw new p("No video links found");try{let r={};e.split(",").forEach(s=>{let n=s.match(/\[([^\]]+)\](https?:\/\/[^\s,]+)/);if(n){let[a,i,c]=n;if(c==="null")return;let d=i.replace(/<[^>]+>/g,"").toLowerCase().replace("p","").trim();r[d]={type:"mp4",url:c.trim()}}});let o={};return Object.entries(r).forEach(([s,n])=>{let a=me(s);o[a]=n}),o}catch(r){throw console.error("Error parsing video links:",r),new p("Failed to parse video links")}}var Yr="https://hdrezka.ag/",Xr={"X-Hdrezka-Android-App":"1","X-Hdrezka-Android-App-Version":"2.2.0","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36","Accept-Language":"ru-RU,ru;q=0.9,en-US;q=0.8,en;q=0.7","CF-IPCountry":"RU"};async function Zc(e){let r=await e.proxiedFetcher("/engine/ajax/search.php",{baseUrl:Yr,headers:Xr,query:{q:e.media.title}}),t=(0,en.load)(r),o=t("a").map((s,n)=>{let a=t(n),i=a.attr("href"),c=a.find("span.enty").text(),d=c.match(/\((\d{4})\)/)||i?.match(/-(\d{4})(?:-|\.html)/)||c.match(/(\d{4})/),l=d?d[1]:null,u=i?.match(/\/(\d+)-[^/]+\.html$/)?.[1];return u?{id:u,year:l?parseInt(l,10):e.media.releaseYear,type:e.media.type,url:i||""}:null}).get().filter(Boolean);return o.sort((s,n)=>{let a=Math.abs(s.year-e.media.releaseYear),i=Math.abs(n.year-e.media.releaseYear);return a-i}),o[0]||null}async function Qc(e,r,t){let o=new URLSearchParams;o.append("id",e),o.append("translator_id",r),t.media.type==="show"&&(o.append("season",t.media.season.number.toString()),o.append("episode",t.media.episode.number.toString())),o.append("favs",Ys()),o.append("action",t.media.type==="show"?"get_stream":"get_movie"),o.append("t",Date.now().toString());let s=await t.proxiedFetcher("/ajax/get_cdn_series/",{baseUrl:Yr,method:"POST",body:o,headers:{...Xr,"Content-Type":"application/x-www-form-urlencoded","X-Requested-With":"XMLHttpRequest",Referer:`${Yr}films/action/${e}-novokain-2025-latest.html`}});try{let n=JSON.parse(s);if(!n.url&&n.success)throw new p("Movie found but no stream available (might be premium or not yet released)");if(!n.url)throw new p("No stream URL found in response");return n}catch(n){throw console.error("Error parsing stream response:",n),new p("Failed to parse stream response")}}async function ed(e,r,t){let o=await t.proxiedFetcher(e,{headers:Xr});if(o.includes('data-translator_id="238"'))return"238";let s=t.media.type==="movie"?"initCDNMoviesEvents":"initCDNSeriesEvents",n=new RegExp(`sof\\.tv\\.${s}\\(${r}, ([^,]+)`,"i"),a=o.match(n);return a?a[1]:null}var Qs=async e=>{let r=await Zc(e);if(!r||!r.id)throw new p("No result found");let t=await ed(r.url,r.id,e);if(!t)throw new p("No translator id found");let{url:o,subtitle:s}=await Qc(r.id,t,e),n=Zs(o),a=Xs(s);return e.progress(90),{embeds:[],stream:[{id:"primary",type:"file",flags:[g.CORS_ALLOWED,g.IP_LOCKED],captions:a,qualities:n}]}},rn=S({id:"hdrezka",name:"HDRezka",rank:100,flags:[g.CORS_ALLOWED,g.IP_LOCKED],scrapeShow:Qs,scrapeMovie:Qs});var tn="https://iosmirror.cc",Ae="https://vercel-sucks.up.railway.app/iosmirror.cc:443",on=async e=>{let r=decodeURIComponent(await e.fetcher("https://iosmirror-hash.pstream.org/"));if(!r)throw new p("No hash found");e.progress(10);let t=await e.proxiedFetcher("/search.php",{baseUrl:Ae,query:{s:e.media.title},headers:{cookie:F({t_hash_t:r,hd:"on"})}});if(t.status!=="y"||!t.searchResult)throw new p(t.error);async function o(l){return e.proxiedFetcher("/post.php",{baseUrl:Ae,query:{id:l},headers:{cookie:F({t_hash_t:r,hd:"on"})}})}e.progress(30);let s,n=t.searchResult.find(async l=>(s=await o(l.id),$e(l.t,e.media.title)&&(Number(s.year)===e.media.releaseYear||s.type===(e.media.type==="movie"?"m":"t"))))?.id;if(!n)throw new p("No watchable item found");if(e.media.type==="show"){s=await o(n);let l=e.media,u=s?.season.find(y=>Number(y.s)===l.season.number)?.id;if(!u)throw new p("Season not available");let m=await e.proxiedFetcher("/episodes.php",{baseUrl:Ae,query:{s:u,series:n},headers:{cookie:F({t_hash_t:r,hd:"on"})}}),h=[...m.episodes],f=2;for(;m.nextPageShow===1;){let y=await e.proxiedFetcher("/episodes.php",{baseUrl:Ae,query:{s:u,series:n,page:f.toString()},headers:{cookie:F({t_hash_t:r,hd:"on"})}});h=[...h,...y.episodes],m.nextPageShow=y.nextPageShow,f++}let b=h.find(y=>y.ep===`E${l.episode.number}`&&y.s===`S${l.season.number}`)?.id;if(!b)throw new p("Episode not available");n=b}let a=await e.proxiedFetcher("/playlist.php?",{baseUrl:Ae,query:{id:n},headers:{cookie:F({t_hash_t:r,hd:"on"})}});e.progress(50);let i=a[0].sources.find(l=>l.label==="Auto")?.file;if(i||(i=a[0].sources.find(l=>l.label==="Full HD")?.file),i||(console.log('"Full HD" or "Auto" file not found, falling back to first source'),i=a[0].sources[0].file),!i)throw new Error("Failed to fetch playlist");let c={referer:tn,cookie:F({hd:"on"})},d=O(`${tn}${i}`,c);return e.progress(90),{embeds:[],stream:[{id:"primary",playlist:d,type:"hls",flags:[g.CORS_ALLOWED],captions:[]}]}},sn=S({id:"iosmirror",name:"NetMirror",rank:182,disabled:!0,flags:[g.CORS_ALLOWED],scrapeMovie:on,scrapeShow:on});var nn="https://iosmirror.cc",Le="https://vercel-sucks.up.railway.app/iosmirror.cc:443/pv",an=async e=>{let r=decodeURIComponent(await e.fetcher("https://iosmirror-hash.pstream.org/"));if(!r)throw new p("No hash found");e.progress(10);let t=await e.proxiedFetcher("/search.php",{baseUrl:Le,query:{s:e.media.title},headers:{cookie:F({t_hash_t:r,hd:"on"})}});if(!t.searchResult)throw new p(t.error);async function o(d){return e.proxiedFetcher("/post.php",{baseUrl:Le,query:{id:d},headers:{cookie:F({t_hash_t:r,hd:"on"})}})}e.progress(30);let s=t.searchResult.find(async d=>{let l=await o(d.id);return $e(d.t,e.media.title)&&(Number(d.y)===e.media.releaseYear||l.type===(e.media.type==="movie"?"m":"t"))})?.id;if(!s)throw new p("No watchable item found");if(e.media.type==="show"){let d=await o(s),l=e.media,u=d?.season.find(y=>Number(y.s)===l.season.number)?.id;if(!u)throw new p("Season not available");let m=await e.proxiedFetcher("/episodes.php",{baseUrl:Le,query:{s:u,series:s},headers:{cookie:F({t_hash_t:r,hd:"on"})}}),h=[...m.episodes],f=2;for(;m.nextPageShow===1;){let y=await e.proxiedFetcher("/episodes.php",{baseUrl:Le,query:{s:u,series:s,page:f.toString()},headers:{cookie:F({t_hash_t:r,hd:"on"})}});h=[...h,...y.episodes],m.nextPageShow=y.nextPageShow,f++}let b=h.find(y=>y.ep===`E${l.episode.number}`&&y.s===`S${l.season.number}`)?.id;if(!b)throw new p("Episode not available");s=b}let n=await e.proxiedFetcher("/playlist.php?",{baseUrl:Le,query:{id:s},headers:{cookie:F({t_hash_t:r,hd:"on"})}});e.progress(50);let a=n[0].sources.find(d=>d.label==="Auto")?.file;if(a||(a=n[0].sources.find(d=>d.label==="Full HD")?.file),a||(console.log('"Full HD" or "Auto" file not found, falling back to first source'),a=n[0].sources[0].file),!a)throw new Error("Failed to fetch playlist");let i={referer:nn,cookie:F({hd:"on"})},c=O(`${nn}${a}`,i);return e.progress(90),{embeds:[],stream:[{id:"primary",playlist:c,type:"hls",flags:[g.CORS_ALLOWED],captions:[]}]}},cn=S({id:"iosmirrorpv",name:"PrimeMirror",rank:183,disabled:!0,flags:[g.CORS_ALLOWED],scrapeMovie:an,scrapeShow:an});async function rd(e,r,t){let o="";return t.type==="show"?o="/v1/episodes/view":t.type==="movie"&&(o="/v1/movies/view"),await e.proxiedFetcher(o,{baseUrl:he,query:{expand:"streams,subtitles",id:r}})}async function dn(e,r,t){let o=await rd(e,r,t),s=o.streams;if(!s||typeof s!="object")return{playlist:null,captions:[]};let n=["auto","1080p","1080","720p","720","480p","480","240p","240","360p","360","144","144p"],a=null;for(let c of n)s[c]&&!a&&(a=s[c]);let i=[];if(o.subtitles&&Array.isArray(o.subtitles)){for(let c of o.subtitles){let d=q(c.language);d&&i.push({id:c.url,type:"vtt",url:`${he}${c.url}`,hasCorsRestrictions:!1,language:d})}i=Kt(i)}return{playlist:a,captions:i}}var he="https://lmscript.xyz";async function ln(e,r){if(r.type==="show")return(await e.proxiedFetcher("/v1/shows",{baseUrl:he,query:{"filters[q]":r.title}})).items.find(n=>U(r,n.title,Number(n.year)));if(r.type==="movie")return(await e.proxiedFetcher("/v1/movies",{baseUrl:he,query:{"filters[q]":r.title}})).items.find(n=>U(r,n.title,Number(n.year)))}async function pn(e,r,t){let o=null;if(r.type==="movie")o=t.id_movie;else if(r.type==="show"){let a=(await e.proxiedFetcher("/v1/shows",{baseUrl:he,query:{expand:"episodes",id:t.id_show}})).episodes?.find(i=>Number(i.season)===Number(r.season.number)&&Number(i.episode)===Number(r.episode.number));a&&(o=a.id)}if(o===null)throw new p("Not found");return await dn(e,o,r)}async function un(e){let r=await ln(e,e.media);if(!r)throw new p("Media not found");e.progress(30);let t=await pn(e,e.media,r);if(!t.playlist)throw new p("No video found");return e.progress(60),{embeds:[],stream:[{id:"primary",playlist:t.playlist,type:"hls",flags:[g.IP_LOCKED],captions:t.captions}]}}var mn=S({id:"lookmovie",name:"LookMovie",disabled:!1,rank:140,flags:[g.IP_LOCKED],scrapeShow:un,scrapeMovie:un});async function fn(e){let r={type:e.media.type,title:e.media.title,tmdbId:e.media.tmdbId,imdbId:e.media.imdbId,...e.media.type==="show"&&{season:e.media.season.number,episode:e.media.episode.number},releaseYear:e.media.releaseYear};return{embeds:[{embedId:"madplay-base",url:JSON.stringify(r)},{embedId:"madplay-nsapi",url:JSON.stringify(r)},{embedId:"madplay-roper",url:JSON.stringify(r)},{embedId:"madplay-vidfast",url:JSON.stringify(r)}]}}var hn=S({id:"madplay",name:"Flicky",rank:155,disabled:!0,flags:[g.CORS_ALLOWED],scrapeMovie:fn,scrapeShow:fn});var gn="https://mama.up.railway.app/api/showbox",yn=()=>{try{return typeof window<"u"?window.localStorage.getItem("febbox_ui_token"):null}catch(e){return console.warn("Unable to access localStorage:",e),null}};async function bn(e){let r=yn(),t=e.media.type==="movie"?`${gn}/movie/${e.media.tmdbId}?token=${r}`:`${gn}/tv/${e.media.tmdbId}?season=${e.media.season.number}&episode=${e.media.episode.number}&token=${r}`,o=await e.proxiedFetcher(t);if(!o)throw new p("No response from API");let s=await o;if(!s.success)throw new p("No streams found");let n=Array.isArray(s.streams)?s.streams:[s.streams];if(n.length===0||!n[0].player_streams)throw new p("No valid streams found");let a=n[0];for(let c of n)if(c.quality.includes("4K")||c.quality.includes("2160p")){a=c;break}let i=a.player_streams.reduce((c,d)=>{let l;if(d.quality==="4K"||d.quality.includes("4K"))l=2160;else{if(d.quality==="ORG"||d.quality.includes("ORG"))return c;l=parseInt(d.quality.replace("P",""),10)}return Number.isNaN(l)||c[l]||(c[l]=d.file),c},{});return{embeds:[],stream:[{id:"primary",captions:[],qualities:{...i[2160]&&{"4k":{type:"mp4",url:i[2160]}},...i[1080]&&{1080:{type:"mp4",url:i[1080]}},...i[720]&&{720:{type:"mp4",url:i[720]}},...i[480]&&{480:{type:"mp4",url:i[480]}},...i[360]&&{360:{type:"mp4",url:i[360]}}},type:"file",flags:[g.CORS_ALLOWED]}]}}var Sn=S({id:"nunflix",name:"NFlix",rank:155,disabled:!yn(),flags:[g.CORS_ALLOWED],scrapeMovie:bn,scrapeShow:bn});var En="api.rgshows.ru",wn={referer:"https://www.rgshows.ru/",origin:"https://www.rgshows.ru",host:En,"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"};async function vn(e){let r=`https://${En}/main`;e.media.type==="movie"?r+=`/movie/${e.media.tmdbId}`:e.media.type==="show"&&(r+=`/tv/${e.media.tmdbId}/${e.media.season.number}/${e.media.episode.number}`);let t=await e.proxiedFetcher(r,{headers:wn});if(!t?.stream?.url)throw new p("No streams found");if(t.stream.url==="https://vidzee.wtf/playlist/69/master.m3u8")throw new p("Found only vidzee porn stream");let o=t.stream.url,s=new URL(o).host,n={...wn,host:s,origin:"https://www.rgshows.ru",referer:"https://www.rgshows.ru/"};return e.progress(100),{embeds:[],stream:[{id:"primary",type:"hls",playlist:o,headers:n,flags:[],captions:[]}]}}var kn=S({id:"rgshows",name:"RGShows",rank:173,flags:[],scrapeMovie:vn,scrapeShow:vn});var On=require("cheerio");var Rn="https://ridomovies.tv",Cn=`${Rn}/core/api`,xn=async e=>{let o=(await e.proxiedFetcher("/search",{baseUrl:Cn,query:{q:e.media.title}})).data.items.map(d=>{let l=d.title,u=d.contentable.releaseYear,m=d.fullSlug;return{name:l,year:u,fullSlug:m}}).find(d=>d.name===e.media.title&&d.year===e.media.releaseYear.toString());if(!o?.fullSlug)throw new p("No watchable item found");e.progress(40);let s=`/${o.fullSlug}/videos`;if(e.media.type==="show"){let d=await e.proxiedFetcher(`/${o.fullSlug}`,{baseUrl:Rn}),l=`season-${e.media.season.number}/episode-${e.media.episode.number}`,u=new RegExp(`\\\\"id\\\\":\\\\"(\\d+)\\\\"(?=.*?\\\\\\"fullSlug\\\\\\":\\\\\\"[^"]*${l}[^"]*\\\\\\")`,"g"),h=[...d.matchAll(u)].map(b=>b[1]);if(h.length===0)throw new p("No watchable item found");s=`/episodes/${h.at(-1)}/videos`}let n=await e.proxiedFetcher(s,{baseUrl:Cn}),i=(0,On.load)(n.data[0].url)("iframe").attr("data-src");if(!i)throw new p("No watchable item found");e.progress(60);let c=[];return i.includes("closeload")&&c.push({embedId:Ge.id,url:i}),i.includes("ridoo")&&c.push({embedId:Xe.id,url:i}),e.progress(90),{embeds:c}},Mn=S({id:"ridomovies",name:"RidoMovies",rank:210,flags:[g.CF_BLOCKED],disabled:!0,scrapeMovie:xn,scrapeShow:xn});var Pn=require("cheerio");var In="https://pupp.slidemovies-dev.workers.dev";async function $n(e){let r=e.media.type==="movie"?`${In}/movie/${e.media.tmdbId}`:`${In}/tv/${e.media.tmdbId}/${e.media.season.number}/-${e.media.episode.number}`,t=await e.proxiedFetcher(r),o=(0,Pn.load)(t);e.progress(50);let s=o("media-player").attr("src");if(!s)throw new p("Stream URL not found");let a=new URL(s).searchParams.get("url")||"",i=decodeURIComponent(a),c=o("media-provider track").map((d,l)=>{let u=o(l).attr("src")||"",m=o(l).attr("lang")||"unknown",h=q(m)||m;return{type:u.endsWith(".vtt")?"vtt":"srt",id:u,url:u,language:h,hasCorsRestrictions:!1}}).get();return e.progress(90),{embeds:[],stream:[{id:"primary",type:"hls",flags:[],playlist:i,captions:c}]}}var Fn=S({id:"slidemovies",name:"SlideMovies",rank:135,disabled:!0,flags:[g.CORS_ALLOWED],scrapeMovie:$n,scrapeShow:$n});var cr=require("cheerio");var ge=require("hls-parser");async function Zr(e,r,t){let o=await e(r,{headers:t}),s=(0,ge.parse)(o);if(s.isMasterPlaylist){let n=new URL(r).origin;await Promise.all(s.variants.map(async a=>{let i=a.uri;i.startsWith("http")||(i.startsWith("/")||(i=`/${i}`),i=n+i);let c=await e(i,{headers:t}),d=(0,ge.parse)(c);a.uri=`data:application/vnd.apple.mpegurl;base64,${btoa((0,ge.stringify)(d))}`}))}return`data:application/vnd.apple.mpegurl;base64,${btoa((0,ge.stringify)(s))}`}var z="https://soaper.cc",An=async e=>{let r=await e.proxiedFetcher("/search.html",{baseUrl:z,query:{keyword:e.media.title}}),t=(0,cr.load)(r),o=[];t(".thumbnail").each((f,b)=>{let y=t(b).find("h5").find("a").first().text().trim(),C=t(b).find(".img-tip").first().text().trim(),x=t(b).find("h5").find("a").first().attr("href");!y||!x||o.push({title:y,year:C?parseInt(C,10):void 0,url:x})});let s=o.find(f=>f&&U(e.media,f.title,f.year))?.url;if(!s)throw new p("Content not found");if(e.media.type==="show"){let f=e.media.season.number,b=e.media.episode.number,y=await e.proxiedFetcher(s,{baseUrl:z}),C=(0,cr.load)(y),E=C("h4").filter((L,_)=>C(_).text().trim().split(":")[0].trim()===`Season${f}`).parent().find("a").toArray();s=C(E.find(L=>parseInt(C(L).text().split(".")[0],10)===b)).attr("href")}if(!s)throw new p("Content not found");let n=await e.proxiedFetcher(s,{baseUrl:z}),i=(0,cr.load)(n)("#hId").attr("value");if(!i)throw new p("Content not found");e.progress(50);let c=new URLSearchParams;c.append("pass",i),c.append("e2","0"),c.append("server","0");let d=e.media.type==="show"?"/home/index/getEInfoAjax":"/home/index/getMInfoAjax",l=await e.proxiedFetcher(d,{baseUrl:z,method:"POST",body:c,headers:{referer:`${z}${s}`,"User-Agent":"Mozilla/5.0 (iPhone; CPU iPhone OS 18_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.0 Mobile/15E148 Safari/604.1","Viewport-Width":"375"}}),u=JSON.parse(l),m=[];if(Array.isArray(u.subs))for(let f of u.subs){let b="";if(f.name.includes(".srt")){let y=f.name.split(".srt")[0].trim();b=q(y)}else if(f.name.includes(":")){let y=f.name.split(":")[0].trim();b=q(y)}else{let y=f.name.trim();b=q(y)}b&&m.push({id:f.path,url:`${z}${f.path}`,type:"srt",hasCorsRestrictions:!1,language:b})}e.progress(90);let h={referer:`${z}${s}`,"User-Agent":"Mozilla/5.0 (iPhone; CPU iPhone OS 18_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.0 Mobile/15E148 Safari/604.1","Viewport-Width":"375",Origin:z};return{embeds:[],stream:[{id:"primary",playlist:await Zr(e.proxiedFetcher,`${z}/${u.val}`,h),type:"hls",proxyDepth:2,flags:[g.CORS_ALLOWED],captions:m},...u.val_bak?[{id:"backup",playlist:await Zr(e.proxiedFetcher,`${z}/${u.val_bak}`,h),type:"hls",flags:[g.CORS_ALLOWED],proxyDepth:2,captions:m}]:[]]}},Ln=S({id:"soapertv",name:"SoaperTV",rank:130,disabled:!0,flags:[g.CORS_ALLOWED],scrapeMovie:An,scrapeShow:An});var Un="https://vidjoy.pro/embed/api/fastfetch";async function Tn(e){let r=await e.proxiedFetcher(e.media.type==="movie"?`${Un}/${e.media.tmdbId}?sr=0`:`${Un}/${e.media.tmdbId}/${e.media.season.number}/${e.media.episode.number}?sr=0`);if(!r)throw new p("Failed to fetch StreamBox data");console.log(r);let t=await r,o={};t.url.forEach(a=>{o[a.resulation]=a.link});let s=t.tracks.map(a=>({id:a.lang,url:a.url,language:a.code,type:"srt"}));if(t.provider==="MovieBox")return{embeds:[],stream:[{id:"primary",captions:s,qualities:{...o[1080]&&{1080:{type:"mp4",url:o[1080]}},...o[720]&&{720:{type:"mp4",url:o[720]}},...o[480]&&{480:{type:"mp4",url:o[480]}},...o[360]&&{360:{type:"mp4",url:o[360]}}},type:"file",flags:[g.CORS_ALLOWED],preferredHeaders:{Referer:t.headers?.Referer}}]};let n=t.url.find(a=>a.type==="hls")||t.url[0];return{embeds:[],stream:[{id:"primary",captions:s,playlist:n.link,type:"hls",flags:[g.CORS_ALLOWED],preferredHeaders:{Referer:t.headers?.Referer}}]}}var Nn=S({id:"streambox",name:"StreamBox",rank:119,disabled:!0,flags:[g.CORS_ALLOWED],scrapeMovie:Tn,scrapeShow:Tn});var _n="https://vidapi.click";async function Dn(e){let r=e.media.type==="show"?`${_n}/api/video/tv/${e.media.tmdbId}/${e.media.season.number}/${e.media.episode.number}`:`${_n}/api/video/movie/${e.media.tmdbId}`,t=await e.proxiedFetcher(r,{headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"}});if(!t)throw new p("Failed to fetch video source");if(!t.sources[0].file)throw new p("No video source found");return e.progress(50),e.progress(90),{embeds:[],stream:[{id:"primary",type:"hls",playlist:t.sources[0].file,flags:[g.CORS_ALLOWED],captions:[]}]}}var qn=S({id:"vidapi-click",name:"vidapi.click",rank:89,disabled:!0,flags:[g.CORS_ALLOWED],scrapeMovie:Dn,scrapeShow:Dn});async function Bn(e){let r={type:e.media.type,title:e.media.title,tmdbId:e.media.tmdbId,imdbId:e.media.imdbId,...e.media.type==="show"&&{season:e.media.season.number,episode:e.media.episode.number},releaseYear:e.media.releaseYear};return{embeds:[{embedId:"vidify-alfa",url:JSON.stringify(r)},{embedId:"vidify-bravo",url:JSON.stringify(r)},{embedId:"vidify-charlie",url:JSON.stringify(r)},{embedId:"vidify-delta",url:JSON.stringify(r)},{embedId:"vidify-echo",url:JSON.stringify(r)},{embedId:"vidify-foxtrot",url:JSON.stringify(r)},{embedId:"vidify-golf",url:JSON.stringify(r)},{embedId:"vidify-hotel",url:JSON.stringify(r)},{embedId:"vidify-india",url:JSON.stringify(r)},{embedId:"vidify-juliett",url:JSON.stringify(r)}]}}var jn=S({id:"vidify",name:"Vidify",rank:124,disabled:!0,flags:[],scrapeMovie:Bn,scrapeShow:Bn});var Wn="https://backend.vidnest.fun",td=["hollymoviehd","allmovies","flixhq","official"];async function Hn(e,r){let t=[];for(let o of td){let s="";r==="movie"?s=`${Wn}/${o}/movie/${e.media.tmdbId}`:e.media.type==="show"&&(s=`${Wn}/${o}/tv/${e.media.tmdbId}/${e.media.season.number}/${e.media.episode.number}`),t.push({embedId:`vidnest-${o}`,url:s})}return{embeds:t}}var od=S({id:"vidnest",name:"Vidnest",rank:130,flags:[g.CORS_ALLOWED],scrapeMovie:e=>Hn(e,"movie"),scrapeShow:e=>Hn(e,"tv")}),zn=od;async function sd(e,r,t){let o=[];for(let s of r.split(",")){await t.proxiedFetcher("/getEmbed.php",{baseUrl:ce,headers:{Referer:`${ce}/getEmbed.php?${new URLSearchParams({id:e,sv:s})}`},method:"HEAD",query:{id:e,sv:s}});let a=(await t.proxiedFetcher("/getPlay.php",{baseUrl:ce,headers:{Referer:`${ce}/getEmbed.php?${new URLSearchParams({id:e,sv:s})}`},query:{id:e,sv:s}})).match(/window.location.href\s*=\s*"([^"]+)"/)?.[1];a&&s==="warezcdn"?o.push({embedId:er.id,url:a},{embedId:de.id,url:a},{embedId:rr.id,url:a}):a&&s==="mixdrop"&&o.push({embedId:He.id,url:a})}return{embeds:o}}var Vn=S({id:"warezcdn",name:"WarezCDN",disabled:!0,rank:115,flags:[],scrapeMovie:async e=>{if(!e.media.imdbId)throw new p("This source requires IMDB id.");let r=await e.proxiedFetcher(`/filme/${e.media.imdbId}`,{baseUrl:ce}),[,t,o]=r.match(/let\s+data\s*=\s*'\[\s*\{\s*"id":"([^"]+)".*?"servers":"([^"]+)"/);if(!t||!o)throw new p("Failed to find episode id");return e.progress(40),sd(t,o,e)}});var Q=require("cheerio");var be="https://mycima.pics/",Kn=S({id:"wecima",name:"Wecima (Arabic)",rank:55,disabled:!0,flags:[g.IP_LOCKED],scrapeMovie:async e=>{let r=await e.proxiedFetcher(`/search/${encodeURIComponent(e.media.title)}/`,{baseUrl:be}),t=(0,Q.load)(r),o=t(".Grid--WecimaPosts .GridItem a"),s;for(let l of o){let u=t(l).find(".title").text().trim(),m=t(l).find(".year").text().trim();if(U(e.media,u,m?parseInt(m,10):void 0)){s=t(l).attr("href");break}}if(!s)throw new p("Movie not found");e.progress(40);let n=await e.proxiedFetcher(s,{baseUrl:be}),a=(0,Q.load)(n),i=[],c=a(".servers-list a, .server-item a, button[data-server]");for(let l of c){let u=a(l).attr("href")||a(l).attr("data-url")||a(l).attr("data-server");u&&(u.includes("fdewsdc.sbs")||u.includes("/embed/"))&&i.push({embedId:"wecima-embed",url:u.startsWith("http")?u:`https:${u}`})}let d=a('iframe[src*="/embed/"], iframe[src*="fdewsdc"], iframe[src*="player"]');for(let l of d){let u=a(l).attr("src");u&&i.push({embedId:"wecima-embed",url:u.startsWith("http")?u:`https:${u}`})}return e.progress(90),{embeds:i}},scrapeShow:async e=>{let r=await e.proxiedFetcher(`/search/${encodeURIComponent(e.media.title)}/`,{baseUrl:be}),t=(0,Q.load)(r),o=t(".Grid--WecimaPosts .GridItem a"),s;for(let x of o){let E=t(x).find(".title").text().trim(),L=t(x).find(".year").text().trim();if(U(e.media,E,L?parseInt(L,10):void 0)){s=t(x).attr("href");break}}if(!s)throw new p("Show not found");e.progress(30);let n=await e.proxiedFetcher(s,{baseUrl:be}),a=(0,Q.load)(n),i=a(".List--Seasons--Episodes a, .season-link"),c;for(let x of i){let E=a(x).text().trim();if(E.includes(`\u0645\u0648\u0633\u0645 ${e.media.season.number}`)||E.includes(`Season ${e.media.season.number}`)){c=a(x).attr("href");break}}if(!c)throw new p(`Season ${e.media.season.number} not found`);e.progress(50);let d=await e.proxiedFetcher(c,{baseUrl:be}),l=(0,Q.load)(d),u=l(".Episodes--Seasons--Episodes a, .episode-link"),m;for(let x of u){let E=l(x).text().trim();if(E.includes(`\u0627\u0644\u062D\u0644\u0642\u0629 ${e.media.episode.number}`)||E.includes(`Episode ${e.media.episode.number}`)){m=l(x).attr("href");break}}if(!m)throw new p(`Episode ${e.media.episode.number} not found`);e.progress(70);let h=await e.proxiedFetcher(m,{baseUrl:be}),f=(0,Q.load)(h),b=[],y=f(".servers-list a, .server-item a, button[data-server]");for(let x of y){let E=f(x).attr("href")||f(x).attr("data-url")||f(x).attr("data-server");E&&(E.includes("fdewsdc.sbs")||E.includes("/embed/"))&&b.push({embedId:"wecima-embed",url:E.startsWith("http")?E:`https:${E}`})}let C=f('iframe[src*="/embed/"], iframe[src*="fdewsdc"], iframe[src*="player"]');for(let x of C){let E=f(x).attr("src");E&&b.push({embedId:"wecima-embed",url:E.startsWith("http")?E:`https:${E}`})}return e.progress(90),{embeds:b}}});var Jn=new Map;function Gn(e){return e.toLowerCase().replace(/[^a-z0-9]+/g," ").trim()}function nd(e,r){return e==="show"?["TV","TV_SHORT","OVA","ONA","SPECIAL"].includes(r.format):r.format==="MOVIE"}var ad=`
query ($search: String, $type: MediaType) {
  Page(page: 1, perPage: 20) {
    media(search: $search, type: $type, sort: POPULARITY_DESC) {
      id
      type
      format
      seasonYear
      title {
        romaji
        english
        native
      }
    }
  }
}
`;async function Yn(e,r){let t=`${r.type}:${r.title}:${r.releaseYear}`,o=Jn.get(t);if(o)return o;let n=(await e.proxiedFetcher("",{baseUrl:"https://graphql.anilist.co",method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({query:ad,variables:{search:r.title,type:"ANIME"}})})).data?.Page?.media??[];if(!n.length)throw new Error("AniList id not found");let a=Gn(r.title),d=(n.filter(l=>nd(r.type,l)).map(l=>{let u=[l.title.romaji];l.title.english&&u.push(l.title.english),l.title.native&&u.push(l.title.native);let m=u.map(Gn).filter(Boolean),h=m.includes(a),f=m.some(C=>C.includes(a)||a.includes(C)),b=l.seasonYear?Math.abs(l.seasonYear-r.releaseYear):5,y=0;return h?y+=100:f&&(y+=50),y+=Math.max(0,20-b*4),{it:l,score:y}}).sort((l,u)=>u.score-l.score)[0]?.it??n[0])?.id;if(!d)throw new Error("AniList id not found");return Jn.set(t,d),d}async function Xn(e){let r=[];if(e.media.type==="movie"){let t=`https://vidnest.fun/movie/${e.media.tmdbId}`;r=[{embedId:"zunime-hd-2",url:t},{embedId:"zunime-miko",url:t},{embedId:"zunime-shiro",url:t},{embedId:"zunime-zaza",url:t}]}else if(e.media.type==="show")try{let o=`https://vidnest.fun/anime/${await Yn(e,e.media)}/${e.media.episode.number}/dub`;r=[{embedId:"zunime-hd-2",url:o},{embedId:"zunime-miko",url:o},{embedId:"zunime-shiro",url:o},{embedId:"zunime-zaza",url:o}]}catch{let t=`https://vidnest.fun/tv/${e.media.tmdbId}/${e.media.season.number}/${e.media.episode.number}`;r=[{embedId:"zunime-hd-2",url:t},{embedId:"zunime-miko",url:t},{embedId:"zunime-shiro",url:t},{embedId:"zunime-zaza",url:t}]}return{embeds:r}}var Zn=S({id:"zunime",name:"Zunime",rank:125,disabled:!0,flags:[],scrapeMovie:Xn,scrapeShow:Xn});function Qr(){return[Ks,Mn,rn,Vn,lo,Ln,Yt,Eo,no,io,$o,To,fo,Gs,Fn,sn,cn,qn,Hs,Nn,Sn,Ts,Kn,_s,Bs,bo,wo,Fo,hn,kn,jn,Zn,zn,Ds,mn]}function Qn(){return[ze,is,He,Xe,Ge,jt,ts,Qo,er,de,rr,Do,qo,Bo,jo,Wo,zt,Xo,Zo,hs,gs,bs,ys,Ss,ws,vs,Es,ks,Cs,xs,Os,Rs,Ms,as,os,ss,ns,es,...Ho,Ko,Jo,Go,Yo,...ls,...Ps,..._o,ps,us,ms,fs,$s]}function ye(){return Qr().filter(e=>!e.disabled&&!e.externalSource)}function ee(){return Qr().filter(e=>e.externalSource&&!e.disabled)}function Se(){return Qn().filter(e=>!e.disabled)}function et(e,r){let t=new Map;for(let o of e){let s=r(o);t.has(s)||t.set(s,[]),t.get(s).push(o)}return Array.from(t.entries()).filter(([o,s])=>s.length>1).map(([o,s])=>({key:o,items:s}))}function rt(e,r,t){let o=r.map(({key:s,items:n})=>{let a=n.map(i=>i.name||i.id).join(", ");return`  ${t} ${s}: ${a}`}).join(`
`);return`${e} have duplicate ${t}s:
${o}`}function tt(e,r){let t=r.sources.filter(c=>!c?.disabled),o=r.embeds.filter(c=>!c?.disabled),s=[...t,...o],n=et(s,c=>c.id);if(n.length>0)throw new Error(rt("Sources/embeds",n,"ID"));let a=et(t,c=>c.rank);if(a.length>0)throw new Error(rt("Sources",a,"rank"));let i=et(o,c=>c.rank);if(i.length>0)throw new Error(rt("Embeds",i,"rank"));return{sources:t.filter(c=>G(e,c.flags)),embeds:o}}function ot(e){let r=Dr(e.proxyStreams?"any":e.target,e.consistentIpForRequests??!1,e.proxyStreams),t=[...ye()];e.externalSources==="all"?t.push(...ee()):e.externalSources?.forEach(s=>{let n=ee().find(a=>a.id===s);n&&t.push(n)});let o=tt(r,{embeds:Se(),sources:t});return jr({embeds:o.embeds,sources:o.sources,features:r,fetcher:e.fetcher,proxiedFetcher:e.proxiedFetcher,proxyStreams:e.proxyStreams})}var ra=P(require("form-data"),1);var ea=()=>{try{return require("react-native"),!0}catch{return!1}};function ta(e){return e===void 0||typeof e=="string"||e instanceof URLSearchParams||e instanceof ra.default?e instanceof URLSearchParams&&ea()?{headers:{"Content-Type":"application/x-www-form-urlencoded"},body:e.toString()}:{headers:{},body:e}:{headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}}function id(e,r){let t=new Headers;return e.forEach(o=>{let s=o.toLowerCase(),n=r.headers.get(s),i=r.extraHeaders?.get(s)??n;i&&t.set(s,i)}),t}function Ue(e){return async(t,o)=>{let s=Tr(t,o),n=ta(o.body),a=new AbortController,i=15e3,c=setTimeout(()=>a.abort(),i);try{let d=await e(s,{method:o.method,headers:{...n.headers,...o.headers},body:n.body,credentials:o.credentials,signal:a.signal});clearTimeout(c);let l;return d.headers.get("content-type")?.includes("application/json")?l=await d.json():l=await d.text(),{body:l,finalUrl:d.extraUrl??d.url,headers:id(o.readHeaders,d),statusCode:d.status}}catch(d){throw d.name==="AbortError"?new Error(`Fetch request to ${s} timed out after ${i}ms`):d}}}dr();var st=class{constructor(){this.maxSegmentsPerMinute=50;this.maxBurstSegments=10;this.burstWindowMs=5e3}async checkRateLimit(r,t){let o=`ratelimit:${r}:${t}`,s=await we(o),n=Date.now();if(!s)return await this.recordRequest(o,n),{allowed:!0};let a=n-s.firstRequest;if(a<this.burstWindowMs&&s.count>=this.maxBurstSegments)return console.log(`[RATE LIMIT] Burst limit exceeded for ${t} - ${s.count} requests in ${a}ms`),{allowed:!1,reason:"Too many requests. Please wait a moment."};let i=n-6e4;if(s.firstRequest>i){if(s.count>=this.maxSegmentsPerMinute)return console.log(`[RATE LIMIT] Sustained limit exceeded for ${t} - ${s.count} requests/min`),{allowed:!1,reason:"Rate limit exceeded. Are you trying to download this video?"}}else return await this.recordRequest(o,n,void 0,!0),{allowed:!0};return await this.recordRequest(o,n,s,!1),{allowed:!0}}async recordRequest(r,t,o,s=!1){let n=s||!o?{count:1,firstRequest:t,lastRequest:t}:{count:o.count+1,firstRequest:o.firstRequest,lastRequest:t};await ve(r,n)}detectDownloadTool(r){let t=["ffmpeg","youtube-dl","yt-dlp","curl","wget","aria2","IDM","streamlink","vlc","python-requests","Lavf"],o=r.toLowerCase();return t.some(s=>o.includes(s.toLowerCase()))}},nt=new st;dr();var lr={};function Te(e,r,t){lr[e]||(lr[e]={status:"operational",responseTime:0,uptime:100,totalRequests:0,successfulRequests:0,failedRequests:0,lastChecked:Date.now()});let o=lr[e];o.totalRequests++,o.lastChecked=Date.now(),r?(o.successfulRequests++,o.responseTime=Math.round((o.responseTime*(o.successfulRequests-1)+t)/o.successfulRequests)):o.failedRequests++,o.uptime=Math.round(o.successfulRequests/o.totalRequests*100),o.uptime>=80?o.status="operational":o.uptime>=50?o.status="degraded":o.status="offline"}function pa(){let e={};for(let[r,t]of Object.entries(lr))e[r]={status:t.status,responseTime:t.responseTime,uptime:t.uptime};return e}it();async function fa(e,r){let t=process.env.CLOUDFLARE_TURNSTILE_SECRET_KEY;if(!t)return!0;try{let o=new URLSearchParams;return o.append("secret",t),o.append("response",e),r&&o.append("remoteip",r),!!(await(await fetch("https://challenges.cloudflare.com/turnstile/v0/siteverify",{method:"POST",body:o,headers:{"Content-Type":"application/x-www-form-urlencoded"}})).json()).success}catch{return!1}}function ha(e,r,t){if(process.env.CLOUDFLARE_TURNSTILE_ENABLED!=="true")return t();let o=e.get("referer")||e.get("origin")||"";if((process.env.ALLOWED_DOMAINS?.split(",").map(a=>a.trim())||[]).some(a=>o.includes(a))){let a=e.get("cf-turnstile-token")||e.query.turnstileToken;if(!a)return t();fa(a,e.ip).then(i=>i?t():r.status(403).json({error:"Invalid challenge response"})).catch(()=>r.status(500).json({error:"Challenge verification failed"}))}else{let a=e.get("cf-turnstile-token")||e.query.turnstileToken;if(!a)return r.status(403).json({error:"Challenge required",message:"Please complete the security challenge"});fa(a,e.ip).then(i=>i?t():r.status(403).json({error:"Invalid challenge response"})).catch(()=>r.status(500).json({error:"Challenge verification failed"}))}}var nl=P(pi(),1);function ui(){let e=process.env.MOVIE_WEB_TMDB_API_KEY??"";if(e=e.trim(),!e)throw new Error("Missing MOVIE_WEB_TMDB_API_KEY environment variable");let r=process.env.MOVIE_WEB_PROXY_URL;return r=r||void 0,{tmdbApiKey:e,proxyUrl:r}}async function Ir(e,r){let t={accept:"application/json"},o=new URL(e),s=ui().tmdbApiKey;return s.startsWith("ey")?t.authorization=`Bearer ${s}`:o.searchParams.append("api_key",s),r&&o.searchParams.append("append_to_response",r),fetch(o,{method:"GET",headers:t})}async function mi(e){let t=await(await Ir(`https://api.themoviedb.org/3/movie/${e}`,"external_ids")).json();if(t.success===!1)throw new Error(t.status_message);if(!t.release_date)throw new Error(`${t.title} has no release_date. Assuming unreleased`);return{type:"movie",title:t.title,releaseYear:Number(t.release_date.split("-")[0]),tmdbId:e,imdbId:t.imdb_id}}async function fi(e,r,t){let o=await Ir(`https://api.themoviedb.org/3/tv/${e}`,"external_ids"),s=await o.json();if(s.success===!1)throw new Error(s.status_message);if(!s.first_air_date)throw new Error(`${s.name} has no first_air_date. Assuming unaired`);o=await Ir(`https://api.themoviedb.org/3/tv/${e}/season/${r}`);let n=await o.json();if(n.success===!1)throw new Error(n.status_message);o=await Ir(`https://api.themoviedb.org/3/tv/${e}/season/${r}/episode/${t}`);let a=await o.json();if(a.success===!1)throw new Error(a.status_message);return{type:"show",title:s.name,releaseYear:Number(s.first_air_date.split("-")[0]),tmdbId:e,episode:{number:a.episode_number,tmdbId:a.id},season:{number:n.season_number,tmdbId:n.id},imdbId:s.external_ids.imdb_id}}async function al(e,r,t){throw new Error("Browser scraping is no longer supported.")}async function hi(e,r,t){if(t.fetcher==="browser")return al(e,r,t);let o=ot(e);if(r.type==="embed")return o.runEmbedScraper({disableOpensubtitles:!0,url:t.url,id:r.id});if(r.type==="source"){let s;return t.type==="movie"?s=await mi(t.tmdbId):s=await fi(t.tmdbId,t.season,t.episode),o.runSourceScraper({disableOpensubtitles:!0,media:s,id:r.id})}throw new Error("Invalid source type")}var gi=P(require("node-fetch"),1);async function bi(e,r){let t=["node-fetch","native","browser"];if(!t.includes(r.fetcher))throw new Error(`Fetcher must be any of: ${t.join()}`);if(!r.sourceId.trim())throw new Error("Source ID must be provided");let o=e.find(({id:a})=>a===r.sourceId);if(!o)throw new Error("Invalid source ID. No source found");if(o.type==="embed"&&!r.url.trim())throw new Error("Must provide an embed URL for embed sources");if(o.type==="source"){if(!r.tmdbId.trim())throw new Error("Must provide a TMDB ID for provider sources");if(Number.isNaN(Number(r.tmdbId))||Number(r.tmdbId)<0)throw new Error("TMDB ID must be a number greater than 0");if(!r.type.trim())throw new Error("Must provide a type for provider sources");if(r.type!=="movie"&&r.type!=="show")throw new Error("Invalid media type. Must be either 'movie' or 'show'");if(r.type==="show"){if(!r.season.trim())throw new Error("Must provide a season number for TV shows");if(!r.episode.trim())throw new Error("Must provide an episode number for TV shows");if(Number.isNaN(Number(r.season))||Number(r.season)<=0)throw new Error("Season number must be a number greater than 0");if(Number.isNaN(Number(r.episode))||Number(r.episode)<=0)throw new Error("Episode number must be a number greater than 0")}}let s;return r.fetcher==="native"?s=Ue(fetch):s=Ue(gi.default),{providerOptions:{fetcher:s,target:_r.ANY,consistentIpForRequests:!0,externalSources:"all"},options:r,source:o}}Ci.default.config();var B=(0,xt.default)(),wi=process.env.PORT||3e3,vi=process.env.API_KEY;B.set("trust proxy",1);B.use((0,ki.default)());B.use(xt.default.json());var cl=(0,Ot.default)({windowMs:900*1e3,max:100,message:"Too many requests from this IP, please try again later.",standardHeaders:!0,legacyHeaders:!1,skip:e=>e.ip==="127.0.0.1"||e.ip==="::1"}),dl=(0,Ot.default)({windowMs:300*1e3,max:20,message:"Too many scraping requests, please slow down.",standardHeaders:!0,legacyHeaders:!1,skip:e=>e.ip==="127.0.0.1"||e.ip==="::1"}),ll=(0,xi.default)({windowMs:900*1e3,delayAfter:50,delayMs:()=>500,maxDelayMs:5e3,skip:e=>e.ip==="127.0.0.1"||e.ip==="::1"});B.use(cl);B.use(ll);var pl=(e,r,t)=>{if(process.env.CLOUDFLARE_MODE==="true"){let o=e.get("cf-ray"),s=e.get("cf-connecting-ip");if(!o&&!s&&(console.log("[SECURITY] Request without Cloudflare headers from:",e.ip),process.env.CLOUDFLARE_STRICT==="true"))return r.status(403).json({error:"Access denied"})}t()};B.use(pl);var Oi=process.env.ALLOWED_DOMAINS?process.env.ALLOWED_DOMAINS.split(",").map(e=>e.trim()):["localhost:3000","localhost:3001"];console.log("Allowed domains for stream access:",Oi);function Ri(e,r,t){let o=e.get("referer")||e.get("origin")||"",s=e.get("host")||"";return o?o.includes(s)||Oi.some(a=>o.includes(a)||o.includes(`://${a}`))?t():(console.log(`[BLOCKED] Unauthorized domain access from: ${o}`),r.status(403).send("Access denied: Domain not authorized")):(console.log(`[BLOCKED] Direct URL access attempt (No Referer) from IP: ${e.ip}`),r.status(403).send("Access denied: Direct access not allowed"))}B.get("/test",(e,r)=>{r.sendFile("test-api.html",{root:process.cwd()})});var ul=[...ye(),...ee()].sort((e,r)=>r.rank-e.rank),ml=Se().sort((e,r)=>r.rank-e.rank),Rt=[...ul,...ml],Mi=(e,r,t)=>{let o=e.headers["x-api-key"]||e.query.apiKey;return vi?o===vi?t():r.status(401).json({error:"Unauthorized: Invalid API Key"}):(console.warn("API_KEY not set in environment variables. allowing all requests (NOT RECOMMENDED)"),t())};B.get("/sources",Mi,(e,r)=>{let t=Rt.map(o=>({id:o.id,name:o.name,rank:o.rank,type:o.type,mediaTypes:o.mediaTypes||[]}));r.json(t)});B.get("/status",(e,r)=>{let t=pa(),o={},s=Rt.filter(n=>n.type==="source");for(let n of s)t[n.id]?o[n.id]=t[n.id]:o[n.id]={status:"untested",responseTime:0,uptime:0};r.json(o)});B.get("/cdn",Mi,dl,ha,async(e,r)=>{let t=Date.now();try{let{sourceId:o,tmdbId:s,type:n,season:a,episode:i,url:c,force:d}=e.query;if(!o)return r.status(400).json({error:"Missing sourceId"});let l=String(o),u=String(s||""),m=String(n||"movie"),h=String(a||"0"),f=String(i||"0"),b=String(c||""),y=la(l,u,m,h,f);if(d!=="true"){let D=await we(y);if(D){console.log(`[Cache Hit] ${y}`);let j=Date.now()-t;Te(l,!0,j);let K={...D,stream:await Promise.all((D.stream||[]).map(async J=>{let Fr=await pr(J.playlist,J.headers||{},e.ip,e.get("user-agent"));return{...J,playlist:`${e.protocol}://${e.get("host")}/s/${Fr}`,headers:{}}}))};return r.json(K)}}console.log(`[Scraping] ${l} - ${m} ${u}`);let C={fetcher:"native",sourceId:l,tmdbId:u,type:m,season:h,episode:f,url:b},{providerOptions:x,source:E,options:L}=await bi(Rt,C),_=await hi(x,E,L);if(_){let{getMediaMetadata:D}=await Promise.resolve().then(()=>(Si(),yi)),j=await D(u,m,h,f),K={..._,metadata:j?{...j,scrapedAt:new Date().toISOString(),timestamp:Date.now()}:void 0};await ve(y,K);let J=Date.now()-t;Te(l,!0,J);let Fr={..._,stream:await Promise.all((_.stream||[]).map(async Ar=>{let Ii=await pr(Ar.playlist,Ar.headers||{},e.ip,e.get("user-agent"));return{...Ar,playlist:`${e.protocol}://${e.get("host")}/s/${Ii}`,headers:{}}}))};return r.json(Fr)}let k=Date.now()-t;return Te(l,!1,k),r.status(404).json({error:"Stream not found"})}catch(o){console.error("Scraping Error:",o);let s=String(e.query.sourceId||"unknown"),n=Date.now()-t;return Te(s,!1,n),r.status(500).json({error:o.message||"Internal Server Error"})}});B.get("/s/:token",Ri,async(e,r)=>{try{let{token:t}=e.params,o=e.ip||"",s=e.get("user-agent")||"",n=await ur(t,o,s);if(!n)return r.status(404).send("Not found");let a=await fetch(n.url,{headers:n.headers});if(!a.ok)return r.status(a.status).send("Failed to fetch");let i=await a.text();console.log("[STREAM PROXY] Original playlist URL:",n.url),console.log("[STREAM PROXY] Original playlist length:",i.length);let c=/RESOLUTION=(\d+x\d+)/g,d=Array.from(i.matchAll(c)).map(m=>m[1]);d.length>0&&console.log("[STREAM PROXY] Available qualities:",d.join(", "));let l=`${e.protocol}://${e.get("host")}`,u=await mr(i,l,t,n.url,o,s);r.setHeader("Content-Type","application/vnd.apple.mpegurl"),r.setHeader("Access-Control-Allow-Origin","*"),r.send(u)}catch(t){console.error("[STREAM PROXY ERROR]",{message:t.message,stack:t.stack,token:e.params.token}),r.status(500).send(`Stream Proxy Error: ${t.message}`)}});B.get("/s/:token/chunk/:segmentToken",Ri,async(e,r)=>{try{let{token:t,segmentToken:o}=e.params,s=e.ip||"",n=e.get("user-agent")||"";if(nt.detectDownloadTool(n))return console.log(`[SECURITY] Download tool detected: ${n.substring(0,100)} from IP: ${s}`),r.status(403).send("Download tools are not permitted");let a=await nt.checkRateLimit(t,s);if(!a.allowed)return console.log(`[RATE LIMIT] Blocked ${s} - ${a.reason}`),r.status(429).send(a.reason||"Too many requests");let i=await ur(t,s,n);if(!i)return r.status(404).send("Not found");let{verifyEncryptedSegmentToken:c}=await Promise.resolve().then(()=>(it(),ma)),d=await c(o,t);if(!d)return r.status(404).send("Not found");let l=d.url,u=await fetch(l,{headers:i.headers});if(!u.ok)return r.status(u.status).send("Failed");let m=u.headers.get("content-type")||"";if(m.includes("mpegurl")||m.includes("m3u8")||l.includes(".m3u8")){let f=await u.text(),b=`${e.protocol}://${e.get("host")}`,y=await mr(f,b,t,l,s,n);r.setHeader("Content-Type","application/vnd.apple.mpegurl"),r.setHeader("Access-Control-Allow-Origin","*"),r.send(y)}else{let f=u.headers.get("content-length");r.setHeader("Content-Type",m||"video/mp2t"),r.setHeader("Access-Control-Allow-Origin","*"),r.setHeader("Cache-Control","public, max-age=31536000, immutable"),r.setHeader("Accept-Ranges","bytes"),f&&r.setHeader("Content-Length",f),u.body&&Ei.Readable.fromWeb(u.body).pipe(r)}}catch(t){console.error("Segment proxy error:",t),r.status(500).send("Error")}});B.listen(wi,()=>{console.log(`Server running on port ${wi}`)});
